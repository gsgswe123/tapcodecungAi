<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Code IDE v15.0 - Ultimate Full-Stack Development Environment</title>
    
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- CORE ENGINE -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- COMPILERS & RUNTIMES -->
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>
    <script src="https://unpkg.com/typescript@5.4.5/lib/typescript.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    
    <!-- FORMATTERS -->
    <script src="https://unpkg.com/prettier@3.2.5/standalone.js"></script>
    <script src="https://unpkg.com/prettier@3.2.5/plugins/html.js"></script>
    <script src="https://unpkg.com/prettier@3.2.5/plugins/babel.js"></script>
    <script src="https://unpkg.com/prettier@3.2.5/plugins/postcss.js"></script>
    <script src="https://unpkg.com/prettier@3.2.5/plugins/typescript.js"></script>
    
    <!-- TERMINAL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
    
    <!-- NOTIFICATIONS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- LOTTIE ANIMATIONS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

    <!-- PRISM.JS FOR SYNTAX HIGHLIGHTING -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <!-- MONACO EDITOR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"></script>

    <style>
        :root {
            --bg-dark: #09090b; --bg-panel: #18181b; --bg-side: #121215;
            --border: #27272a; --text: #e4e4e7; --text-dim: #71717a;
            --primary: #6366f1; --primary-hover: #4f46e5;
            --accent: #a855f7; --error: #ef4444; --success: #22c55e; --warn: #f59e0b;
            --header-h: 48px; --footer-h: 28px; --act-bar-w: 52px; --side-w: 280px;
            --editor-font-size: 14px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* CORE */
        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; }
        body { 
            margin:0; background:var(--bg-dark); color:var(--text); 
            font-family:'Inter', sans-serif; height:100vh; overflow:hidden; 
            display:flex; flex-direction:column; user-select: none;
            font-size: 14px; -webkit-font-smoothing: antialiased;
        }
        
        ::-webkit-scrollbar { width:10px; height:10px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-corner { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius:5px; border: 2px solid var(--bg-dark); }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* UTILITY CLASSES */
        .flex { display:flex; } .col { flex-direction:column; } .row { flex-direction:row; }
        .ac { align-items:center; } .jc { justify-content:center; } .jb { justify-content:space-between; }
        .hidden { display:none !important; } .visually-hidden { opacity:0; pointer-events:none; }
        .gap-2 { gap: 8px; } .gap-4 { gap: 16px; } .gap-6 { gap: 24px; }
        .p-2 { padding: 8px; } .p-4 { padding: 16px; } .p-6 { padding: 24px; }
        .m-2 { margin: 8px; } .m-4 { margin: 16px; }
        .rounded-sm { border-radius: 4px; } .rounded { border-radius: 8px; } .rounded-lg { border-radius: 12px; }
        .shadow-sm { box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .shadow { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .shadow-lg { box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .w-full { width: 100%; } .h-full { height: 100%; }
        .transition { transition: var(--transition); }
        
        /* HEADER */
        header { 
            height:var(--header-h); background:var(--bg-panel); border-bottom:1px solid var(--border);
            padding:0 16px; display:flex; align-items:center; gap: 12px; z-index: 50; flex-shrink: 0;
        }
        
        .logo { font-weight:800; font-size:15px; letter-spacing:-0.5px; display:flex; align-items:center; gap:8px; color: #fff; }
        .logo span { background:linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip:text; color:transparent; font-size:17px; }
        .logo .version { font-size:10px; background:linear-gradient(135deg, var(--primary), var(--accent)); color: white; padding:2px 6px; border-radius:12px; font-weight:600; }

        /* BUTTONS */
        .btn {
            background: transparent; color: #a1a1aa; border:1px solid transparent; padding:0 12px; border-radius:6px; 
            cursor:pointer; font-size:13px; display:flex; align-items:center; gap:6px; transition:var(--transition); height: 34px;
            font-family: 'Inter', sans-serif; font-weight:500; white-space: nowrap;
        }
        .btn:hover { background: rgba(255,255,255,0.08); color:white; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn.primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color:white; font-weight:600; border:none; }
        .btn.primary:hover { background: linear-gradient(135deg, var(--primary-hover), #9333ea); box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4); transform: translateY(-2px); }
        .btn.secondary { background: var(--bg-side); border:1px solid var(--border); }
        .btn.danger { background: var(--error); color:white; }
        .btn.success { background: var(--success); color:white; }
        .btn.small { height: 28px; padding: 0 10px; font-size: 12px; }
        .btn.large { height: 40px; padding: 0 20px; font-size: 14px; }
        .btn.icon { width:34px; padding:0; justify-content:center; }
        .btn:disabled { opacity:0.5; cursor:not-allowed; pointer-events:none; }
        
        .input {
            background: #27272a; border: 1px solid #3f3f46; border-radius:6px; padding: 10px 12px;
            color: white; font-size: 13px; font-family: 'Inter', sans-serif;
            transition: var(--transition); width:100%;
        }
        .input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); }
        .input::placeholder { color: #71717a; }
        
        /* WORKSPACE */
        #workspace { flex:1; display:flex; overflow:hidden; position:relative; }
        
        /* ACTIVITY BAR */
        .act-bar { width:var(--act-bar-w); background:linear-gradient(180deg, var(--bg-side), #0f0f11); border-right:1px solid var(--border); 
                  display:flex; flex-direction:column; align-items:center; padding-top:16px; z-index:10; flex-shrink: 0; gap:4px;}
        .act-btn { width:44px; height:44px; display:flex; align-items:center; justify-content:center; color:#52525b; font-size:20px; cursor:pointer; 
                   transition:var(--transition); position:relative; border-radius:10px; background:transparent;}
        .act-btn:hover { color:#a1a1aa; background: rgba(255,255,255,0.05); transform: scale(1.05); }
        .act-btn.active { color:#e4e4e7; background: rgba(255,255,255,0.08); }
        .act-btn.active::before { content:''; position:absolute; left:0; top:12px; bottom:12px; width:3px; background:var(--primary); border-radius:0 4px 4px 0; }
        .act-btn.badge::after { content: ''; position: absolute; top: 8px; right: 8px; width: 6px; height: 6px; background: var(--primary); border-radius: 50%; }
        .act-btn .tooltip { position:absolute; left:calc(100% + 10px); background:#27272a; color:white; padding:6px 10px; border-radius:6px; 
                            font-size:12px; white-space:nowrap; display:none; z-index:1000; border:1px solid var(--border); }
        .act-btn:hover .tooltip { display:block; }

        /* SIDEBARS */
        .sidebar { width:var(--side-w); background:var(--bg-side); border-right:1px solid var(--border); display:none; flex-direction:column; flex-shrink: 0; }
        .sidebar.active { display:flex; animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity:0.8; transform:translateX(-10px); } to { opacity:1; transform:translateX(0); } }
        .sb-head { height:40px; padding:0 16px; display:flex; align-items:center; justify-content:space-between; font-size:11px; font-weight:700; 
                   color:#a1a1aa; text-transform:uppercase; letter-spacing:0.5px; background: linear-gradient(180deg, #161619, #141417);}
        
        /* FILE TREE */
        .tree { flex:1; overflow-y:auto; padding:8px 0; }
        .t-item { padding:6px 0; cursor:pointer; color:#a1a1aa; font-size:13px; display:flex; align-items:center; transition:0.1s; user-select: none; position: relative; }
        .t-item:hover { background:#2a2a2d; color:#e4e4e7; }
        .t-item.active { background:#37373d !important; color:#fff; }
        .t-item.active::before { content:''; position:absolute; left:0; top:0; bottom:0; width:2px; background:var(--primary); }
        .t-indent { width:100%; display: flex; align-items: center; padding: 4px 0; }
        .t-sub { display: block; }
        .t-sub.hidden { display: none; }
        
        /* EDITOR TABS */
        .tabs { display:flex; background:var(--bg-panel); height:38px; overflow-x:auto; border-bottom:1px solid var(--border); scrollbar-width:none; flex-shrink: 0; 
                padding:0 4px; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab { display:flex; align-items:center; padding:0 16px; height:100%; border-right:1px solid #27272a; font-size:12px; color:#71717a; 
               cursor:pointer; background: #18181b; min-width:140px; max-width:220px; gap: 8px; border-top: 2px solid transparent; transition: var(--transition);
               position:relative; }
        .tab.active { background:var(--bg-dark); color:#e4e4e7; border-top-color:var(--primary); }
        .tab .close { width:18px; height:18px; display:flex; align-items:center; justify-content:center; border-radius:4px; opacity:0; transition:0.2s; font-size: 14px;}
        .tab:hover .close { opacity:0.8; }
        .tab .close:hover { background:#ef4444; color: white; opacity: 1;}
        .tab.dirty::after { content:'*'; position:absolute; right:6px; top:50%; transform:translateY(-50%); color:var(--primary); font-size:20px; }
        
        /* EDITOR AREA */
        #main { flex:1; display:flex; flex-direction:column; min-width:0; background:var(--bg-dark); position:relative; overflow: hidden; }
        #editor-container { flex:1; position:relative; display:flex; }
        .editor-pane { flex:1; position: relative; overflow: hidden; border-right:1px solid var(--border); }
        .editor-pane:last-child { border-right: none; }
        .pane-header { height:32px; background:var(--bg-panel); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 12px; 
                      font-size:11px; color:var(--text-dim); justify-content:space-between; }
        
        /* BOTTOM PANEL */
        #panel-btm { height:240px; border-top:1px solid var(--border); background:var(--bg-panel); display:flex; flex-direction:column; 
                     position:absolute; bottom:0; left:0; right:0; z-index: 20; box-shadow: 0 -4px 20px rgba(0,0,0,0.3); }
        .panel-tabs { display:flex; height:36px; background:var(--bg-panel); border-bottom:1px solid var(--border); padding:0 8px; gap:1px; }
        .panel-tab { padding:0 16px; height:100%; display:flex; align-items:center; cursor:pointer; border-bottom:2px solid transparent; 
                     color: #71717a; font-size: 11px; font-weight: 600; letter-spacing: 0.5px; transition: var(--transition); gap:6px; }
        .panel-tab:hover { color: #e4e4e7; background:rgba(255,255,255,0.03); }
        .panel-tab.active { color:#e4e4e7; border-bottom-color:var(--primary); background:rgba(255,255,255,0.05); }
        .panel-tab .badge { background:var(--primary); color:white; font-size:9px; padding:1px 4px; border-radius:10px; min-width:16px; text-align:center; }

        /* CONSOLE OUTPUT */
        .console-line { padding: 2px 0; white-space: pre-wrap; }
        .console-log { color: #e4e4e7; }
        .console-info { color: #60a5fa; }
        .console-warn { color: #fbbf24; }
        .console-error { color: #fb7185; }
        .console-success { color: #4ade80; }
        
        /* PREVIEW PANEL */
        #preview-wrap { width:0; background:white; display:flex; flex-direction:column; border-left:1px solid var(--border); transition: width 0.3s; position:relative; z-index: 15; flex-shrink: 0; }
        #preview-wrap.visible { width: 50%; min-width:400px; }
        .preview-toolbar { height:40px; background:#f4f4f5; border-bottom:1px solid #ddd; display:flex; align-items:center; padding:0 12px; gap:8px; }
        .preview-url { flex:1; background:white; border:1px solid #ddd; border-radius:6px; padding:6px 12px; font-size:12px; color:#444; font-family:'JetBrains Mono'; }
        
        /* RESIZERS */
        .resizer { position:absolute; z-index:99; background:transparent; transition: background 0.2s; }
        .resizer:hover, .resizer.dragging { background:var(--primary); transition-delay: 0.2s; }
        .r-w { width:6px; height:100%; cursor:col-resize; top:0; }
        .r-h { width:100%; height:6px; cursor:row-resize; top:0; left:0; }
        
        /* FOOTER */
        footer { height:var(--footer-h); background:var(--bg-panel); color:var(--text); display:flex; align-items:center; padding:0 16px; 
                font-size:11px; justify-content:space-between; flex-shrink: 0; z-index: 55; border-top: 1px solid var(--border); }
        .f-stat { display:flex; gap:16px; font-weight:500; align-items:center; }
        .f-stat span { cursor: pointer; opacity: 0.9; display:flex; align-items:center; gap:4px; } 
        .f-stat span:hover { opacity: 1; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); display: inline-block; }
        .status-dot.offline { background: var(--error); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity:1; } 50% { opacity:0.5; } }
        
        /* MODALS & OVERLAYS */
        .modal-overlay { position:fixed; inset:0; background: rgba(9,9,11,0.9); backdrop-filter:blur(4px); z-index:9998; display:none; align-items:center; justify-content:center; }
        .modal { background:var(--bg-panel); border-radius:16px; border:1px solid var(--border); min-width:500px; max-width:800px; max-height:85vh; 
                 display:flex; flex-direction:column; overflow:hidden; box-shadow:0 25px 50px rgba(0,0,0,0.5); animation: modalIn 0.3s ease-out; }
        @keyframes modalIn { from { opacity:0; transform:scale(0.95) translateY(10px); } to { opacity:1; transform:scale(1) translateY(0); } }
        .modal-header { padding:20px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .modal-body { padding:24px; overflow-y:auto; flex:1; }
        .modal-footer { padding:20px 24px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:12px; }
        
        /* LOADER */
        #loader-overlay { position:fixed; inset:0; background:linear-gradient(135deg, #09090b, #0a0a0f); z-index:10000; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .spinner { width: 48px; height: 48px; border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* AI ASSISTANT */
        #ai-float { position:absolute; right:24px; bottom:24px; width:460px; height:560px; background:var(--bg-panel); border:1px solid var(--border); 
                    z-index:100; border-radius:16px; display:none; flex-direction:column; box-shadow:0 25px 50px rgba(0,0,0,0.5); animation: floatIn 0.3s ease-out; }
        @keyframes floatIn { from { opacity:0; transform:translateY(20px) scale(0.95); } to { opacity:1; transform:translateY(0) scale(1); } }
        .ai-header { padding:16px 20px; border-bottom:1px solid var(--border); background:linear-gradient(135deg, #1f1f22, #18181b); border-radius:16px 16px 0 0; }
        .ai-messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:16px; }
        .msg-bubble { background: #27272a; padding:12px 16px; border-radius:12px; font-size:13px; max-width:85%; line-height:1.5; word-break:break-word; animation: bubbleIn 0.2s ease-out; }
        @keyframes bubbleIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        .msg-user { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; align-self: flex-end; margin-left:auto; }
        .msg-sys { color: #e4e4e7; border: 1px solid var(--border); margin-right:auto; }
        .code-block { background: #111; padding:12px; border-radius:8px; font-family:'JetBrains Mono', monospace; margin-top:8px; white-space:pre-wrap; 
                     font-size:12px; overflow-x:auto; border:1px solid #333; line-height:1.4; position:relative; }
        .code-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #333; }
        .code-lang { font-size:10px; color:#a1a1aa; text-transform:uppercase; font-weight:600; }
        .copy-btn { background:#27272a; border:none; color:#a1a1aa; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px; }
        .ai-typing { display:flex; gap:6px; padding:16px; justify-content:center; }
        .ai-typing span { width:10px; height:10px; background:var(--primary); border-radius:50%; animation:bounce 1.4s infinite ease-in-out; }
        .ai-typing span:nth-child(1) { animation-delay:-0.32s; }
        .ai-typing span:nth-child(2) { animation-delay:-0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform:scale(0); } 40% { transform:scale(1); } }
        
        /* CONTEXT MENU */
        .context-menu { position:fixed; background:#27272a; border:1px solid var(--border); border-radius:8px; padding:6px; z-index:9999; min-width:180px; 
                       box-shadow:0 10px 30px rgba(0,0,0,0.5); backdrop-filter:blur(10px); }
        .context-item { padding:10px 12px; font-size:12px; color:#e4e4e7; cursor:pointer; border-radius:6px; display:flex; align-items:center; gap:10px; }
        .context-item:hover { background:#3f3f46; }
        .context-item.disabled { color:#71717a; cursor:not-allowed; }
        .context-divider { height:1px; background:#3f3f46; margin:6px 0; }
        
        /* TOOLTIPS */
        .tooltip { position:absolute; background:#27272a; color:white; padding:6px 10px; border-radius:6px; font-size:11px; white-space:nowrap; 
                   z-index:10000; border:1px solid var(--border); pointer-events:none; opacity:0; transition:opacity 0.2s; }
        .tooltip.show { opacity:1; }
        
        /* NOTIFICATIONS */
        .notification { position:fixed; bottom:20px; right:20px; background:#27272a; border:1px solid var(--border); border-radius:8px; padding:12px 16px; 
                       max-width:400px; z-index:999; animation:slideInRight 0.3s ease-out; }
        @keyframes slideInRight { from { transform:translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }
        
        /* EMPTY STATE */
        #empty-state { position:absolute; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center; background:var(--bg-dark); z-index:5; }
        .empty-icon { font-size:72px; color:#27272a; margin-bottom:24px; opacity:0.5; }
        .empty-title { font-size:18px; font-weight:600; color:#52525b; margin-bottom:8px; }
        .empty-subtitle { font-size:13px; color:#71717a; text-align:center; max-width:400px; line-height:1.5; }
        
        /* STATUS BAR ITEMS */
        .status-item { display:flex; align-items:center; gap:6px; padding:4px 8px; border-radius:4px; transition:var(--transition); }
        .status-item:hover { background:rgba(255,255,255,0.05); }
        
        /* COMMAND PALETTE */
        #command-palette { position:fixed; top:20%; left:50%; transform:translateX(-50%); width:600px; background:var(--bg-panel); border:1px solid var(--border); 
                          border-radius:12px; z-index:9997; display:none; overflow:hidden; box-shadow:0 25px 50px rgba(0,0,0,0.5); }
        .command-input { padding:20px; border-bottom:1px solid var(--border); }
        .command-list { max-height:400px; overflow-y:auto; }
        .command-item { padding:12px 20px; cursor:pointer; display:flex; align-items:center; gap:12px; transition:var(--transition); }
        .command-item:hover, .command-item.selected { background:#27272a; }
        .command-icon { width:20px; color:#a1a1aa; text-align:center; }
        .command-text { flex:1; font-size:13px; }
        .command-shortcut { font-size:11px; color:#71717a; font-family:'JetBrains Mono'; }
        
        /* DASHBOARD */
        .dashboard { display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:20px; padding:20px; }
        .dashboard-card { background:var(--bg-panel); border:1px solid var(--border); border-radius:12px; padding:20px; }
        .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .card-title { font-size:14px; font-weight:600; color:var(--text); }
        
        /* PROGRESS BARS */
        .progress-bar { height:6px; background:#27272a; border-radius:3px; overflow:hidden; }
        .progress-fill { height:100%; background:linear-gradient(90deg, var(--primary), var(--accent)); border-radius:3px; transition:width 0.3s; }
        
        /* TOGGLE SWITCH */
        .switch { position:relative; display:inline-block; width:44px; height:24px; }
        .switch input { opacity:0; width:0; height:0; }
        .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#3f3f46; transition:.4s; border-radius:24px; }
        .slider:before { position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:white; transition:.4s; border-radius:50%; }
        input:checked + .slider { background:var(--primary); }
        input:checked + .slider:before { transform:translateX(20px); }
        
        /* COLLAPSIBLE */
        .collapsible-header { padding:12px 16px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
        .collapsible-content { padding:0 16px 16px; display:none; }
        .collapsible.open .collapsible-content { display:block; }
        
        /* BADGES */
        .badge { display:inline-flex; align-items:center; justify-content:center; padding:2px 8px; border-radius:12px; font-size:10px; font-weight:600; }
        .badge.primary { background:var(--primary); color:white; }
        .badge.secondary { background:#3f3f46; color:#a1a1aa; }
        .badge.success { background:var(--success); color:white; }
        .badge.error { background:var(--error); color:white; }
        
        /* GRADIENTS */
        .gradient-primary { background:linear-gradient(135deg, var(--primary), var(--accent)); }
        .gradient-dark { background:linear-gradient(135deg, #09090b, #1a1a1f); }
        
        /* CUSTOM SCROLLBAR FOR MONACO */
        .monaco-scrollable-element > .scrollbar > .slider { background: #3f3f46 !important; }
    </style>
</head>
<body>

<!-- BOOT SCREEN -->
<div id="loader-overlay">
    <div class="logo" style="margin-bottom:24px; font-size: 28px;"><i class="fas fa-code"></i> PRO CODE <span>IDE</span> <span class="version">v15.0</span></div>
    <div class="spinner"></div>
    <div id="boot-status" style="margin-top:20px; font-family:'JetBrains Mono'; font-size:13px; color:#71717a">Initializing Pro Code IDE v15.0...</div>
    <div id="boot-progress" style="width:300px; height:4px; background:#27272a; border-radius:2px; margin-top:20px; overflow:hidden;">
        <div id="boot-progress-fill" style="width:0%; height:100%; background:linear-gradient(90deg, var(--primary), var(--accent)); transition:width 0.5s;"></div>
    </div>
</div>

<!-- COMMAND PALETTE -->
<div id="command-palette" class="hidden">
    <div class="command-input">
        <input type="text" class="input" placeholder="Type a command or search..." id="command-input" autocomplete="off">
    </div>
    <div class="command-list" id="command-list"></div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="modal-overlay">
    <div class="modal" style="width:700px;">
        <div class="modal-header">
            <h3 style="font-weight:600; font-size:16px;"><i class="fas fa-cog"></i> IDE Settings</h3>
            <button class="btn icon small" onclick="Settings.hide()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="tabs" style="height:auto; border-bottom:1px solid var(--border); margin-bottom:20px;">
                <div class="tab active" data-tab="editor">Editor</div>
                <div class="tab" data-tab="appearance">Appearance</div>
                <div class="tab" data-tab="features">Features</div>
                <div class="tab" data-tab="terminal">Terminal</div>
                <div class="tab" data-tab="ai">AI Assistant</div>
            </div>
            
            <div id="settings-editor" class="settings-tab">
                <div class="setting-row">
                    <div>
                        <div style="font-weight:500;">Font Size</div>
                        <div style="font-size:12px; color:var(--text-dim);">Size of text in editor</div>
                    </div>
                    <div class="flex ac gap-2">
                        <button class="btn icon small" onclick="Settings.changeFontSize(-1)"><i class="fas fa-minus"></i></button>
                        <input type="number" id="font-size-input" class="input" style="width:80px; text-align:center;" min="8" max="32" value="14">
                        <button class="btn icon small" onclick="Settings.changeFontSize(1)"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div>
                        <div style="font-weight:500;">Tab Size</div>
                        <div style="font-size:12px; color:var(--text-dim);">Number of spaces for a tab</div>
                    </div>
                    <div class="flex ac gap-2">
                        <button class="btn small" onclick="Settings.changeTabSize(-1)">-</button>
                        <span id="tab-size-value" style="min-width:30px; text-align:center;">4</span>
                        <button class="btn small" onclick="Settings.changeTabSize(1)">+</button>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div>
                        <div style="font-weight:500;">Word Wrap</div>
                        <div style="font-size:12px; color:var(--text-dim);">Wrap long lines</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="word-wrap-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <div>
                        <div style="font-weight:500;">Minimap</div>
                        <div style="font-size:12px; color:var(--text-dim);">Show minimap in editor</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="minimap-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div id="settings-appearance" class="settings-tab hidden">
                <div class="setting-row">
                    <div>
                        <div style="font-weight:500;">Theme</div>
                        <div style="font-size:12px; color:var(--text-dim);">Color theme of the IDE</div>
                    </div>
                    <div class="flex gap-3">
                        <div class="theme-option active" data-theme="dark">
                            <div style="width:60px; height:40px; background:#09090b; border-radius:6px;"></div>
                            <div style="font-size:11px; text-align:center; margin-top:4px;">Dark</div>
                        </div>
                        <div class="theme-option" data-theme="light">
                            <div style="width:60px; height:40px; background:#ffffff; border-radius:6px; border:1px solid #ddd;"></div>
                            <div style="font-size:11px; text-align:center; margin-top:4px;">Light</div>
                        </div>
                        <div class="theme-option" data-theme="night">
                            <div style="width:60px; height:40px; background:#0a0a12; border-radius:6px;"></div>
                            <div style="font-size:11px; text-align:center; margin-top:4px;">Night</div>
                        </div>
                    </div>
                </div>
                
                <div class="setting-row">
                    <div>
                        <div style="font-weight:500;">Animation</div>
                        <div style="font-size:12px; color:var(--text-dim);">Enable UI animations</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="animation-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="Settings.hide()">Cancel</button>
            <button class="btn primary" onclick="Settings.save()"><i class="fas fa-save"></i> Save Settings</button>
        </div>
    </div>
</div>

<!-- PROJECT TEMPLATES MODAL -->
<div id="templates-modal" class="modal-overlay">
    <div class="modal" style="width:800px;">
        <div class="modal-header">
            <h3 style="font-weight:600; font-size:16px;"><i class="fas fa-layer-group"></i> New Project</h3>
            <button class="btn icon small" onclick="ProjectTemplates.hide()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:16px;">
                <div class="template-card" data-template="vanilla">
                    <div style="background:linear-gradient(135deg, #667eea, #764ba2); height:120px; border-radius:8px 8px 0 0;"></div>
                    <div style="padding:16px;">
                        <div style="font-weight:600; margin-bottom:4px;">Vanilla Web</div>
                        <div style="font-size:12px; color:var(--text-dim); line-height:1.4;">HTML, CSS, JavaScript starter</div>
                    </div>
                </div>
                
                <div class="template-card" data-template="react-ts">
                    <div style="background:linear-gradient(135deg, #61dafb, #3178c6); height:120px; border-radius:8px 8px 0 0;"></div>
                    <div style="padding:16px;">
                        <div style="font-weight:600; margin-bottom:4px;">React + TypeScript</div>
                        <div style="font-size:12px; color:var(--text-dim); line-height:1.4;">Modern React with TypeScript</div>
                    </div>
                </div>
                
                <div class="template-card" data-template="react-umd">
                    <div style="background:linear-gradient(135deg, #38bdf8, #0ea5e9); height:120px; border-radius:8px 8px 0 0;"></div>
                    <div style="padding:16px;">
                        <div style="font-weight:600; margin-bottom:4px;">React UMD (No Bundler)</div>
                        <div style="font-size:12px; color:var(--text-dim); line-height:1.4;">UMD globals with inline app.js</div>
                    </div>
                </div>
                
                <div class="template-card" data-template="vue-umd">
                    <div style="background:linear-gradient(135deg, #34d399, #10b981); height:120px; border-radius:8px 8px 0 0;"></div>
                    <div style="padding:16px;">
                        <div style="font-weight:600; margin-bottom:4px;">Vue 3 UMD (No Bundler)</div>
                        <div style="font-size:12px; color:var(--text-dim); line-height:1.4;">Vue global build + inline app</div>
                    </div>
                </div>
                
                <div class="template-card" data-template="python-data">
                    <div style="background:linear-gradient(135deg, #3776ab, #ffd43b); height:120px; border-radius:8px 8px 0 0;"></div>
                    <div style="padding:16px;">
                        <div style="font-weight:600; margin-bottom:4px;">Python Data Science</div>
                        <div style="font-size:12px; color:var(--text-dim); line-height:1.4;">Data analysis with Python</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="ProjectTemplates.hide()">Cancel</button>
            <button class="btn primary" onclick="ProjectTemplates.create()"><i class="fas fa-plus"></i> Create Project</button>
        </div>
    </div>
</div>

<header>
    <div class="logo">
        <i class="fas fa-cube" style="color:var(--primary)"></i> 
        <span>PRO CODE</span>
        <span class="version">v15.0</span>
    </div>
    
    <div style="width:1px; height:20px; background:#333; margin:0 12px;"></div>
    
    <!-- LEFT CONTROLS -->
    <div class="flex ac gap-2">
        <button class="btn icon" onclick="FS.createFilePrompt()" title="New File (Ctrl+N)">
            <i class="fas fa-file-plus"></i>
        </button>
        <button class="btn icon" onclick="FS.createFolderPrompt()" title="New Folder">
            <i class="fas fa-folder-plus"></i>
        </button>
        <button class="btn icon" onclick="FS.save()" title="Save (Ctrl+S)">
            <i class="fas fa-save"></i>
        </button>
        
        <div style="width:1px; height:20px; background:#333; margin:0 8px;"></div>
        
        <button class="btn icon" onclick="FS.importPrompt()" title="Import Files">
            <i class="fas fa-folder-open"></i>
        </button>
        <button class="btn icon" onclick="FS.exportZip()" title="Export Project">
            <i class="fas fa-download"></i>
        </button>
    </div>
    
    <div style="flex:1"></div>
    
    <!-- CENTER CONTROLS -->
    <div class="flex ac gap-3" style="background:#27272a; border-radius:8px; padding:4px; border:1px solid #3f3f46;">
        <button class="btn icon small" onclick="CommandPalette.show()" title="Command Palette (Ctrl+P)">
            <i class="fas fa-search"></i>
        </button>
        <input id="spotlight" class="input" placeholder="Search files, commands..." style="border:none; background:transparent; width:300px;">
        <div class="flex ac gap-1">
            <button class="btn icon small" onclick="Search.findInProject()" title="Find in Files">
                <i class="fas fa-search-plus"></i>
            </button>
            <button class="btn icon small" onclick="Search.replace()" title="Replace">
                <i class="fas fa-exchange-alt"></i>
            </button>
        </div>
    </div>
    
    <div style="flex:1"></div>
    
    <!-- RIGHT CONTROLS -->
    <div class="flex ac gap-2">
        <button class="btn icon" onclick="Layout.toggleLayout('terminal')" title="Terminal (Ctrl+`)">
            <i class="fas fa-terminal"></i>
        </button>
        <button class="btn icon" onclick="Layout.toggleLayout('preview')" title="Preview (Ctrl+B)">
            <i class="fas fa-columns"></i>
        </button>
        <button class="btn icon" onclick="Layout.splitEditor()" title="Split Editor (Ctrl+\)">
            <i class="fas fa-columns"></i>
        </button>
        
        <div style="width:1px; height:20px; background:#333; margin:0 8px;"></div>
        
        <button class="btn primary" id="run-btn" onclick="Runner.exec()" title="Run (F5)">
            <i class="fas fa-play"></i> RUN
        </button>
        <button class="btn icon" onclick="Debugger.toggle()" title="Debug (F9)">
            <i class="fas fa-bug"></i>
        </button>
    </div>
</header>

<div id="workspace">
    <!-- ACTIVITY BAR -->
    <div class="act-bar">
        <div class="act-btn active" data-id="expl" onclick="Layout.setSide('expl')" title="Explorer">
            <i class="far fa-copy"></i>
            <div class="tooltip">Explorer</div>
        </div>
        <div class="act-btn" data-id="search" onclick="Layout.setSide('search')" title="Search">
            <i class="fas fa-search"></i>
            <div class="tooltip">Search</div>
        </div>
        <div class="act-btn" data-id="git" onclick="Layout.setSide('git')" title="Git">
            <i class="fas fa-code-branch"></i>
            <div class="tooltip">Git</div>
        </div>
        <div class="act-btn" data-id="ext" onclick="Layout.setSide('ext')" title="Extensions">
            <i class="fas fa-cubes"></i>
            <div class="tooltip">Extensions</div>
        </div>
        <div class="act-btn" data-id="debug" onclick="Layout.setSide('debug')" title="Debug">
            <i class="fas fa-bug"></i>
            <div class="tooltip">Debug</div>
        </div>
        
        <div style="flex:1"></div>
        
        <div class="act-btn" onclick="Settings.show()" title="Settings">
            <i class="fas fa-cog"></i>
            <div class="tooltip">Settings</div>
        </div>
        <div class="act-btn" onclick="AI.toggle()" style="color: var(--accent)" title="AI Assistant">
            <i class="fas fa-robot"></i>
            <div class="tooltip">AI Assistant</div>
        </div>
    </div>

    <!-- EXPLORER SIDEBAR -->
    <div id="side-expl" class="sidebar active">
        <div class="sb-head">
            <span>Explorer</span>
            <div class="flex gap-2">
                <i class="fas fa-file-medical" onclick="FS.createFilePrompt()" title="New File" style="cursor:pointer"></i>
                <i class="fas fa-folder-plus" onclick="FS.createFolderPrompt()" title="New Folder" style="cursor:pointer"></i>
                <i class="fas fa-sync-alt" onclick="FS.refreshTree()" title="Refresh" style="cursor:pointer"></i>
            </div>
        </div>
        <div id="file-tree" class="tree"></div>
        <div class="sb-head" style="margin-top:8px;">
            <span>Outline</span>
        </div>
        <div id="outline-tree" class="tree" style="height:200px;"></div>
    </div>
    
    <!-- SEARCH SIDEBAR -->
    <div id="side-search" class="sidebar">
        <div class="sb-head"><span>Search</span></div>
        <div style="padding:16px;">
            <div class="flex col gap-3">
                <input type="text" class="input" placeholder="Search in files..." id="search-input">
                <div class="flex gap-2">
                    <input type="text" class="input" placeholder="Replace with..." id="replace-input">
                    <button class="btn small" onclick="Search.replaceAll()">Replace All</button>
                </div>
                <div class="flex ac jb">
                    <label style="font-size:12px;">
                        <input type="checkbox" id="case-sensitive"> Case sensitive
                    </label>
                    <label style="font-size:12px;">
                        <input type="checkbox" id="whole-word"> Whole word
                    </label>
                </div>
                <button class="btn primary" onclick="Search.execute()"><i class="fas fa-search"></i> Search</button>
            </div>
            <div id="search-results" style="margin-top:16px; max-height:400px; overflow-y:auto;"></div>
        </div>
    </div>
    
    <!-- GIT SIDEBAR -->
    <div id="side-git" class="sidebar">
        <div class="sb-head"><span>Source Control</span></div>
        <div style="padding:16px;">
            <div class="flex col gap-3">
                <div style="font-size:12px; color:var(--text-dim);">Branch: <span style="color:var(--primary); font-weight:600;">main</span></div>
                <div id="git-status" style="font-size:12px; color:var(--success);">
                    <i class="fas fa-check-circle"></i> No changes
                </div>
                <button class="btn small" onclick="Git.commit()"><i class="fas fa-code-commit"></i> Commit Changes</button>
                <button class="btn small secondary" onclick="Git.push()"><i class="fas fa-cloud-upload-alt"></i> Push to Remote</button>
            </div>
        </div>
    </div>

    <!-- RESIZER -->
    <div class="resizer r-w" id="rs-side" style="right:0"></div>

    <!-- MAIN EDITOR AREA -->
    <div id="main">
        <div class="tabs" id="tab-list"></div>
        
        <!-- EDITOR CONTAINER -->
        <div id="editor-container">
            <div id="editor-pane-1" class="editor-pane">
                <div id="monaco-root-1" style="width:100%; height:100%;"></div>
            </div>
        </div>
        
        <!-- EMPTY STATE -->
        <div id="empty-state">
            <div class="empty-icon">
                <i class="fas fa-code-branch"></i>
            </div>
            <div class="empty-title">Welcome to Pro Code IDE</div>
            <div class="empty-subtitle">Open a file or create a new project to start coding</div>
            <div class="flex gap-3" style="margin-top:32px;">
                <button class="btn primary" onclick="ProjectTemplates.show()">
                    <i class="fas fa-layer-group"></i> New Project
                </button>
                <button class="btn secondary" onclick="FS.importPrompt()">
                    <i class="fas fa-folder-open"></i> Open Folder
                </button>
                <button class="btn secondary" onclick="Tutorial.start()">
                    <i class="fas fa-graduation-cap"></i> Take Tutorial
                </button>
            </div>
            <div style="margin-top:48px; display:grid; grid-template-columns:repeat(3, 1fr); gap:24px; max-width:600px;">
                <div style="text-align:center;">
                    <div style="font-size:12px; color:var(--text-dim); margin-bottom:4px;">Multi-Language</div>
                    <div style="font-size:11px; color:#71717a;">JavaScript, TypeScript, Python, HTML, CSS</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:12px; color:var(--text-dim); margin-bottom:4px;">Live Preview</div>
                    <div style="font-size:11px; color:#71717a;">Real-time web preview with hot reload</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:12px; color:var(--text-dim); margin-bottom:4px;">AI Assistant</div>
                    <div style="font-size:11px; color:#71717a;">Smart code completion and debugging</div>
                </div>
            </div>
        </div>

        <!-- BOTTOM PANEL -->
        <div id="panel-btm" class="hidden">
            <div class="resizer r-h" id="rs-panel"></div>
            <div class="panel-tabs">
                <div class="panel-tab active" data-panel="term" onclick="Panel.show('term')">
                    <i class="fas fa-terminal"></i> TERMINAL
                    <span class="badge" id="term-badge">1</span>
                </div>
                <div class="panel-tab" data-panel="console" onclick="Panel.show('console')">
                    <i class="fas fa-code"></i> CONSOLE
                    <span class="badge" id="console-badge">0</span>
                </div>
                <div class="panel-tab" data-panel="problems" onclick="Panel.show('problems')">
                    <i class="fas fa-exclamation-triangle"></i> PROBLEMS
                    <span class="badge" id="problems-badge">0</span>
                </div>
                <div class="panel-tab" data-panel="output" onclick="Panel.show('output')">
                    <i class="fas fa-stream"></i> OUTPUT
                </div>
                <div style="flex:1"></div>
                <div class="panel-tab" onclick="Terminal.clear()" title="Clear">
                    <i class="fas fa-trash"></i>
                </div>
                <div class="panel-tab" onclick="Layout.toggleLayout('terminal')" title="Close Panel">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div id="panel-body" style="flex:1; background:#09090b; position:relative; overflow:hidden;">
                <div id="term-host" style="width:100%; height:100%; padding:4px;"></div>
                <div id="console-host" class="hidden" style="width:100%; height:100%; padding:12px; overflow:auto; font-family:'JetBrains Mono'; font-size:12px;"></div>
                <div id="problems-host" class="hidden" style="width:100%; height:100%; padding:12px; overflow:auto;"></div>
                <div id="output-host" class="hidden" style="width:100%; height:100%; padding:12px; overflow:auto; font-family:'JetBrains Mono'; font-size:12px;">
                    <div id="output-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- PREVIEW PANEL -->
    <div class="resizer r-w hidden" id="rs-preview" style="left:0;"></div>
    <div id="preview-wrap">
        <div class="preview-toolbar">
            <div class="flex ac gap-2">
                <i class="fas fa-globe" style="color:#666;"></i>
                <input type="text" class="preview-url" value="http://localhost:3000" id="preview-url">
            </div>
            <div class="flex ac gap-2">
                <button class="btn icon small" onclick="Runner.popout()" title="Open in new window">
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <button class="btn icon small" onclick="Runner.reload()" title="Reload">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="btn icon small" onclick="Runner.toggleMobile()" title="Toggle mobile view">
                    <i class="fas fa-mobile-alt"></i>
                </button>
                <button class="btn icon small" onclick="Inspector.toggle()" title="Toggle inspector">
                    <i class="fas fa-code"></i>
                </button>
            </div>
        </div>
        <iframe id="preview-frame" style="flex:1; border:none; background:white;" sandbox="allow-scripts"></iframe>
    </div>
</div>

<footer>
    <div class="f-stat">
        <span onclick="Git.branch()" title="Current branch">
            <i class="fas fa-code-branch"></i> main
        </span>
        <span onclick="Git.status()" title="Git status">
            <i class="fas fa-cloud"></i> <span id="git-status-text">Local clean</span>
        </span>
    </div>
    
    <div class="f-stat">
        <span id="error-count" style="color:var(--error)" title="Errors">
            <i class="fas fa-times-circle"></i> 0
        </span>
        <span id="warning-count" style="color:var(--warn)" title="Warnings">
            <i class="fas fa-exclamation-triangle"></i> 0
        </span>
        <span id="info-count" style="color:var(--primary)" title="Info">
            <i class="fas fa-info-circle"></i> 0
        </span>
    </div>
    
    <div style="flex:1"></div>
    
    <div class="f-stat">
        <span id="cursor-pos" title="Cursor position">Ln 1, Col 1</span>
        <span id="file-lang" title="File language">Plain Text</span>
        <span id="file-enc" title="File encoding">UTF-8</span>
        <span id="file-size" title="File size">0 B</span>
        <span id="line-endings" title="Line endings">LF</span>
    </div>
    
    <div id="status-indicator" class="status-dot" style="margin:0 16px;" title="IDE Status"></div>
    
    <div class="f-stat">
        <span onclick="Settings.show()" title="Settings">
            <i class="fas fa-cog"></i>
        </span>
        <span onclick="AI.toggle()" title="AI Assistant">
            <i class="fas fa-robot"></i>
        </span>
        <span onclick="Notifications.toggle()" title="Notifications">
            <i class="fas fa-bell"></i>
        </span>
    </div>
</footer>

<!-- AI ASSISTANT -->
<div id="ai-float" class="col">
    <div class="ai-header">
        <div class="flex ac jb">
            <div class="flex ac gap-2">
                <i class="fas fa-robot" style="color:var(--accent);"></i>
                <span style="font-weight:600; font-size:14px;">AI Coding Assistant</span>
                <span class="badge primary">PRO</span>
            </div>
            <div class="flex ac gap-2">
                <button class="btn icon small" onclick="AI.clear()" title="Clear chat">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="btn icon small" onclick="AI.toggle()" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="ai-messages" id="ai-messages">
        <div class="msg-bubble msg-sys">
            <div style="font-weight:600; margin-bottom:8px;"> Hello! I'm your AI coding assistant.</div>
            <div style="margin-bottom:8px;">I can help you with:</div>
            <ul style="margin-left:20px; margin-bottom:8px;">
                <li>Writing and explaining code</li>
                <li>Debugging and fixing errors</li>
                <li>Generating components and functions</li>
                <li>Optimizing and refactoring</li>
                <li>Answering programming questions</li>
            </ul>
            <div>What would you like to work on?</div>
        </div>
    </div>
    
    <div id="ai-typing" class="ai-typing hidden">
        <span></span><span></span><span></span>
    </div>
    
    <div style="padding:16px; border-top:1px solid var(--border); background:linear-gradient(180deg, #1a1a1f, #18181b);">
        <div class="flex gap-2">
            <input type="text" id="ai-input" class="input" placeholder="Ask me anything about your code..." 
                   onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); AI.send(); }">
            <button class="btn primary" onclick="AI.send()" id="ai-send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="flex ac jb" style="margin-top:12px;">
            <div style="font-size:11px; color:#71717a;">
                <i class="fas fa-lightbulb"></i> Try: "Fix this bug", "Create a React component", "Explain this code"
            </div>
            <div style="font-size:10px; color:#71717a;">
                AI Assistant v2.0  Local Mode
            </div>
        </div>
    </div>
</div>

<script>
/**
 * PRO CODE IDE v15.0 - ULTIMATE EDITION
 * Full-stack web development environment
 * Enhanced with: Multi-language support, Advanced debugging, AI-powered features
 */

// ============================================
// GLOBAL STATE & CONFIGURATION
// ============================================
const IDE = {
    version: '15.0',
    build: '2024.03',
    state: {
        // File system
        files: {},
        tabs: [],
        activeTab: null,
        dirtyTabs: new Set(),
        
        // Editor
        editors: {},
        activeEditor: 'monaco-root-1',
        splitView: false,
        editorLayout: 'single',
        
        // Runtime
        pyodide: null,
        terminal: null,
        aiAssistant: null,
        
        // UI State
        sidebar: 'expl',
        panel: 'term',
        previewVisible: false,
        terminalVisible: false,
        
        // Project
        currentProject: null,
        projectType: 'vanilla',
        
        // Settings
        settings: {
            editor: {
                fontSize: 14,
                tabSize: 4,
                wordWrap: false,
                minimap: true,
                lineNumbers: true,
                fontFamily: "'JetBrains Mono', monospace",
                theme: 'procode-dark',
                formatOnSave: true,
                autoSave: true,
                autoSaveDelay: 1000,
                bracketPairColorization: true,
                autoCloseBrackets: true,
                autoIndent: true,
                suggestOnTriggerCharacters: true
            },
            appearance: {
                theme: 'dark',
                animation: true,
                reduceMotion: false,
                compactMode: false
            },
            terminal: {
                fontSize: 13,
                fontFamily: "'JetBrains Mono', monospace",
                cursorBlink: true,
                cursorStyle: 'block'
            },
            ai: {
                enabled: true,
                model: 'local',
                temperature: 0.7,
                maxTokens: 1000
            },
            features: {
                gitIntegration: true,
                livePreview: true,
                codeLens: true,
                breadcrumbs: true,
                snippetSuggestions: true
            }
        },
        
        // Templates (Enhanced with more options)
        templates: {
            'vanilla': {
                'index.html': `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProCode App</title>
    <link rel="stylesheet" href="style.css">
    <script src="app.js" defer><\/script>
</head>
<body>
    <div class="app">
        <header>
            <h1> Welcome to ProCode IDE v15.0</h1>
            <p>Start building amazing web applications</p>
        </header>
        
        <main>
            <section class="features">
                <div class="feature">
                    <h3> Fast Development</h3>
                    <p>Real-time preview and instant feedback</p>
                </div>
                <div class="feature">
                    <h3> Modern Design</h3>
                    <p>Built with latest web technologies</p>
                </div>
                <div class="feature">
                    <h3> AI Powered</h3>
                    <p>Smart code completion and assistance</p>
                </div>
            </section>
            
            <section class="demo">
                <h2>Interactive Demo</h2>
                <div class="counter">
                    <button id="decrement">-</button>
                    <span id="count">0</span>
                    <button id="increment">+</button>
                </div>
                <button id="theme-toggle">Toggle Theme</button>
            </section>
        </main>
        
        <footer>
            <p>Built with  using ProCode IDE v15.0</p>
        </footer>
    </div>
</body>
</html>`,
                'style.css': `/* Modern CSS Reset */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --bg: #f8fafc;
    --text: #1e293b;
    --card: #ffffff;
    --border: #e2e8f0;
    --radius: 12px;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.dark {
    --bg: #0f172a;
    --text: #e2e8f0;
    --card: #1e293b;
    --border: #334155;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    transition: background 0.3s, color 0.3s;
    min-height: 100vh;
}

.app {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

header {
    text-align: center;
    padding: 4rem 2rem;
    background: linear-gradient(135deg, var(--primary), #8b5cf6);
    color: white;
    border-radius: var(--radius);
    margin-bottom: 3rem;
}

header h1 {
    font-size: 3.5rem;
    margin-bottom: 1rem;
    font-weight: 800;
}

header p {
    font-size: 1.25rem;
    opacity: 0.9;
}

.features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.feature {
    background: var(--card);
    padding: 2rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    transition: transform 0.3s;
}

.feature:hover {
    transform: translateY(-5px);
}

.feature h3 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: var(--primary);
}

.demo {
    background: var(--card);
    padding: 3rem;
    border-radius: var(--radius);
    text-align: center;
    border: 1px solid var(--border);
    margin-bottom: 3rem;
}

.counter {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    margin: 2rem 0;
    font-size: 2rem;
}

.counter button, #theme-toggle {
    background: var(--primary);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: var(--radius);
    font-size: 1.25rem;
    cursor: pointer;
    transition: background 0.3s;
}

.counter button:hover, #theme-toggle:hover {
    background: var(--primary-dark);
}

footer {
    text-align: center;
    padding: 2rem;
    color: var(--text);
    opacity: 0.7;
}

@media (max-width: 768px) {
    .app {
        padding: 1rem;
    }
    
    header h1 {
        font-size: 2.5rem;
    }
    
    .features {
        grid-template-columns: 1fr;
    }
}`,
                'app.js': `// Main Application Logic
console.log(' App initialized - ProCode IDE v15.0');

// DOM Elements
const countElement = document.getElementById('count');
const incrementBtn = document.getElementById('increment');
const decrementBtn = document.getElementById('decrement');
const themeToggle = document.getElementById('theme-toggle');

// State
let count = 0;
let isDark = false;

// Update counter display
function updateCounter() {
    countElement.textContent = count;
    countElement.style.transform = 'scale(1.2)';
    setTimeout(() => {
        countElement.style.transform = 'scale(1)';
    }, 200);
}

// Increment counter
incrementBtn.addEventListener('click', () => {
    count++;
    updateCounter();
    
    // Visual feedback
    incrementBtn.style.animation = 'none';
    setTimeout(() => {
        incrementBtn.style.animation = 'pulse 0.3s';
    }, 10);
});

// Decrement counter
decrementBtn.addEventListener('click', () => {
    if (count > 0) {
        count--;
        updateCounter();
    }
});

// Toggle theme
themeToggle.addEventListener('click', () => {
    isDark = !isDark;
    document.body.classList.toggle('dark', isDark);
    themeToggle.textContent = isDark ? ' Light Mode' : ' Dark Mode';
    
    // Save preference
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
});

// Load saved theme
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark') {
    isDark = true;
    document.body.classList.add('dark');
    themeToggle.textContent = ' Light Mode';
}

// Add animation
const style = document.createElement('style');
style.textContent = \`
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.feature {
    animation: fadeIn 0.6s ease-out;
}

.feature:nth-child(2) {
    animation-delay: 0.2s;
}

.feature:nth-child(3) {
    animation-delay: 0.4s;
}
\`;
document.head.appendChild(style);

// Initialize
updateCounter();
console.log(' App ready!');`,
                'README.md': `# ProCode IDE Project

Welcome to your new ProCode IDE project!

## Project Structure
\`\`\`
project/
 index.html      # Main HTML file
 style.css       # Stylesheet
 app.js          # JavaScript logic
 README.md       # Project documentation
\`\`\`

## Features
-  Modern web development setup
-  Responsive design with CSS variables
-  Interactive JavaScript components
-  Dark/light theme toggle
-  Mobile-friendly layout

## Getting Started
1. Edit \`index.html\` to change the page structure
2. Modify \`style.css\` for custom styling
3. Update \`app.js\` for interactive features
4. Press **F5** to run the application

## Tips
- Use **Ctrl+S** to save files
- Press **Ctrl+B** to toggle preview
- Use **Ctrl+\\** to split editor
- Ask the AI Assistant for help with \`Ctrl+Shift+A\`

                Happy coding! `
            },
            
            'react-umd': {
                'index.html': `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React UMD Starter</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
    <script src="app.js"><\/script>
</body>
</html>`,
                'style.css': `:root {
    --bg: #0f172a;
    --card: #1e293b;
    --text: #e2e8f0;
    --accent: #38bdf8;
    --accent-dark: #0ea5e9;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
}

.app {
    background: var(--card);
    padding: 32px;
    border-radius: 16px;
    max-width: 520px;
    width: 100%;
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
}

.app h1 {
    font-size: 28px;
    margin-bottom: 8px;
}

.app p {
    color: #cbd5f5;
    margin-bottom: 20px;
}

.counter {
    display: flex;
    align-items: center;
    gap: 16px;
}

.counter button {
    background: var(--accent);
    border: none;
    color: #0f172a;
    font-weight: 700;
    padding: 10px 16px;
    border-radius: 10px;
    cursor: pointer;
}

.counter button:hover {
    background: var(--accent-dark);
}

.count {
    font-size: 24px;
    min-width: 48px;
    text-align: center;
}`,
                'app.js': `const rootEl = document.getElementById('root');

function App() {
    const [count, setCount] = React.useState(0);

    return React.createElement(
        'div',
        { className: 'app' },
        React.createElement('h1', null, 'React UMD Starter'),
        React.createElement('p', null, 'No bundler, no imports, runs in preview.'),
        React.createElement(
            'div',
            { className: 'counter' },
            React.createElement(
                'button',
                { onClick: () => setCount(Math.max(0, count - 1)) },
                '-'
            ),
            React.createElement('span', { className: 'count' }, count),
            React.createElement(
                'button',
                { onClick: () => setCount(count + 1) },
                '+'
            )
        )
    );
}

if (rootEl && window.React && window.ReactDOM) {
    const root = ReactDOM.createRoot(rootEl);
    root.render(React.createElement(App));
} else {
    console.error('React UMD globals not found.');
}`,
                'README.md': `# React UMD Starter

This template runs without a bundler.

Files:
- index.html
- style.css
- app.js

Notes:
- Uses React UMD globals from CDN.
- No import/export in app.js.
- Press F5 to preview.`
            },
            
            'vue-umd': {
                'index.html': `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue 3 UMD Starter</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="app">
        <h1>Vue 3 UMD Starter</h1>
        <p>{{ message }}</p>
        <div class="counter">
            <button @click="decrement">-</button>
            <span class="count">{{ count }}</span>
            <button @click="increment">+</button>
        </div>
        <p class="hint">Doubled: {{ doubled }}</p>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"><\/script>
    <script src="app.js"><\/script>
</body>
</html>`,
                'style.css': `:root {
    --bg: #0f172a;
    --card: #112a2f;
    --text: #ecfeff;
    --accent: #34d399;
    --accent-dark: #10b981;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
}

.app {
    background: var(--card);
    padding: 32px;
    border-radius: 16px;
    max-width: 520px;
    width: 100%;
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
}

.app h1 {
    font-size: 28px;
    margin-bottom: 8px;
}

.app p {
    color: #a7f3d0;
    margin-bottom: 16px;
}

.counter {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 12px;
}

.counter button {
    background: var(--accent);
    border: none;
    color: #042f2e;
    font-weight: 700;
    padding: 10px 16px;
    border-radius: 10px;
    cursor: pointer;
}

.counter button:hover {
    background: var(--accent-dark);
}

.count {
    font-size: 24px;
    min-width: 48px;
    text-align: center;
}

.hint {
    font-size: 13px;
    opacity: 0.8;
}`,
                'app.js': `const rootEl = document.getElementById('app');

if (!rootEl || !window.Vue) {
    console.error('Vue global not found.');
} else {
    const { createApp, ref, computed } = Vue;

    createApp({
        setup() {
            const count = ref(0);
            const message = ref('No bundler, no imports, runs in preview.');
            const doubled = computed(() => count.value * 2);

            const increment = () => {
                count.value += 1;
            };

            const decrement = () => {
                count.value = Math.max(0, count.value - 1);
            };

            return { count, message, doubled, increment, decrement };
        }
    }).mount('#app');
}`,
                'README.md': `# Vue 3 UMD Starter

This template runs without a bundler.

Files:
- index.html
- style.css
- app.js

Notes:
- Uses Vue global build from CDN.
- No import/export in app.js.
- Press F5 to preview.`
            },
            
            'react-ts': {
                'package.json': `{
  "name": "procode-react-app",
  "version": "1.0.0",
  "private": true,
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "@vitejs/plugin-react": "^4.0.0",
    "typescript": "^5.0.0",
    "vite": "^4.4.0"
  }
}`,
                'vite.config.ts': `import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,
    open: true
  }
})`,
                'tsconfig.json': `{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["DOM", "DOM.Iterable", "ESNext"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}`,
                'tsconfig.node.json': `{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}`,
                'index.html': `<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React + TypeScript + Vite</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"><\/script>
  </body>
</html>`,
                'src/main.tsx': `import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.tsx'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)`,
                'src/App.tsx': `import React, { useState, useEffect } from 'react'
import './App.css'

interface Todo {
  id: number
  text: string
  completed: boolean
}

function App() {
  const [todos, setTodos] = useState<Todo[]>([
    { id: 1, text: 'Learn React', completed: true },
    { id: 2, text: 'Build a project', completed: false },
    { id: 3, text: 'Deploy to production', completed: false }
  ])
  
  const [input, setInput] = useState('')
  const [filter, setFilter] = useState<'all' | 'active' | 'completed'>('all')

  const addTodo = (e: React.FormEvent) => {
    e.preventDefault()
    if (!input.trim()) return
    
    setTodos([...todos, {
      id: Date.now(),
      text: input,
      completed: false
    }])
    setInput('')
  }

  const toggleTodo = (id: number) => {
    setTodos(todos.map(todo =>
      todo.id === id ? { ...todo, completed: !todo.completed } : todo
    ))
  }

  const deleteTodo = (id: number) => {
    setTodos(todos.filter(todo => todo.id !== id))
  }

  const filteredTodos = todos.filter(todo => {
    if (filter === 'active') return !todo.completed
    if (filter === 'completed') return todo.completed
    return true
  })

  const activeCount = todos.filter(todo => !todo.completed).length

  return (
    <div className="app">
      <header>
        <h1> React Todo App</h1>
        <p>Built with TypeScript + Vite</p>
      </header>

      <main>
        <form onSubmit={addTodo} className="todo-form">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            placeholder="What needs to be done?"
            className="todo-input"
          />
          <button type="submit" className="add-btn">
            Add Todo
          </button>
        </form>

        <div className="filters">
          <button
            className={filter === 'all' ? 'active' : ''}
            onClick={() => setFilter('all')}
          >
            All ({todos.length})
          </button>
          <button
            className={filter === 'active' ? 'active' : ''}
            onClick={() => setFilter('active')}
          >
            Active ({activeCount})
          </button>
          <button
            className={filter === 'completed' ? 'active' : ''}
            onClick={() => setFilter('completed')}
          >
            Completed ({todos.length - activeCount})
          </button>
        </div>

        <div className="todo-list">
          {filteredTodos.map(todo => (
            <div key={todo.id} className={\`todo-item \${todo.completed ? 'completed' : ''}\`}>
              <input
                type="checkbox"
                checked={todo.completed}
                onChange={() => toggleTodo(todo.id)}
                className="todo-checkbox"
              />
              <span className="todo-text">{todo.text}</span>
              <button
                onClick={() => deleteTodo(todo.id)}
                className="delete-btn"
              >
                
              </button>
            </div>
          ))}
          
          {filteredTodos.length === 0 && (
            <div className="empty-state">
              {filter === 'all' ? 'No todos yet. Add one above!' :
               filter === 'active' ? 'No active todos!' :
               'No completed todos!'}
            </div>
          )}
        </div>

        <div className="stats">
          <div className="stat">
            <div className="stat-value">{todos.length}</div>
            <div className="stat-label">Total</div>
          </div>
          <div className="stat">
            <div className="stat-value">{activeCount}</div>
            <div className="stat-label">Active</div>
          </div>
          <div className="stat">
            <div className="stat-value">{todos.length - activeCount}</div>
            <div className="stat-label">Completed</div>
          </div>
        </div>
      </main>

      <footer>
        <p>Built with  using ProCode IDE</p>
        <p className="hint">Double-click to edit  Press Enter to save</p>
      </footer>
    </div>
  )
}

export default App`,
                'src/App.css': `.app {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

header {
  text-align: center;
  margin-bottom: 3rem;
}

header h1 {
  font-size: 2.5rem;
  color: #333;
  margin-bottom: 0.5rem;
}

header p {
  color: #666;
  font-size: 1.1rem;
}

.todo-form {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
}

.todo-input {
  flex: 1;
  padding: 1rem;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 1rem;
  transition: border 0.2s;
}

.todo-input:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.add-btn {
  background: #6366f1;
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}

.add-btn:hover {
  background: #4f46e5;
}

.filters {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
}

.filters button {
  padding: 0.75rem 1.5rem;
  border: 2px solid #e2e8f0;
  background: white;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s;
}

.filters button:hover {
  border-color: #6366f1;
}

.filters button.active {
  background: #6366f1;
  color: white;
  border-color: #6366f1;
}

.todo-list {
  background: white;
  border-radius: 12px;
  border: 2px solid #e2e8f0;
  overflow: hidden;
  margin-bottom: 2rem;
}

.todo-item {
  display: flex;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid #e2e8f0;
  transition: background 0.2s;
}

.todo-item:hover {
  background: #f8fafc;
}

.todo-item:last-child {
  border-bottom: none;
}

.todo-item.completed .todo-text {
  text-decoration: line-through;
  color: #94a3b8;
}

.todo-checkbox {
  width: 24px;
  height: 24px;
  margin-right: 1rem;
  cursor: pointer;
}

.todo-text {
  flex: 1;
  font-size: 1.1rem;
}

.delete-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: #f1f5f9;
  color: #64748b;
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.delete-btn:hover {
  background: #ef4444;
  color: white;
}

.empty-state {
  padding: 3rem;
  text-align: center;
  color: #94a3b8;
  font-size: 1.1rem;
}

.stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-bottom: 3rem;
}

.stat {
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  border: 2px solid #e2e8f0;
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: #6366f1;
  margin-bottom: 0.5rem;
}

.stat-label {
  font-size: 0.9rem;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

footer {
  text-align: center;
  padding: 2rem;
  color: #64748b;
  border-top: 2px solid #e2e8f0;
}

.hint {
  font-size: 0.9rem;
  margin-top: 0.5rem;
  color: #94a3b8;
}

@media (max-width: 768px) {
  .app {
    padding: 1rem;
  }
  
  .todo-form {
    flex-direction: column;
  }
  
  .filters {
    flex-wrap: wrap;
  }
  
  .stats {
    grid-template-columns: 1fr;
  }
}`,
                'src/index.css': `/* Modern CSS Reset */
*, *::before, *::after {
  box-sizing: border-box;
}

* {
  margin: 0;
}

body {
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f8fafc;
  color: #1e293b;
}

img, picture, video, canvas, svg {
  display: block;
  max-width: 100%;
}

input, button, textarea, select {
  font: inherit;
}

p, h1, h2, h3, h4, h5, h6 {
  overflow-wrap: break-word;
}

#root {
  isolation: isolate;
  min-height: 100vh;
}`
            },
            
            'python-data': {
                'main.py': `#!/usr/bin/env python3
"""
Data Analysis Dashboard
ProCode IDE - Python Data Science Template
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime, timedelta
import json
import warnings
warnings.filterwarnings('ignore')

print("=" * 60)
print(" DATA ANALYSIS DASHBOARD")
print("=" * 60)

# Set style
plt.style.use('seaborn-v0_8-darkgrid')
sns.set_palette("husl")

# Generate sample data
def generate_sample_data():
    """Generate realistic sample data for analysis"""
    np.random.seed(42)
    
    dates = pd.date_range('2023-01-01', periods=100, freq='D')
    
    data = {
        'date': dates,
        'sales': np.random.normal(1000, 200, 100).cumsum() + 5000,
        'customers': np.random.poisson(50, 100),
        'revenue': np.random.exponential(1000, 100).cumsum(),
        'expenses': np.random.normal(300, 50, 100).cumsum(),
        'temperature': np.random.normal(20, 5, 100),
        'promotion': np.random.choice([0, 1], 100, p=[0.7, 0.3])
    }
    
    # Add weekly seasonality
    data['sales'] += np.sin(np.arange(100) * 2 * np.pi / 7) * 100
    
    # Add trend
    data['sales'] += np.arange(100) * 10
    
    return pd.DataFrame(data)

# Load data
print(" Generating sample data...")
df = generate_sample_data()

print(f" Data loaded successfully")
print(f" Shape: {df.shape}")
print(f" Date range: {df['date'].min().date()} to {df['date'].max().date()}")
print()

# Basic statistics
print(" BASIC STATISTICS")
print("-" * 40)
print(df.describe().round(2))
print()

# Calculate metrics
total_sales = df['sales'].iloc[-1] - df['sales'].iloc[0]
avg_daily_customers = df['customers'].mean()
total_revenue = df['revenue'].iloc[-1]
profit_margin = ((df['revenue'] - df['expenses']).iloc[-1] / df['revenue'].iloc[-1]) * 100

print(" KEY METRICS")
print("-" * 40)
print(f"Total Sales: \${total_sales:,.2f}")
print(f"Average Daily Customers: {avg_daily_customers:.0f}")
print(f"Total Revenue: \${total_revenue:,.2f}")
print(f"Profit Margin: {profit_margin:.1f}%")
print()

# Time series analysis
print(" TIME SERIES ANALYSIS")
print("-" * 40)

# Calculate rolling averages
df['sales_7d_avg'] = df['sales'].rolling(window=7).mean()
df['revenue_7d_avg'] = df['revenue'].rolling(window=7).mean()

# Growth rate
sales_growth = ((df['sales'].iloc[-1] - df['sales'].iloc[0]) / df['sales'].iloc[0]) * 100
revenue_growth = ((df['revenue'].iloc[-1] - df['revenue'].iloc[0]) / df['revenue'].iloc[0]) * 100

print(f"Sales Growth: {sales_growth:.1f}%")
print(f"Revenue Growth: {revenue_growth:.1f}%")

# Promotion impact
promo_days = df[df['promotion'] == 1]
non_promo_days = df[df['promotion'] == 0]

if len(promo_days) > 0 and len(non_promo_days) > 0:
    promo_avg_sales = promo_days['sales'].mean()
    non_promo_avg_sales = non_promo_days['sales'].mean()
    promo_impact = ((promo_avg_sales - non_promo_avg_sales) / non_promo_avg_sales) * 100
    print(f"Promotion Impact: +{promo_impact:.1f}% increase in sales")
print()

# Correlation analysis
print(" CORRELATION ANALYSIS")
print("-" * 40)
correlation_matrix = df[['sales', 'customers', 'revenue', 'expenses', 'temperature']].corr()
print(correlation_matrix.round(2))
print()

# Generate visualizations
print(" GENERATING VISUALIZATIONS...")

fig, axes = plt.subplots(2, 2, figsize=(15, 10))

# 1. Sales trend
axes[0, 0].plot(df['date'], df['sales'], label='Daily Sales', linewidth=2)
axes[0, 0].plot(df['date'], df['sales_7d_avg'], label='7-Day Avg', linewidth=2, linestyle='--')
axes[0, 0].set_title('Sales Trend Over Time', fontsize=14, fontweight='bold')
axes[0, 0].set_xlabel('Date')
axes[0, 0].set_ylabel('Sales ($)')
axes[0, 0].legend()
axes[0, 0].grid(True, alpha=0.3)

# 2. Revenue vs Expenses
axes[0, 1].fill_between(df['date'], df['revenue'], df['expenses'], 
                         where=(df['revenue'] > df['expenses']), 
                         color='green', alpha=0.3, label='Profit')
axes[0, 1].fill_between(df['date'], df['revenue'], df['expenses'], 
                         where=(df['revenue'] <= df['expenses']), 
                         color='red', alpha=0.3, label='Loss')
axes[0, 1].plot(df['date'], df['revenue'], label='Revenue', linewidth=2)
axes[0, 1].plot(df['date'], df['expenses'], label='Expenses', linewidth=2)
axes[0, 1].set_title('Revenue vs Expenses', fontsize=14, fontweight='bold')
axes[0, 1].set_xlabel('Date')
axes[0, 1].set_ylabel('Amount ($)')
axes[0, 1].legend()
axes[0, 1].grid(True, alpha=0.3)

# 3. Customer distribution
axes[1, 0].hist(df['customers'], bins=15, edgecolor='black', alpha=0.7)
axes[1, 0].axvline(df['customers'].mean(), color='red', linestyle='--', 
                   linewidth=2, label=f'Mean: {df["customers"].mean():.1f}')
axes[1, 0].set_title('Customer Distribution', fontsize=14, fontweight='bold')
axes[1, 0].set_xlabel('Number of Customers')
axes[1, 0].set_ylabel('Frequency')
axes[1, 0].legend()
axes[1, 0].grid(True, alpha=0.3)

# 4. Correlation heatmap
im = axes[1, 1].imshow(correlation_matrix.values, cmap='coolwarm', vmin=-1, vmax=1)
axes[1, 1].set_title('Feature Correlation', fontsize=14, fontweight='bold')
axes[1, 1].set_xticks(np.arange(len(correlation_matrix.columns)))
axes[1, 1].set_yticks(np.arange(len(correlation_matrix.columns)))
axes[1, 1].set_xticklabels(correlation_matrix.columns, rotation=45)
axes[1, 1].set_yticklabels(correlation_matrix.columns)
plt.colorbar(im, ax=axes[1, 1])

# Add correlation values
for i in range(len(correlation_matrix.columns)):
    for j in range(len(correlation_matrix.columns)):
        text = axes[1, 1].text(j, i, f'{correlation_matrix.iloc[i, j]:.2f}',
                               ha="center", va="center", 
                               color="white" if abs(correlation_matrix.iloc[i, j]) > 0.5 else "black")

plt.tight_layout()
plt.savefig('analysis_dashboard.png', dpi=300, bbox_inches='tight')
print(" Dashboard saved as 'analysis_dashboard.png'")
print()

# Export results
results = {
    'total_sales': float(total_sales),
    'avg_daily_customers': float(avg_daily_customers),
    'total_revenue': float(total_revenue),
    'profit_margin': float(profit_margin),
    'sales_growth': float(sales_growth),
    'revenue_growth': float(revenue_growth),
    'analysis_date': datetime.now().isoformat()
}

with open('analysis_results.json', 'w') as f:
    json.dump(results, f, indent=2)

print(" RESULTS EXPORTED")
print("-" * 40)
print(json.dumps(results, indent=2))
print()

# Future prediction (simple linear projection)
print(" FUTURE PREDICTION (Next 30 Days)")
print("-" * 40)

# Simple linear regression for prediction
from sklearn.linear_model import LinearRegression

# Prepare data for prediction
X = np.arange(len(df)).reshape(-1, 1)
y_sales = df['sales'].values

model = LinearRegression()
model.fit(X, y_sales)

# Predict next 30 days
future_days = np.arange(len(df), len(df) + 30).reshape(-1, 1)
future_sales = model.predict(future_days)

predicted_growth = ((future_sales[-1] - future_sales[0]) / future_sales[0]) * 100
print(f"Predicted sales growth in next 30 days: {predicted_growth:.1f}%")
print(f"Estimated sales on day 30: \${future_sales[-1]:,.2f}")

print()
print("=" * 60)
print(" ANALYSIS COMPLETE!")
print("=" * 60)
print()
print(" Generated Files:")
print("   analysis_dashboard.png - Visualization dashboard")
print("   analysis_results.json - Analysis results")
print()
print(" Next Steps:")
print("  1. Review the visualizations")
print("  2. Adjust parameters in the code")
print("  3. Add more data sources")
print("  4. Implement machine learning models")
print()

# Interactive exploration
print(" INTERACTIVE EXPLORATION")
print("-" * 40)
print("Try modifying the code to:")
print("   Change the sample data generation")
print("   Add more visualization types")
print("   Implement statistical tests")
print("   Connect to real data sources")
print()

print(" Happy Data Science!")`,
                'analysis_results.json': `{}`,
                'requirements.txt': `pandas>=2.0.0
numpy>=1.24.0
matplotlib>=3.7.0
seaborn>=0.12.0
scikit-learn>=1.2.0
jupyter>=1.0.0`,
                'README.md': `# Python Data Science Project

A comprehensive data analysis dashboard built with Python.

## Features
-  Data generation and simulation
-  Time series analysis
-  Correlation analysis
-  Interactive visualizations
-  Future predictions
-  Results export

## Setup
\`\`\`bash
# Install dependencies
pip install -r requirements.txt

# Run analysis
python main.py
\`\`\`

## Project Structure
\`\`\`
project/
 main.py              # Main analysis script
 requirements.txt     # Python dependencies
 analysis_results.json # Analysis results
 analysis_dashboard.png # Generated dashboard
\`\`\`

## Technologies Used
- **Pandas**: Data manipulation
- **NumPy**: Numerical computing
- **Matplotlib**: Visualization
- **Seaborn**: Statistical graphics
- **Scikit-learn**: Machine learning

## Customization
1. Modify data generation in \`generate_sample_data()\`
2. Add new analysis functions
3. Customize visualizations
4. Connect to real databases

## Tips
- Use **F5** to run the analysis
- Check the terminal for results
- View generated visualizations
- Export results for reporting`
            },
            
            // NEW TEMPLATES ADDED
            'vue-ts': {
                'package.json': `{
  "name": "procode-vue-app",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "vue": "^3.3.0"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^4.2.0",
    "typescript": "^5.0.0",
    "vite": "^4.4.0",
    "vue-tsc": "^1.8.0"
  }
}`,
                'vite.config.ts': `import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  server: {
    port: 3000,
    open: true
  }
})`,
                'src/main.ts': `import { createApp } from 'vue'
import App from './App.vue'
import './style.css'

createApp(App).mount('#app')`,
                'src/App.vue': `<template>
  <div class="app">
    <header>
      <h1> Vue 3 + TypeScript App</h1>
      <p>Built with ProCode IDE v15.0</p>
    </header>
    
    <main>
      <div class="counter">
        <button @click="decrement">-</button>
        <span class="count">{{ count }}</span>
        <button @click="increment">+</button>
      </div>
      
      <div class="controls">
        <input v-model="message" placeholder="Type a message..." />
        <button @click="addMessage">Add Message</button>
      </div>
      
      <div class="messages">
        <div v-for="(msg, index) in messages" :key="index" class="message">
          {{ msg }}
        </div>
      </div>
    </main>
    
    <footer>
      <p>Count: {{ count }} | Messages: {{ messages.length }}</p>
    </footer>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'

const count = ref(0)
const message = ref('')
const messages = ref<string[]>([])

const increment = () => count.value++
const decrement = () => count.value > 0 && count.value--
const addMessage = () => {
  if (message.value.trim()) {
    messages.value.push(message.value)
    message.value = ''
  }
}
<\/script>

<style scoped>
.app {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

header {
  margin-bottom: 3rem;
}

header h1 {
  font-size: 2.5rem;
  color: #42b883;
  margin-bottom: 0.5rem;
}

header p {
  color: #64748b;
}

.counter {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 2rem;
  margin: 2rem 0;
  font-size: 2rem;
}

.counter button {
  width: 60px;
  height: 60px;
  border: none;
  background: #42b883;
  color: white;
  border-radius: 50%;
  font-size: 2rem;
  cursor: pointer;
  transition: transform 0.2s;
}

.counter button:hover {
  transform: scale(1.1);
}

.count {
  font-size: 3rem;
  font-weight: bold;
  color: #35495e;
  min-width: 100px;
}

.controls {
  margin: 2rem 0;
  display: flex;
  gap: 1rem;
  justify-content: center;
}

.controls input {
  padding: 0.75rem 1rem;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  width: 300px;
  font-size: 1rem;
}

.controls button {
  padding: 0.75rem 1.5rem;
  background: #35495e;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.messages {
  margin-top: 2rem;
  max-height: 300px;
  overflow-y: auto;
}

.message {
  background: white;
  padding: 1rem;
  margin: 0.5rem 0;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

footer {
  margin-top: 3rem;
  padding-top: 1rem;
  border-top: 2px solid #e2e8f0;
  color: #64748b;
}
</style>`,
                'src/style.css': `/* Global Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #f8fafc;
  color: #1e293b;
  line-height: 1.5;
}

#app {
  min-height: 100vh;
}`
            },
            
            'nextjs-ts': {
                'package.json': `{
  "name": "procode-next-app",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start"
  },
  "dependencies": {
    "next": "14.0.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "typescript": "^5.0.0"
  }
}`,
                'next.config.js': `/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
}

module.exports = nextConfig`,
                'tsconfig.json': `{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}`,
                'src/app/page.tsx': `import Counter from '@/components/Counter'
import Header from '@/components/Header'

export default function Home() {
  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
      <Header />
      
      <main className="container mx-auto px-4 py-16">
        <div className="max-w-4xl mx-auto">
          <div className="text-center mb-12">
            <h1 className="text-5xl font-bold text-gray-900 mb-4">
              Next.js 14 + TypeScript
            </h1>
            <p className="text-xl text-gray-600">
              Modern full-stack application template
            </p>
          </div>
          
          <div className="grid md:grid-cols-2 gap-8">
            <div className="bg-white rounded-2xl p-8 shadow-xl">
              <h2 className="text-2xl font-bold text-gray-800 mb-6">
                Interactive Counter
              </h2>
              <Counter />
            </div>
            
            <div className="bg-white rounded-2xl p-8 shadow-xl">
              <h2 className="text-2xl font-bold text-gray-800 mb-6">
                Features
              </h2>
              <ul className="space-y-4">
                {[
                  ' App Router (Next.js 14)',
                  ' TypeScript ready',
                  ' Fast Refresh',
                  ' ESLint configured',
                  ' Tailwind CSS',
                  ' Responsive design'
                ].map((feature, i) => (
                  <li key={i} className="flex items-center gap-3 text-gray-700">
                    <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                    {feature}
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      </main>
      
      <footer className="text-center py-8 text-gray-500 border-t">
        <p>Built with  using ProCode IDE v15.0</p>
      </footer>
    </div>
  )
}`,
                'src/components/Counter.tsx': `'use client'

import { useState } from 'react'

export default function Counter() {
  const [count, setCount] = useState(0)
  const [history, setHistory] = useState<number[]>([])

  const increment = () => {
    setCount(prev => {
      const newCount = prev + 1
      setHistory(prevHistory => [...prevHistory.slice(-4), newCount])
      return newCount
    })
  }

  const decrement = () => {
    if (count > 0) {
      setCount(prev => {
        const newCount = prev - 1
        setHistory(prevHistory => [...prevHistory.slice(-4), newCount])
        return newCount
      })
    }
  }

  const reset = () => {
    setCount(0)
    setHistory([])
  }

  return (
    <div className="space-y-6">
      <div className="text-center">
        <div className="text-6xl font-bold text-blue-600 mb-4">{count}</div>
        <p className="text-gray-600">Current Count</p>
      </div>

      <div className="flex gap-4 justify-center">
        <button
          onClick={decrement}
          className="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
        >
          Decrement
        </button>
        <button
          onClick={reset}
          className="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
        >
          Reset
        </button>
        <button
          onClick={increment}
          className="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
        >
          Increment
        </button>
      </div>

      {history.length > 0 && (
        <div className="mt-8">
          <h3 className="text-lg font-semibold text-gray-700 mb-2">Recent History</h3>
          <div className="flex gap-2">
            {history.map((value, index) => (
              <div
                key={index}
                className="flex-1 bg-gray-100 rounded-lg p-3 text-center"
              >
                <div className="text-2xl font-bold text-gray-800">{value}</div>
                <div className="text-sm text-gray-500">Step {history.length - index}</div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}`,
                'src/components/Header.tsx': `export default function Header() {
  return (
    <header className="bg-white shadow-sm">
      <div className="container mx-auto px-4 py-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg"></div>
            <div>
              <h1 className="text-2xl font-bold text-gray-900">NextApp</h1>
              <p className="text-sm text-gray-500">v1.0.0</p>
            </div>
          </div>
          
          <nav className="flex gap-6">
            {['Home', 'Features', 'Docs', 'About'].map((item) => (
              <a
                key={item}
                href="#"
                className="text-gray-700 hover:text-blue-600 transition-colors"
              >
                {item}
              </a>
            ))}
          </nav>
        </div>
      </div>
    </header>
  )
}`
            }
        }
    }
};

// ============================================
// ENHANCED UTILITY FUNCTIONS
// ============================================
const Utils = {
    // Enhanced toast notifications with icons
    toast: function(message, type = 'info', duration = 4000) {
        const icons = {
            'info': 'fas fa-info-circle',
            'success': 'fas fa-check-circle',
            'warning': 'fas fa-exclamation-triangle',
            'error': 'fas fa-times-circle'
        };
        
        const colors = {
            'info': '#3b82f6',
            'success': '#22c55e',
            'warning': '#f59e0b',
            'error': '#ef4444'
        };
        
        Toastify({
            text: `<i class="${icons[type]}" style="margin-right:8px;"></i> ${message}`,
            duration: duration,
            gravity: "bottom",
            position: "right",
            escapeMarkup: false,
            style: {
                background: colors[type],
                borderRadius: '8px',
                fontFamily: "'Inter', sans-serif",
                fontSize: '13px',
                padding: '12px 16px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.3)'
            }
        }).showToast();
    },
    
    // Enhanced UUID with prefix support
    uuid: function(prefix = '') {
        const id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
        return prefix ? `${prefix}-${id}` : id;
    },
    
    // Enhanced debounce with immediate option
    debounce: function(func, wait, immediate = false) {
        let timeout;
        return function executedFunction(...args) {
            const context = this;
            const later = () => {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            const callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    },
    
    // Enhanced file extension detection
    getExtension: function(path) {
        const parts = path.split('.');
        if (parts.length === 1) return '';
        return parts.pop().toLowerCase();
    },
    
    // Enhanced file icon mapping with more file types
    getFileIcon: function(path) {
        const ext = this.getExtension(path);
        const fileName = path.split('/').pop().toLowerCase();
        
        // Enhanced icon map
        const iconMap = {
            // Programming Languages
            'js': ['fab fa-js-square', '#facc15'],
            'jsx': ['fab fa-react', '#61dafb'],
            'ts': ['fas fa-code', '#3178c6'],
            'tsx': ['fab fa-react', '#3178c6'],
            'html': ['fab fa-html5', '#e34c26'],
            'css': ['fab fa-css3-alt', '#264de4'],
            'scss': ['fab fa-sass', '#cc6699'],
            'sass': ['fab fa-sass', '#cc6699'],
            'less': ['fab fa-less', '#2b4c80'],
            'json': ['fas fa-brackets-curly', '#f5de19'],
            'xml': ['fas fa-code', '#f16529'],
            'py': ['fab fa-python', '#3776ab'],
            'java': ['fab fa-java', '#007396'],
            'cpp': ['fas fa-code', '#00599c'],
            'c': ['fas fa-code', '#a8b9cc'],
            'cs': ['fas fa-code', '#239120'],
            'php': ['fab fa-php', '#777bb4'],
            'rb': ['fas fa-gem', '#cc342d'],
            'go': ['fas fa-code', '#00add8'],
            'rs': ['fas fa-code', '#dea584'],
            'swift': ['fab fa-swift', '#fa7343'],
            'kt': ['fas fa-code', '#f18e33'],
            'scala': ['fas fa-code', '#dc322f'],
            
            // Web
            'vue': ['fab fa-vuejs', '#42b883'],
            'vuejs': ['fab fa-vuejs', '#42b883'],
            'tsx': ['fab fa-react', '#61dafb'],
            
            // Config Files
            'config': ['fas fa-cog', '#a1a1aa'],
            'yml': ['fas fa-file-code', '#cb171e'],
            'yaml': ['fas fa-file-code', '#cb171e'],
            'toml': ['fas fa-file-code', '#9c4221'],
            'ini': ['fas fa-cog', '#a1a1aa'],
            'env': ['fas fa-key', '#8257e5'],
            
            // Documentation
            'md': ['fab fa-markdown', '#ffffff'],
            'markdown': ['fab fa-markdown', '#ffffff'],
            'txt': ['fas fa-file-alt', '#a1a1aa'],
            'pdf': ['fas fa-file-pdf', '#f40f02'],
            'doc': ['fas fa-file-word', '#2b579a'],
            'docx': ['fas fa-file-word', '#2b579a'],
            
            // Images
            'jpg': ['fas fa-file-image', '#dc2626'],
            'jpeg': ['fas fa-file-image', '#dc2626'],
            'png': ['fas fa-file-image', '#2563eb'],
            'gif': ['fas fa-file-image', '#f59e0b'],
            'svg': ['fas fa-file-image', '#f59e0b'],
            'ico': ['fas fa-file-image', '#7c3aed'],
            'webp': ['fas fa-file-image', '#0891b2'],
            
            // Data
            'csv': ['fas fa-file-csv', '#059669'],
            'xlsx': ['fas fa-file-excel', '#217346'],
            'sql': ['fas fa-database', '#00758f'],
            'db': ['fas fa-database', '#00758f'],
            'sqlite': ['fas fa-database', '#003b57'],
            
            // Audio/Video
            'mp3': ['fas fa-file-audio', '#3b82f6'],
            'wav': ['fas fa-file-audio', '#3b82f6'],
            'mp4': ['fas fa-file-video', '#ef4444'],
            'avi': ['fas fa-file-video', '#ef4444'],
            'mov': ['fas fa-file-video', '#ef4444']
        };
        
        // Check for specific file names first
        if (fileName === 'package.json') return ['fas fa-box', '#f97316'];
        if (fileName === 'package-lock.json') return ['fas fa-box', '#ea580c'];
        if (fileName.includes('tsconfig')) return ['fas fa-cog', '#3178c6'];
        if (fileName.includes('vite.config')) return ['fas fa-bolt', '#646cff'];
        if (fileName.includes('webpack.config')) return ['fas fa-cube', '#8dd6f9'];
        if (fileName === 'dockerfile') return ['fab fa-docker', '#2496ed'];
        if (fileName === 'docker-compose.yml') return ['fab fa-docker', '#2496ed'];
        if (fileName === '.gitignore') return ['fas fa-eye-slash', '#71717a'];
        if (fileName === '.env') return ['fas fa-key', '#8257e5'];
        if (fileName === '.env.example') return ['fas fa-key', '#a855f7'];
        if (fileName === 'requirements.txt') return ['fas fa-list', '#059669'];
        if (fileName === 'readme.md' || fileName === 'readme') return ['fab fa-readme', '#3b82f6'];
        if (fileName === 'license') return ['fas fa-scale-balanced', '#6b7280'];
        if (fileName === 'changelog.md') return ['fas fa-history', '#8b5cf6'];
        if (fileName === 'contributing.md') return ['fas fa-handshake', '#10b981'];
        
        // Check for folder
        if (path.endsWith('/')) return ['fas fa-folder', '#d97706'];
        
        return iconMap[ext] || ['fas fa-file', '#71717a'];
    },
    
    // Enhanced language detection
    detectLanguage: function(path) {
        const ext = this.getExtension(path);
        const langMap = {
            'js': 'javascript',
            'jsx': 'javascript',
            'ts': 'typescript',
            'tsx': 'typescript',
            'html': 'html',
            'css': 'css',
            'scss': 'scss',
            'sass': 'sass',
            'less': 'less',
            'json': 'json',
            'py': 'python',
            'md': 'markdown',
            'txt': 'plaintext',
            'xml': 'xml',
            'yml': 'yaml',
            'yaml': 'yaml',
            'sh': 'shell',
            'bash': 'shell',
            'ps1': 'powershell',
            'sql': 'sql',
            'java': 'java',
            'cpp': 'cpp',
            'c': 'c',
            'cs': 'csharp',
            'php': 'php',
            'rb': 'ruby',
            'go': 'go',
            'rs': 'rust',
            'swift': 'swift',
            'kt': 'kotlin',
            'scala': 'scala',
            'lua': 'lua',
            'perl': 'perl',
            'r': 'r',
            'dart': 'dart',
            'elixir': 'elixir',
            'haskell': 'haskell',
            'clojure': 'clojure',
            'vue': 'vue',
            'svelte': 'svelte'
        };
        return langMap[ext] || 'plaintext';
    },
    
    // Enhanced file size formatting
    formatBytes: function(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    },
    
    // Enhanced date formatting with relative time
    formatDate: function(date, format = 'relative') {
        const d = new Date(date);
        
        if (format === 'relative') {
            const now = new Date();
            const diffMs = now - d;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            
            if (diffSec < 60) return 'just now';
            if (diffMin < 60) return `${diffMin} minute${diffMin === 1 ? '' : 's'} ago`;
            if (diffHour < 24) return `${diffHour} hour${diffHour === 1 ? '' : 's'} ago`;
            if (diffDay < 7) return `${diffDay} day${diffDay === 1 ? '' : 's'} ago`;
        }
        
        return d.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    },
    
    // Enhanced HTML escaping
    escapeHtml: function(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },
    
    // Enhanced clipboard with fallback
    copyToClipboard: async function(text) {
        try {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
            } else {
                // Fallback for insecure contexts
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                textArea.remove();
            }
            this.toast('Copied to clipboard', 'success');
            return true;
        } catch (err) {
            this.toast('Failed to copy to clipboard', 'error');
            return false;
        }
    },
    
    // Enhanced download with progress tracking
    downloadFile: function(filename, content, type = 'text/plain') {
        const blob = new Blob([content], { type: type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    },
    
    // Enhanced file reading with progress
    readFile: function(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    // Could update UI with progress
                }
            };
            reader.onerror = (e) => reject(e);
            reader.readAsText(file);
        });
    },
    
    // Enhanced file name validation
    isValidFileName: function(name) {
        if (!name || name.trim() === '') return false;
        
        // Check for invalid characters
        const invalidChars = /[<>:"/\\|?*\x00-\x1F]/g;
        if (invalidChars.test(name)) return false;
        
        // Check for reserved names (Windows)
        const reservedNames = /^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i;
        if (reservedNames.test(name)) return false;
        
        // Check for trailing dots or spaces
        if (name.endsWith('.') || name.endsWith(' ')) return false;
        
        // Check length (255 max for most systems)
        if (name.length > 255) return false;
        
        return true;
    },
    
    // Color utility functions
    lightenColor: function(color, percent) {
        const num = parseInt(color.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        return "#" + (
            0x1000000 +
            (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)
        ).toString(16).slice(1);
    },
    
    // Generate random color
    randomColor: function() {
        return '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
    },
    
    // Get contrast color (black or white)
    getContrastColor: function(hexcolor) {
        hexcolor = hexcolor.replace("#", "");
        const r = parseInt(hexcolor.substr(0,2),16);
        const g = parseInt(hexcolor.substr(2,2),16);
        const b = parseInt(hexcolor.substr(4,2),16);
        const brightness = ((r * 299) + (g * 587) + (b * 114)) / 1000;
        return brightness > 125 ? '#000000' : '#ffffff';
    },
    
    // Deep clone object
    deepClone: function(obj) {
        return JSON.parse(JSON.stringify(obj));
    },
    
    // Merge objects deeply
    deepMerge: function(target, ...sources) {
        if (!sources.length) return target;
        const source = sources.shift();
        
        if (this.isObject(target) && this.isObject(source)) {
            for (const key in source) {
                if (this.isObject(source[key])) {
                    if (!target[key]) Object.assign(target, { [key]: {} });
                    this.deepMerge(target[key], source[key]);
                } else {
                    Object.assign(target, { [key]: source[key] });
                }
            }
        }
        
        return this.deepMerge(target, ...sources);
    },
    
    // Check if value is object
    isObject: function(item) {
        return (item && typeof item === 'object' && !Array.isArray(item));
    },
    
    // Generate hash from string
    hashString: function(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return hash;
    },
    
    // Truncate text with ellipsis
    truncateText: function(text, maxLength = 100) {
        if (text.length <= maxLength) return text;
        return text.substr(0, maxLength) + '...';
    },
    
    // Capitalize first letter
    capitalize: function(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    },
    
    // Generate unique array
    uniqueArray: function(arr) {
        return [...new Set(arr)];
    },
    
    // Sleep function
    sleep: function(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    },
    
    // Retry function with exponential backoff
    retry: async function(fn, retries = 3, delay = 1000) {
        try {
            return await fn();
        } catch (error) {
            if (retries === 0) throw error;
            await this.sleep(delay);
            return this.retry(fn, retries - 1, delay * 2);
        }
    },
    
    // Parse query string
    parseQueryString: function(query) {
        return query.substr(1).split('&').reduce((params, param) => {
            const [key, value] = param.split('=');
            params[key] = value ? decodeURIComponent(value.replace(/\+/g, ' ')) : '';
            return params;
        }, {});
    },
    
    // Stringify query object
    stringifyQuery: function(params) {
        return Object.keys(params).map(key => 
            `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`
        ).join('&');
    },
    
    // Get CSS variable value
    getCssVariable: function(name) {
        return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    },
    
    // Set CSS variable
    setCssVariable: function(name, value) {
        document.documentElement.style.setProperty(name, value);
    },
    
    // Generate gradient
    generateGradient: function(color1, color2, angle = 135) {
        return `linear-gradient(${angle}deg, ${color1}, ${color2})`;
    },
    
    // Format number with commas
    formatNumber: function(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    },
    
    // Get file type category
    getFileTypeCategory: function(path) {
        const ext = this.getExtension(path);
        const categories = {
            'code': ['js', 'jsx', 'ts', 'tsx', 'py', 'java', 'cpp', 'c', 'cs', 'php', 'rb', 'go', 'rs', 'swift', 'kt', 'scala'],
            'web': ['html', 'css', 'scss', 'sass', 'less', 'vue', 'svelte'],
            'data': ['json', 'xml', 'yml', 'yaml', 'csv', 'sql'],
            'document': ['md', 'txt', 'pdf', 'doc', 'docx'],
            'image': ['jpg', 'jpeg', 'png', 'gif', 'svg', 'ico', 'webp'],
            'media': ['mp3', 'wav', 'mp4', 'avi', 'mov'],
            'config': ['config', 'env', 'ini', 'toml']
        };
        
        for (const [category, exts] of Object.entries(categories)) {
            if (exts.includes(ext)) return category;
        }
        
        return 'other';
    }
};

// ============================================
// ENHANCED FILE SYSTEM MANAGER
// ============================================
const FileSystem = {
    // Initialize file system with versioning
    init: function() {
        console.log(' Initializing Enhanced File System v15.0');
        
        // Load from localStorage with version check
        const saved = localStorage.getItem(`procode_fs_v${IDE.version}`);
        const settings = localStorage.getItem(`procode_settings_v${IDE.version}`);
        const version = localStorage.getItem('procode_version');
        
        // Migration from older versions
        if (version && version !== IDE.version) {
            this.migrateFromOldVersion(version);
        }
        
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                IDE.state.files = this.validateFileSystem(parsed);
                Utils.toast('Project loaded from storage', 'success');
            } catch (e) {
                console.error('Failed to parse saved files:', e);
                IDE.state.files = { ...IDE.state.templates.vanilla };
                Utils.toast('Created new project', 'info');
            }
        } else {
            IDE.state.files = { ...IDE.state.templates.vanilla };
            Utils.toast('Welcome to ProCode IDE v15.0!', 'info');
        }
        
        if (settings) {
            try {
                const savedSettings = JSON.parse(settings);
                IDE.state.settings = Utils.deepMerge(IDE.state.settings, savedSettings);
            } catch (e) {
                console.error('Failed to parse settings:', e);
            }
        }
        
        // Save current version
        localStorage.setItem('procode_version', IDE.version);
        
        this.refreshTree();
        this.setupAutoSave();
        this.setupFileWatchers();
        
        // Initialize file system metrics
        this.updateFileSystemMetrics();
        
        console.log(' File system initialized');
    },
    
    // Validate file system structure
    validateFileSystem: function(files) {
        const validated = {};
        for (const [path, content] of Object.entries(files)) {
            if (typeof content === 'string' && Utils.isValidFileName(path.split('/').pop())) {
                validated[path] = content;
            }
        }
        return validated;
    },
    
    // Migrate from older versions
    migrateFromOldVersion: function(oldVersion) {
        console.log(` Migrating from version ${oldVersion} to ${IDE.version}`);
        
        // Backup old data
        const oldData = localStorage.getItem(`procode_fs_v${oldVersion.replace('.', '_')}`);
        if (oldData) {
            localStorage.setItem(`procode_fs_backup_v${oldVersion}`, oldData);
        }
        
        Utils.toast(`Migrated from v${oldVersion} to v${IDE.version}`, 'info');
    },
    
    // Enhanced save with versioning
    save: function(immediate = false) {
        if (!immediate && !IDE.state.settings.editor.autoSave) {
            return;
        }
        
        const saveKey = `procode_fs_v${IDE.version}`;
        const settingsKey = `procode_settings_v${IDE.version}`;
        
        try {
            localStorage.setItem(saveKey, JSON.stringify(IDE.state.files));
            localStorage.setItem(settingsKey, JSON.stringify(IDE.state.settings));
            localStorage.setItem('procode_last_save', new Date().toISOString());
            
            // Update file system metrics
            this.updateFileSystemMetrics();
            
            // Visual feedback
            const saveBtn = document.querySelector('[title*="Save"]');
            if (saveBtn) {
                const originalColor = saveBtn.style.color;
                saveBtn.innerHTML = '<i class="fas fa-check"></i>';
                saveBtn.style.color = '#22c55e';
                
                setTimeout(() => {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i>';
                    saveBtn.style.color = originalColor;
                }, 1000);
            }
            
            if (immediate) {
                Utils.toast('Project saved successfully', 'success');
            }
            
            // Update save indicator
            this.updateSaveIndicator();
            
            return true;
        } catch (e) {
            console.error('Save failed:', e);
            Utils.toast('Save failed: ' + e.message, 'error');
            return false;
        }
    },
    
    // Update save indicator in footer
    updateSaveIndicator: function() {
        const lastSave = localStorage.getItem('procode_last_save');
        if (lastSave) {
            const timeAgo = Utils.formatDate(lastSave, 'relative');
            // Could add to footer or status bar
        }
    },
    
    // Setup auto-save with enhanced logic
    setupAutoSave: function() {
        if (IDE.state.settings.editor.autoSave) {
            this.autoSaveInterval = setInterval(() => {
                if (IDE.state.dirtyTabs.size > 0) {
                    this.save();
                    IDE.state.dirtyTabs.clear();
                    this.updateTabDirtyState();
                }
            }, IDE.state.settings.editor.autoSaveDelay);
            
            // Enhanced beforeunload handler
            window.addEventListener('beforeunload', (e) => {
                if (IDE.state.dirtyTabs.size > 0 && IDE.state.settings.editor.autoSave) {
                    this.save(true);
                }
                
                // Clear interval
                if (this.autoSaveInterval) {
                    clearInterval(this.autoSaveInterval);
                }
            });
        }
    },
    
    // Setup file watchers for external changes
    setupFileWatchers: function() {
        // This would integrate with File System Access API when available
        if ('showOpenFilePicker' in window) {
            console.log(' File System Access API available');
        }
    },
    
    // Update file system metrics
    updateFileSystemMetrics: function() {
        const metrics = {
            totalFiles: Object.keys(IDE.state.files).length,
            totalSize: 0,
            byType: {}
        };
        
        for (const [path, content] of Object.entries(IDE.state.files)) {
            const size = new Blob([content]).size;
            metrics.totalSize += size;
            
            const type = Utils.getFileTypeCategory(path);
            metrics.byType[type] = (metrics.byType[type] || 0) + 1;
        }
        
        IDE.state.fileSystemMetrics = metrics;
        
        // Update UI if needed
        const fileCountEl = document.getElementById('file-count');
        if (fileCountEl) {
            fileCountEl.textContent = `${metrics.totalFiles} files`;
        }
    },

    exists: function(path) {
        if (!path) return false;
        if (IDE.state.files && Object.prototype.hasOwnProperty.call(IDE.state.files, path)) {
            return true;
        }
        if (path.endsWith('/')) {
            return Object.keys(IDE.state.files).some((p) => p.startsWith(path));
        }
        return false;
    },
    
    // Enhanced file operations with transactions
    write: function(path, content, options = {}) {
        const oldContent = IDE.state.files[path];
        const isNewFile = !this.exists(path);
        
        // Create backup for undo
        if (!options.skipHistory && oldContent !== content) {
            this.addToHistory('write', path, oldContent, content);
        }
        
        IDE.state.files[path] = content;
        
        // Mark tab as dirty
        if (IDE.state.tabs.includes(path)) {
            IDE.state.dirtyTabs.add(path);
            this.updateTabDirtyState();
        }
        
        // Update outline if this is the active file
        if (IDE.state.activeTab === path) {
            this.updateOutline();
        }
        
        // Auto-save if enabled
        if (IDE.state.settings.editor.autoSave && !options.skipAutoSave) {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(() => this.save(), 1000);
        }
        
        // Update metrics
        this.updateFileSystemMetrics();
        
        // Event for external listeners
        this.emitFileChange(path, isNewFile ? 'created' : 'modified');
        
        return true;
    },
    
    // Enhanced read with caching
    read: function(path, useCache = true) {
        if (!this.exists(path)) {
            throw new Error(`File not found: ${path}`);
        }
        
        if (useCache && this.fileCache && this.fileCache[path]) {
            return this.fileCache[path];
        }
        
        const content = IDE.state.files[path] || '';
        
        // Cache for performance
        if (!this.fileCache) this.fileCache = {};
        this.fileCache[path] = content;
        
        return content;
    },
    
    // Enhanced delete with recycle bin
    delete: function(path, permanent = false) {
        if (!this.exists(path)) return false;
        
        if (!permanent && !confirm(`Move "${path}" to recycle bin?`)) {
            return false;
        }
        
        if (permanent && !confirm(`Permanently delete "${path}"? This cannot be undone.`)) {
            return false;
        }
        
        const content = this.read(path);
        
        // Add to recycle bin if not permanent
        if (!permanent) {
            this.addToRecycleBin(path, content);
        }
        
        // Add to history for undo
        this.addToHistory('delete', path, content, null);
        
        delete IDE.state.files[path];
        TabManager.close(path, true);
        IDE.state.dirtyTabs.delete(path);
        
        this.save();
        this.refreshTree();
        
        Utils.toast(`${permanent ? 'Permanently deleted' : 'Moved to recycle bin'}: ${path}`, 'warning');
        
        return true;
    },
    
    // Enhanced rename with conflict resolution
    rename: function(oldPath, newPath, options = {}) {
        if (oldPath === newPath) return true;
        
        const fileName = newPath.split('/').pop();
        if (!Utils.isValidFileName(fileName)) {
            Utils.toast('Invalid file name', 'error');
            return false;
        }
        
        if (this.exists(newPath)) {
            if (options.overwrite) {
                // Backup the overwritten file
                const overwrittenContent = this.read(newPath);
                this.addToHistory('overwrite', newPath, overwrittenContent, null);
                delete IDE.state.files[newPath];
            } else {
                Utils.toast('File already exists', 'error');
                return false;
            }
        }
        
        const content = this.read(oldPath);
        
        // Add to history
        this.addToHistory('rename', oldPath, content, newPath);
        
        delete IDE.state.files[oldPath];
        this.write(newPath, content, { skipHistory: true });
        
        // Update tabs
        const tabIndex = IDE.state.tabs.indexOf(oldPath);
        if (tabIndex > -1) {
            IDE.state.tabs[tabIndex] = newPath;
        }
        
        if (IDE.state.activeTab === oldPath) {
            IDE.state.activeTab = newPath;
        }
        
        // Update dirty tabs
        if (IDE.state.dirtyTabs.has(oldPath)) {
            IDE.state.dirtyTabs.delete(oldPath);
            IDE.state.dirtyTabs.add(newPath);
        }
        
        this.save();
        this.refreshTree();
        TabManager.render();
        
        Utils.toast(`Renamed to: ${newPath}`, 'success');
        return true;
    },
    
    // Enhanced file tree with virtual scrolling
    refreshTree: function() {
        const tree = document.getElementById('file-tree');
        if (!tree) return;
        
        // Clear existing content
        tree.innerHTML = '';
        
        // Show loading indicator for large file systems
        if (Object.keys(IDE.state.files).length > 1000) {
            tree.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim);">Loading file tree...</div>';
            
            // Use requestIdleCallback for large file systems
            requestIdleCallback(() => {
                this.renderFileTree(tree);
            }, { timeout: 1000 });
        } else {
            this.renderFileTree(tree);
        }
    },
    
    // Render file tree with virtualization
    renderFileTree: function(container) {
        const structure = this.buildFileStructure();
        this.renderNode(structure, container, 0, '');
        
        // Update outline if active tab exists
        if (IDE.state.activeTab) {
            this.updateOutline();
        }
    },
    
    // Build hierarchical file structure
    buildFileStructure: function() {
        const structure = {};
        
        Object.keys(IDE.state.files)
            .sort((a, b) => {
                // Sort directories first, then files
                const aIsDir = a.includes('/');
                const bIsDir = b.includes('/');
                if (aIsDir && !bIsDir) return -1;
                if (!aIsDir && bIsDir) return 1;
                return a.localeCompare(b);
            })
            .forEach(path => {
                const parts = path.split('/');
                let current = structure;
                
                parts.forEach((part, i) => {
                    if (!current[part]) {
                        current[part] = (i === parts.length - 1) 
                            ? { __file: true, path: path } 
                            : { __folder: true };
                    }
                    current = current[part];
                });
            });
        
        return structure;
    },
    
    // Render tree node recursively
    renderNode: function(node, container, level = 0, parentPath = '') {
        if (!node || typeof node !== 'object') return;
        
        const entries = Object.entries(node);
        if (entries.length === 0) return;
        
        // Sort: folders first, then files
        entries.sort(([aKey, aVal], [bKey, bVal]) => {
            const aIsFolder = aVal.__folder;
            const bIsFolder = bVal.__folder;
            
            if (aIsFolder && !bIsFolder) return -1;
            if (!aIsFolder && bIsFolder) return 1;
            return aKey.localeCompare(bKey);
        });
        
        for (const [name, data] of entries) {
            if (name === '__file' || name === '__folder' || name === 'path') continue;
            
            const currentPath = parentPath ? `${parentPath}/${name}` : name;
            const padding = 16 + (level * 20);
            
            if (data.__file) {
                // File item
                this.renderFileItem(name, data.path, padding, container);
            } else if (data.__folder) {
                // Folder item
                this.renderFolderItem(name, currentPath, padding, container, level, data);
            }
        }
    },
    
    // Render file item
    renderFileItem: function(name, path, padding, container) {
        const item = document.createElement('div');
        item.className = 't-item';
        item.dataset.path = path;
        
        const [iconClass, iconColor] = Utils.getFileIcon(name);
        const isDirty = IDE.state.dirtyTabs.has(path);
        const isActive = IDE.state.activeTab === path;
        
        item.innerHTML = `
            <div class="t-indent" style="padding-left:${padding}px">
                <i class="${iconClass}" style="color:${iconColor}"></i>
                <span style="margin-left:8px; flex:1;">${name}</span>
                ${isDirty ? '<span style="color:var(--primary); font-size:20px; margin-right:8px;"></span>' : ''}
                ${isActive ? '<span style="color:var(--primary); font-size:10px; margin-right:8px;"></span>' : ''}
            </div>
        `;
        
        item.onclick = (e) => {
            e.stopPropagation();
            if (e.ctrlKey || e.metaKey) {
                LayoutManager.openInSplit(path);
            } else {
                TabManager.open(path);
            }
        };
        
        item.oncontextmenu = (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.showContextMenu(e, path, 'file');
        };
        
        // Drag and drop support
        item.draggable = true;
        item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', path);
            e.dataTransfer.effectAllowed = 'move';
            item.style.opacity = '0.5';
        });
        
        item.addEventListener('dragend', () => {
            item.style.opacity = '1';
        });
        
        if (isActive) {
            item.classList.add('active');
        }
        
        container.appendChild(item);
    },
    
    // Render folder item
    renderFolderItem: function(name, path, padding, container, level, data) {
        const item = document.createElement('div');
        item.className = 't-item';
        item.dataset.folder = path;
        
        // Check if folder contains active file
        const hasActiveChild = IDE.state.activeTab && 
            IDE.state.activeTab.startsWith(path + '/');
        
        const isExpanded = hasActiveChild || 
            (localStorage.getItem(`folder_${path}`) === 'expanded');
        
        const folderIcon = isExpanded ? 'fa-folder-open' : 'fa-folder';
        
        item.innerHTML = `
            <div class="t-indent" style="padding-left:${padding}px">
                <i class="fas ${folderIcon}" style="color:#d97706"></i>
                <span style="margin-left:8px; flex:1;">${name}</span>
                <i class="fas fa-chevron-right" 
                   style="font-size:10px; transform: ${isExpanded ? 'rotate(90deg)' : 'rotate(0deg)'};
                          transition: transform 0.2s;"></i>
            </div>
        `;
        
        const subContainer = document.createElement('div');
        subContainer.className = `t-sub ${isExpanded ? '' : 'hidden'}`;
        
        item.onclick = (e) => {
            e.stopPropagation();
            this.toggleFolder(item, subContainer, path);
        };
        
        item.oncontextmenu = (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.showContextMenu(e, path + '/', 'folder');
        };
        
        // Drag and drop for folders
        item.draggable = true;
        item.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            item.style.background = 'var(--primary)20';
        });
        
        item.addEventListener('dragleave', () => {
            item.style.background = '';
        });
        
        item.addEventListener('drop', (e) => {
            e.preventDefault();
            item.style.background = '';
            const draggedPath = e.dataTransfer.getData('text/plain');
            if (draggedPath) {
                this.moveFile(draggedPath, path + '/' + draggedPath.split('/').pop());
            }
        });
        
        container.appendChild(item);
        container.appendChild(subContainer);
        
        // Recursively render children
        this.renderNode(data, subContainer, level + 1, path);
    },
    
    // Toggle folder expansion
    toggleFolder: function(folderElement, subContainer, path) {
        const wasHidden = subContainer.classList.contains('hidden');
        subContainer.classList.toggle('hidden');
        
        const folderIcon = folderElement.querySelector('.fa-folder, .fa-folder-open');
        const chevron = folderElement.querySelector('.fa-chevron-right');
        
        if (wasHidden) {
            folderIcon.className = 'fas fa-folder-open';
            chevron.style.transform = 'rotate(90deg)';
            localStorage.setItem(`folder_${path}`, 'expanded');
        } else {
            folderIcon.className = 'fas fa-folder';
            chevron.style.transform = 'rotate(0deg)';
            localStorage.setItem(`folder_${path}`, 'collapsed');
        }
    },
    
    // Enhanced context menu
    showContextMenu: function(event, path, type) {
        // Remove existing context menus
        document.querySelectorAll('.context-menu').forEach(el => el.remove());
        
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.style.left = event.clientX + 'px';
        menu.style.top = event.clientY + 'px';
        
        if (type === 'file') {
            this.renderFileContextMenu(menu, path);
        } else {
            this.renderFolderContextMenu(menu, path);
        }
        
        document.body.appendChild(menu);
        
        // Close menu when clicking outside
        setTimeout(() => {
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            document.addEventListener('click', closeMenu);
        }, 10);
    },
    
    // Render file context menu
    renderFileContextMenu: function(menu, path) {
        const fileName = path.split('/').pop();
        const ext = Utils.getExtension(path);
        
        this.addContextMenuItem(menu, 'fa-edit', 'Rename', () => {
            const newName = prompt('Enter new name:', fileName);
            if (newName && newName !== fileName) {
                const newPath = path.split('/').slice(0, -1).concat(newName).join('/');
                this.rename(path, newPath);
            }
        });
        
        this.addContextMenuItem(menu, 'fa-copy', 'Duplicate', () => {
            this.duplicateFile(path);
        });
        
        this.addContextMenuItem(menu, 'fa-clone', 'Clone to...', () => {
            const targetFolder = prompt('Enter target folder path (leave empty for current):', '');
            if (targetFolder !== null) {
                this.duplicateFile(path, targetFolder);
            }
        });
        
        this.addContextMenuItem(menu, 'fa-trash', 'Move to Recycle Bin', () => {
            this.delete(path, false);
        });
        
        menu.appendChild(document.createElement('div')).className = 'context-divider';
        
        this.addContextMenuItem(menu, 'fa-download', 'Download', () => {
            const content = this.read(path);
            Utils.downloadFile(fileName, content);
        });
        
        this.addContextMenuItem(menu, 'fa-external-link-alt', 'Open in New Tab', () => {
            const content = this.read(path);
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        });
        
        this.addContextMenuItem(menu, 'fa-share', 'Share...', () => {
            this.shareFile(path);
        });
        
        menu.appendChild(document.createElement('div')).className = 'context-divider';
        
        // File-specific actions
        if (ext === 'html' || ext === 'js' || ext === 'css') {
            this.addContextMenuItem(menu, 'fa-play', 'Run File', () => Runner.execute(path));
        }
        
        if (ext === 'md') {
            this.addContextMenuItem(menu, 'fa-eye', 'Preview Markdown', () => {
                this.previewMarkdown(path);
            });
        }
        
        this.addContextMenuItem(menu, 'fa-info-circle', 'Properties', () => {
            this.showFileProperties(path);
        });
    },
    
    // Render folder context menu
    renderFolderContextMenu: function(menu, path) {
        const folderName = path.split('/').filter(Boolean).pop() || 'Project';
        
        this.addContextMenuItem(menu, 'fa-folder-plus', 'New Folder', () => {
            const name = prompt('Enter folder name:');
            if (name) {
                this.createFolder(path + name);
            }
        });
        
        this.addContextMenuItem(menu, 'fa-file-medical', 'New File', () => {
            this.createFilePrompt(path);
        });
        
        this.addContextMenuItem(menu, 'fa-file-import', 'Import Files...', () => {
            this.importPrompt(path);
        });
        
        menu.appendChild(document.createElement('div')).className = 'context-divider';
        
        this.addContextMenuItem(menu, 'fa-trash', `Delete "${folderName}"`, () => {
            if (confirm(`Delete folder "${folderName}" and all contents?`)) {
                this.deleteFolder(path);
            }
        });
        
        this.addContextMenuItem(menu, 'fa-compress', 'Compress to ZIP', () => {
            this.compressFolder(path);
        });
        
        this.addContextMenuItem(menu, 'fa-search', 'Find in Folder...', () => {
            Search.findInFolder(path);
        });
    },
    
    // Add context menu item
    addContextMenuItem: function(menu, icon, text, action, disabled = false) {
        const item = document.createElement('div');
        item.className = `context-item ${disabled ? 'disabled' : ''}`;
        item.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
        
        if (!disabled) {
            item.onclick = () => {
                try {
                    action();
                } catch (error) {
                    Utils.toast(`Action failed: ${error.message}`, 'error');
                }
                menu.remove();
            };
        }
        
        menu.appendChild(item);
    },
    
    // Enhanced duplicate file
    duplicateFile: function(path, targetFolder = null) {
        const fileName = path.split('/').pop();
        const ext = Utils.getExtension(fileName);
        const baseName = fileName.substring(0, fileName.length - (ext ? ext.length + 1 : 0));
        
        let newPath = targetFolder ? 
            `${targetFolder}/${fileName}` : 
            path.split('/').slice(0, -1).concat(fileName).join('/');
        
        // Ensure unique name
        let counter = 1;
        while (this.exists(newPath)) {
            const newName = `${baseName}-copy${counter > 1 ? `-${counter}` : ''}.${ext}`;
            newPath = targetFolder ? 
                `${targetFolder}/${newName}` : 
                path.split('/').slice(0, -1).concat(newName).join('/');
            counter++;
        }
        
        this.write(newPath, this.read(path));
        this.refreshTree();
        TabManager.open(newPath);
        
        Utils.toast(`Duplicated to: ${newPath}`, 'success');
    },
    
    // Create folder
    createFolder: function(path) {
        if (!path.endsWith('/')) path += '/';
        
        // Create a .keep file to mark folder
        const keepPath = path + '.keep';
        this.write(keepPath, '# Folder placeholder\n# This file ensures the folder is visible in the file tree');
        
        this.refreshTree();
        Utils.toast(`Created folder: ${path}`, 'success');
    },
    
    // Delete folder
    deleteFolder: function(path) {
        if (!path.endsWith('/')) path += '/';
        
        // Get all files in folder
        const filesToDelete = Object.keys(IDE.state.files).filter(f => f.startsWith(path));
        
        // Move to recycle bin
        filesToDelete.forEach(filePath => {
            this.addToRecycleBin(filePath, this.read(filePath));
            delete IDE.state.files[filePath];
        });
        
        this.save();
        this.refreshTree();
        Utils.toast(`Deleted folder: ${path} (${filesToDelete.length} files)`, 'warning');
    },
    
    // Compress folder to ZIP
    compressFolder: async function(path) {
        try {
            const zip = new JSZip();
            const folderName = path.split('/').filter(Boolean).pop() || 'archive';
            
            // Add all files in folder
            const folderFiles = Object.keys(IDE.state.files).filter(f => f.startsWith(path));
            
            for (const filePath of folderFiles) {
                const relativePath = filePath.substring(path.length);
                const content = this.read(filePath);
                zip.file(relativePath, content);
            }
            
            // Generate and download
            const blob = await zip.generateAsync({ type: "blob" });
            saveAs(blob, `${folderName}-${new Date().toISOString().split('T')[0]}.zip`);
            
            Utils.toast("Folder compressed successfully!", "success");
        } catch (error) {
            Utils.toast("Compression failed: " + error.message, "error");
        }
    },
    
    // Share file
    shareFile: function(path) {
        if (navigator.share) {
            const content = this.read(path);
            const blob = new Blob([content], { type: 'text/plain' });
            const file = new File([blob], path.split('/').pop(), { type: 'text/plain' });
            
            navigator.share({
                title: `Share ${path}`,
                text: 'Check out this file from ProCode IDE',
                files: [file]
            }).catch(error => {
                if (error.name !== 'AbortError') {
                    Utils.toast('Share failed: ' + error.message, 'error');
                }
            });
        } else {
            Utils.toast('Web Share API not supported in this browser', 'info');
        }
    },
    
    // Preview markdown
    previewMarkdown: function(path) {
        const content = this.read(path);
        const html = marked.parse(content);
        
        const preview = window.open('', '_blank');
        preview.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>${path} - Markdown Preview</title>
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
                <style>
                    .markdown-body { box-sizing: border-box; min-width: 200px; max-width: 980px; margin: 0 auto; padding: 45px; }
                    @media (max-width: 767px) { .markdown-body { padding: 15px; } }
                </style>
            </head>
            <body class="markdown-body">
                ${html}
            </body>
            </html>
        `);
        preview.document.close();
    },
    
    // Show file properties
    showFileProperties: function(path) {
        const content = this.read(path);
        const stats = {
            path: path,
            name: path.split('/').pop(),
            size: Utils.formatBytes(new Blob([content]).size),
            lines: content.split('\n').length,
            words: content.split(/\s+/).filter(w => w.length > 0).length,
            characters: content.length,
            created: localStorage.getItem(`file_created_${path}`) || 'Unknown',
            modified: localStorage.getItem(`file_modified_${path}`) || 'Unknown',
            type: Utils.getFileTypeCategory(path),
            encoding: 'UTF-8'
        };
        
        const modal = `
            <div class="modal-overlay" id="properties-modal">
                <div class="modal" style="width:500px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-info-circle"></i> Properties: ${stats.name}</h3>
                        <button class="btn icon small" onclick="document.getElementById('properties-modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <table style="width:100%; font-size:13px;">
                            ${Object.entries(stats).map(([key, value]) => `
                                <tr>
                                    <td style="padding:8px; color:var(--text-dim); font-weight:500;">${Utils.capitalize(key)}</td>
                                    <td style="padding:8px;">${value}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="document.getElementById('properties-modal').remove()">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
    },
    
    // Enhanced import with folder selection
    importPrompt: function(targetFolder = '') {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.zip,.js,.jsx,.ts,.tsx,.html,.css,.py,.md,.json,.txt,.vue,.svelte';
        input.multiple = true;
        input.webkitdirectory = true;
        input.directory = true;
        
        input.onchange = async (event) => {
            const files = Array.from(event.target.files);
            let importedCount = 0;
            let skippedCount = 0;
            
            for (const file of files) {
                const filePath = targetFolder ? 
                    `${targetFolder}/${file.webkitRelativePath || file.name}` : 
                    file.name;
                
                if (this.exists(filePath) && !confirm(`Overwrite "${filePath}"?`)) {
                    skippedCount++;
                    continue;
                }
                
                if (file.name.endsWith('.zip')) {
                    try {
                        const zip = await JSZip.loadAsync(file);
                        
                        for (const [path, entry] of Object.entries(zip.files)) {
                            if (!entry.dir) {
                                const content = await entry.async("string");
                                const fullPath = targetFolder ? `${targetFolder}/${path}` : path;
                                IDE.state.files[fullPath] = content;
                                importedCount++;
                            }
                        }
                        
                        Utils.toast(`Imported ZIP: ${file.name}`, 'success');
                    } catch (error) {
                        Utils.toast(`Failed to import ZIP: ${error.message}`, 'error');
                    }
                } else {
                    try {
                        const content = await Utils.readFile(file);
                        IDE.state.files[filePath] = content;
                        importedCount++;
                        
                        // Record creation time
                        localStorage.setItem(`file_created_${filePath}`, new Date().toISOString());
                    } catch (error) {
                        Utils.toast(`Failed to import ${file.name}: ${error.message}`, 'error');
                    }
                }
            }
            
            if (importedCount > 0) {
                this.save();
                this.refreshTree();
                Utils.toast(`Imported ${importedCount} file(s)${skippedCount > 0 ? `, skipped ${skippedCount}` : ''}`, 'success');
            }
        };
        
        input.click();
    },
    
    // Enhanced export with options
    exportZip: async function(options = {}) {
        try {
            const zip = new JSZip();
            const date = new Date().toISOString().split('T')[0];
            const projectName = options.name || `procode-project-${date}`;
            
            // Add all files (excluding .keep files)
            for (const [path, content] of Object.entries(IDE.state.files)) {
                if (!path.endsWith('.keep')) {
                    zip.file(path, content);
                }
            }
            
            // Add project metadata
            const metadata = {
                name: projectName,
                version: '1.0.0',
                created: date,
                ideVersion: IDE.version,
                fileCount: Object.keys(IDE.state.files).length,
                settings: IDE.state.settings
            };
            
            zip.file('PROJECT.json', JSON.stringify(metadata, null, 2));
            
            // Generate and download
            const blob = await zip.generateAsync({ 
                type: "blob",
                compression: options.compression ? "DEFLATE" : "STORE"
            });
            
            saveAs(blob, `${projectName}.zip`);
            Utils.toast("Project exported successfully!", "success");
        } catch (error) {
            Utils.toast("Export failed: " + error.message, "error");
        }
    },
    
    // Move file
    moveFile: function(oldPath, newPath) {
        if (oldPath === newPath) return true;
        
        if (this.exists(newPath)) {
            if (!confirm(`Overwrite "${newPath}"?`)) {
                return false;
            }
        }
        
        const content = this.read(oldPath);
        delete IDE.state.files[oldPath];
        this.write(newPath, content);
        
        // Update tabs
        const tabIndex = IDE.state.tabs.indexOf(oldPath);
        if (tabIndex > -1) {
            IDE.state.tabs[tabIndex] = newPath;
        }
        
        if (IDE.state.activeTab === oldPath) {
            IDE.state.activeTab = newPath;
        }
        
        this.save();
        this.refreshTree();
        TabManager.render();
        
        Utils.toast(`Moved to: ${newPath}`, 'success');
        return true;
    },
    
    // Find in folder
    findInFolder: function(folderPath, query, options = {}) {
        const results = [];
        const regex = new RegExp(
            options.wholeWord ? `\\b${query}\\b` : query,
            options.caseSensitive ? 'g' : 'gi'
        );
        
        const files = Object.keys(IDE.state.files).filter(f => 
            f.startsWith(folderPath) && 
            (!options.fileTypes || options.fileTypes.includes(Utils.getExtension(f)))
        );
        
        for (const path of files) {
            const content = this.read(path);
            const lines = content.split('\n');
            
            lines.forEach((line, index) => {
                const matches = line.match(regex);
                if (matches) {
                    results.push({
                        path: path,
                        line: index + 1,
                        content: line.trim(),
                        matches: matches.length
                    });
                }
            });
        }
        
        return results;
    },
    
    // Enhanced search in files
    findInFiles: function(query, options = {}) {
        const results = [];
        const regex = new RegExp(
            options.regex ? query : (options.wholeWord ? `\\b${query}\\b` : query),
            options.caseSensitive ? 'g' : 'gi'
        );
        
        for (const [path, content] of Object.entries(IDE.state.files)) {
            // Skip if file type filter is set and doesn't match
            if (options.fileTypes && !options.fileTypes.includes(Utils.getExtension(path))) {
                continue;
            }
            
            // Skip if path filter is set and doesn't match
            if (options.pathFilter && !path.includes(options.pathFilter)) {
                continue;
            }
            
            const lines = content.split('\n');
            
            lines.forEach((line, index) => {
                const matches = line.match(regex);
                if (matches) {
                    results.push({
                        path: path,
                        line: index + 1,
                        content: line.trim(),
                        matches: matches.length,
                        context: lines.slice(Math.max(0, index - 2), Math.min(lines.length, index + 3))
                    });
                }
            });
        }
        
        // Sort results
        if (options.sortBy === 'path') {
            results.sort((a, b) => a.path.localeCompare(b.path));
        } else if (options.sortBy === 'line') {
            results.sort((a, b) => a.line - b.line);
        }
        
        return results;
    },
    
    // Replace in files
    replaceInFiles: function(find, replace, options = {}) {
        let replacedCount = 0;
        let fileCount = 0;
        
        for (const [path, content] of Object.entries(IDE.state.files)) {
            // Apply filters
            if (options.fileTypes && !options.fileTypes.includes(Utils.getExtension(path))) {
                continue;
            }
            
            if (options.pathFilter && !path.includes(options.pathFilter)) {
                continue;
            }
            
            const regex = new RegExp(
                options.regex ? find : (options.wholeWord ? `\\b${find}\\b` : find),
                options.caseSensitive ? 'g' : 'gi'
            );
            
            if (regex.test(content)) {
                const newContent = content.replace(regex, replace);
                this.write(path, newContent);
                
                const matches = (content.match(regex) || []).length;
                replacedCount += matches;
                fileCount++;
            }
        }
        
        return { replacedCount, fileCount };
    },
    
    // File history for undo/redo
    fileHistory: {
        past: [],
        future: [],
        maxSize: 100
    },
    
    // Add to history
    addToHistory: function(action, path, oldValue, newValue) {
        const historyItem = {
            action,
            path,
            oldValue,
            newValue,
            timestamp: new Date().toISOString()
        };
        
        this.fileHistory.past.push(historyItem);
        
        // Trim history if too large
        if (this.fileHistory.past.length > this.fileHistory.maxSize) {
            this.fileHistory.past.shift();
        }
        
        // Clear future when new action is performed
        this.fileHistory.future = [];
    },
    
    // Undo last action
    undo: function() {
        if (this.fileHistory.past.length === 0) {
            Utils.toast('Nothing to undo', 'info');
            return false;
        }
        
        const historyItem = this.fileHistory.past.pop();
        this.fileHistory.future.push(historyItem);
        
        switch (historyItem.action) {
            case 'write':
                IDE.state.files[historyItem.path] = historyItem.oldValue;
                break;
            case 'delete':
                IDE.state.files[historyItem.path] = historyItem.oldValue;
                break;
            case 'rename':
                // Swap old and new paths
                delete IDE.state.files[historyItem.newValue];
                IDE.state.files[historyItem.path] = historyItem.oldValue;
                break;
        }
        
        this.refreshTree();
        this.save();
        
        Utils.toast('Undo: ' + historyItem.action, 'success');
        return true;
    },
    
    // Redo last undone action
    redo: function() {
        if (this.fileHistory.future.length === 0) {
            Utils.toast('Nothing to redo', 'info');
            return false;
        }
        
        const historyItem = this.fileHistory.future.pop();
        this.fileHistory.past.push(historyItem);
        
        switch (historyItem.action) {
            case 'write':
                IDE.state.files[historyItem.path] = historyItem.newValue;
                break;
            case 'delete':
                delete IDE.state.files[historyItem.path];
                break;
            case 'rename':
                delete IDE.state.files[historyItem.path];
                IDE.state.files[historyItem.newValue] = historyItem.oldValue;
                break;
        }
        
        this.refreshTree();
        this.save();
        
        Utils.toast('Redo: ' + historyItem.action, 'success');
        return true;
    },
    
    // Recycle bin functionality
    recycleBin: [],
    
    // Add to recycle bin
    addToRecycleBin: function(path, content) {
        this.recycleBin.push({
            path,
            content,
            deletedAt: new Date().toISOString(),
            originalPath: path
        });
        
        // Keep only last 100 items
        if (this.recycleBin.length > 100) {
            this.recycleBin.shift();
        }
        
        localStorage.setItem('procode_recycle_bin', JSON.stringify(this.recycleBin));
    },
    
    // Show recycle bin
    showRecycleBin: function() {
        const modal = `
            <div class="modal-overlay" id="recycle-bin-modal">
                <div class="modal" style="width:700px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-trash-restore"></i> Recycle Bin</h3>
                        <button class="btn icon small" onclick="document.getElementById('recycle-bin-modal').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        ${this.recycleBin.length === 0 ? 
                            '<p style="text-align:center; color:var(--text-dim); padding:40px;">Recycle bin is empty</p>' :
                            `<div style="max-height:400px; overflow-y:auto;">
                                ${this.recycleBin.map((item, index) => `
                                    <div class="flex ac jb" style="padding:12px; border-bottom:1px solid var(--border);">
                                        <div>
                                            <div style="font-weight:500;">${item.path}</div>
                                            <div style="font-size:11px; color:var(--text-dim);">
                                                Deleted ${Utils.formatDate(item.deletedAt)}
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button class="btn small" onclick="FileSystem.restoreFromRecycleBin(${index})">
                                                <i class="fas fa-undo"></i> Restore
                                            </button>
                                            <button class="btn small danger" onclick="FileSystem.emptyRecycleBinItem(${index})">
                                                <i class="fas fa-times"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="document.getElementById('recycle-bin-modal').remove()">Close</button>
                        ${this.recycleBin.length > 0 ? `
                            <button class="btn danger" onclick="FileSystem.emptyRecycleBin()">
                                <i class="fas fa-trash"></i> Empty Recycle Bin
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
    },
    
    // Restore from recycle bin
    restoreFromRecycleBin: function(index) {
        const item = this.recycleBin[index];
        if (!item) return;
        
        // Check if file already exists
        if (this.exists(item.path)) {
            const newName = prompt('File already exists. Enter new name:', item.path);
            if (!newName) return;
            item.path = newName;
        }
        
        this.write(item.path, item.content);
        this.recycleBin.splice(index, 1);
        localStorage.setItem('procode_recycle_bin', JSON.stringify(this.recycleBin));
        
        // Refresh modal
        document.getElementById('recycle-bin-modal').remove();
        this.showRecycleBin();
        
        Utils.toast(`Restored: ${item.path}`, 'success');
    },
    
    // Empty recycle bin item
    emptyRecycleBinItem: function(index) {
        if (confirm('Permanently delete this file?')) {
            this.recycleBin.splice(index, 1);
            localStorage.setItem('procode_recycle_bin', JSON.stringify(this.recycleBin));
            
            document.getElementById('recycle-bin-modal').remove();
            this.showRecycleBin();
            
            Utils.toast('Permanently deleted', 'warning');
        }
    },
    
    // Empty entire recycle bin
    emptyRecycleBin: function() {
        if (confirm('Permanently delete all files in recycle bin?')) {
            this.recycleBin = [];
            localStorage.removeItem('procode_recycle_bin');
            
            document.getElementById('recycle-bin-modal').remove();
            this.showRecycleBin();
            
            Utils.toast('Recycle bin emptied', 'warning');
        }
    },
    
    // Enhanced outline extraction with caching
    updateOutline: function() {
        const outline = document.getElementById('outline-tree');
        if (!outline || !IDE.state.activeTab) {
            outline.innerHTML = '<div style="padding:16px; color:var(--text-dim); font-size:12px; text-align:center;">No outline available</div>';
            return;
        }
        
        const path = IDE.state.activeTab;
        const content = this.read(path);
        const ext = Utils.getExtension(path);
        
        // Use cached outline if available and content hasn't changed
        const cacheKey = `outline_${path}_${Utils.hashString(content)}`;
        const cachedOutline = localStorage.getItem(cacheKey);
        
        if (cachedOutline) {
            outline.innerHTML = cachedOutline;
            return;
        }
        
        outline.innerHTML = '';
        
        // Extract outline based on file type
        let outlineItems = [];
        
        switch (ext) {
            case 'js':
            case 'jsx':
            case 'ts':
            case 'tsx':
                outlineItems = this.extractJsOutline(content);
                break;
            case 'html':
                outlineItems = this.extractHtmlOutline(content);
                break;
            case 'css':
            case 'scss':
            case 'sass':
            case 'less':
                outlineItems = this.extractCssOutline(content);
                break;
            case 'py':
                outlineItems = this.extractPythonOutline(content);
                break;
            case 'vue':
                outlineItems = this.extractVueOutline(content);
                break;
            default:
                outline.innerHTML = '<div style="padding:16px; color:var(--text-dim); font-size:12px; text-align:center;">Outline not supported for this file type</div>';
                return;
        }
        
        if (outlineItems.length === 0) {
            outline.innerHTML = '<div style="padding:16px; color:var(--text-dim); font-size:12px; text-align:center;">No symbols found</div>';
            return;
        }
        
        // Render outline items
        outlineItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 't-item';
            div.style.padding = '4px 8px';
            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px; padding:4px 8px;">
                    <i class="${item.icon}" style="color:${item.color || 'var(--primary)'}; font-size:11px;"></i>
                    <span style="font-size:11px; flex:1;">${item.name}</span>
                    <span style="font-size:10px; color:var(--text-dim);">${item.line}</span>
                </div>
            `;
            
            div.onclick = () => {
                const editor = EditorManager.getCurrentEditor();
                if (editor) {
                    editor.revealLineInCenter(item.line);
                    editor.setPosition({ lineNumber: item.line, column: 1 });
                    editor.focus();
                }
            };
            
            outline.appendChild(div);
        });
        
        // Cache the outline
        localStorage.setItem(cacheKey, outline.innerHTML);
    },
    
    // Extract Vue component outline
    extractVueOutline: function(content) {
        const items = [];
        const lines = content.split('\n');
        
        // Extract template tags
        let inTemplate = false;
        lines.forEach((line, index) => {
            if (line.includes('<template>')) inTemplate = true;
            if (line.includes('</template>')) inTemplate = false;
            
            if (inTemplate) {
                const tagMatch = line.match(/<(\w+)[^>]*>/);
                if (tagMatch) {
                    items.push({
                        type: 'tag',
                        name: tagMatch[1],
                        line: index + 1,
                        icon: 'fab fa-vuejs',
                        color: '#42b883'
                    });
                }
            }
        });
        
        // Extract script components
        lines.forEach((line, index) => {
            // Look for component definitions
            const componentMatch = line.match(/export\s+default\s+{\s*name:\s*['"]([^'"]+)['"]/);
            if (componentMatch) {
                items.push({
                    type: 'component',
                    name: componentMatch[1],
                    line: index + 1,
                    icon: 'fas fa-cube',
                    color: '#35495e'
                });
            }
            
            // Look for methods
            const methodMatch = line.match(/(\w+)\s*\([^)]*\)\s*{/);
            if (methodMatch && line.includes('methods:')) {
                items.push({
                    type: 'method',
                    name: methodMatch[1],
                    line: index + 1,
                    icon: 'fas fa-function',
                    color: '#61dafb'
                });
            }
        });
        
        return items;
    },
    
    // Enhanced JavaScript/TypeScript outline
    extractJsOutline: function(content) {
        const items = [];
        const lines = content.split('\n');
        
        lines.forEach((line, index) => {
            const trimmed = line.trim();
            
            // Function declarations
            const funcMatch = trimmed.match(/^(export\s+)?(async\s+)?(function\s+(\w+)|(const|let|var)\s+(\w+)\s*=\s*(async\s+)?\([^)]*\)\s*=>|class\s+(\w+))/);
            if (funcMatch) {
                const name = funcMatch[4] || funcMatch[6] || funcMatch[8];
                const isClass = !!funcMatch[7];
                const isAsync = trimmed.includes('async');
                
                items.push({
                    type: isClass ? 'class' : 'function',
                    name: name,
                    line: index + 1,
                    icon: isClass ? 'fas fa-cube' : (isAsync ? 'fas fa-bolt' : 'fas fa-function'),
                    color: isClass ? '#f59e0b' : (isAsync ? '#8b5cf6' : '#61dafb')
                });
            }
            
            // React components
            const reactMatch = trimmed.match(/export\s+default\s+(function\s+(\w+)|(const|let|var)\s+(\w+)\s*=|class\s+(\w+))/);
            if (reactMatch) {
                const name = reactMatch[2] || reactMatch[4] || reactMatch[5];
                items.push({
                    type: 'component',
                    name: name,
                    line: index + 1,
                    icon: 'fab fa-react',
                    color: '#61dafb'
                });
            }
            
            // Imports
            const importMatch = trimmed.match(/^import\s+(.*?)\s+from/);
            if (importMatch) {
                items.push({
                    type: 'import',
                    name: importMatch[1],
                    line: index + 1,
                    icon: 'fas fa-download',
                    color: '#10b981'
                });
            }
            
            // Exports
            const exportMatch = trimmed.match(/^export\s+(const|let|var|function|class|default)\s+(\w+)/);
            if (exportMatch) {
                items.push({
                    type: 'export',
                    name: exportMatch[2],
                    line: index + 1,
                    icon: 'fas fa-upload',
                    color: '#f59e0b'
                });
            }
        });
        
        return items;
    },
    
    // Enhanced HTML outline
    extractHtmlOutline: function(content) {
        const items = [];
        const tagRegex = /<(\w+)[^>]*>/g;
        let match;
        
        const lines = content.split('\n');
        
        lines.forEach((line, index) => {
            while ((match = tagRegex.exec(line)) !== null) {
                const tag = match[1];
                const idMatch = match[0].match(/id="([^"]*)"/);
                const classMatch = match[0].match(/class="([^"]*)"/);
                
                let name = tag;
                if (idMatch) name = `#${idMatch[1]}`;
                else if (classMatch) name = `.${classMatch[1].split(' ')[0]}`;
                
                items.push({
                    type: 'element',
                    name: name,
                    line: index + 1,
                    icon: 'fab fa-html5',
                    color: '#e34c26'
                });
            }
        });
        
        return items;
    },
    
    // Enhanced CSS outline
    extractCssOutline: function(content) {
        const items = [];
        const lines = content.split('\n');
        
        lines.forEach((line, index) => {
            const trimmed = line.trim();
            
            // Selectors
            if (trimmed.endsWith('{') && !trimmed.startsWith('@')) {
                const selector = trimmed.slice(0, -1).trim();
                items.push({
                    type: 'selector',
                    name: selector,
                    line: index + 1,
                    icon: 'fab fa-css3',
                    color: '#264de4'
                });
            }
            
            // At-rules
            const atRuleMatch = trimmed.match(/^@(\w+)/);
            if (atRuleMatch) {
                items.push({
                    type: 'at-rule',
                    name: trimmed,
                    line: index + 1,
                    icon: 'fas fa-at',
                    color: '#8b5cf6'
                });
            }
        });
        
        return items;
    },
    
    // Enhanced Python outline
    extractPythonOutline: function(content) {
        const items = [];
        const lines = content.split('\n');
        
        lines.forEach((line, index) => {
            const trimmed = line.trim();
            
            // Function definitions
            const funcMatch = trimmed.match(/^def\s+(\w+)\s*\(/);
            if (funcMatch) {
                items.push({
                    type: 'function',
                    name: funcMatch[1],
                    line: index + 1,
                    icon: 'fas fa-function',
                    color: '#3776ab'
                });
            }
            
            // Class definitions
            const classMatch = trimmed.match(/^class\s+(\w+)/);
            if (classMatch) {
                items.push({
                    type: 'class',
                    name: classMatch[1],
                    line: index + 1,
                    icon: 'fas fa-cube',
                    color: '#f59e0b'
                });
            }
            
            // Imports
            const importMatch = trimmed.match(/^import\s+(\w+)|^from\s+(\w+)\s+import/);
            if (importMatch) {
                items.push({
                    type: 'import',
                    name: importMatch[1] || importMatch[2],
                    line: index + 1,
                    icon: 'fas fa-download',
                    color: '#10b981'
                });
            }
        });
        
        return items;
    },
    
    // Update tab dirty state
    updateTabDirtyState: function() {
        document.querySelectorAll('.tab').forEach(tab => {
            const path = tab.dataset.path;
            if (IDE.state.dirtyTabs.has(path)) {
                tab.classList.add('dirty');
            } else {
                tab.classList.remove('dirty');
            }
        });
    },
    
    // Enhanced create file prompt
    createFilePrompt: function(basePath = '') {
        const defaultPath = basePath || (IDE.state.activeTab ? 
            IDE.state.activeTab.split('/').slice(0, -1).join('/') + '/' : '');
        
        const fileName = prompt('Enter file name (with extension):', defaultPath + 'new-file.js');
        if (!fileName) return;
        
        if (!Utils.isValidFileName(fileName.split('/').pop())) {
            Utils.toast('Invalid file name', 'error');
            return;
        }
        
        const ext = Utils.getExtension(fileName);
        let content = '';
        
        // Enhanced default content based on file type
        const templates = {
            'js': `// ${fileName}
console.log(' Hello from ProCode IDE v15.0!');

// Your JavaScript code here
function greet(name) {
  return \`Hello, \${name}!\`;
}

// Example usage
console.log(greet('World'));

// Export if needed
export { greet };`,
            
            'ts': `// ${fileName}
console.log(' Hello from ProCode IDE v15.0!');

// TypeScript interface
interface User {
  id: number;
  name: string;
  email: string;
}

// Your TypeScript code here
function greet(user: User): string {
  return \`Hello, \${user.name}!\`;
}

// Example usage
const user: User = { id: 1, name: 'World', email: 'world@example.com' };
console.log(greet(user));

// Export if needed
export { greet, User };`,
            
            'jsx': `import React from 'react';

export default function ${fileName.replace('.jsx', '').split('/').pop()}() {
  return (
    <div>
      <h1>${fileName.replace('.jsx', '').split('/').pop()}</h1>
      <p>Your React component here</p>
    </div>
  );
}`,
            
            'tsx': `import React from 'react';

interface Props {
  // Define your props here
}

export default function ${fileName.replace('.tsx', '').split('/').pop()}({}: Props) {
  return (
    <div>
      <h1>${fileName.replace('.tsx', '').split('/').pop()}</h1>
      <p>Your React component with TypeScript here</p>
    </div>
  );
}`,
            
            'html': `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${fileName.replace('.html', '')}</title>
    <link rel="stylesheet" href="style.css">
    <script src="app.js" defer><\/script>
</head>
<body>
    <h1>Welcome to ${fileName.replace('.html', '')}</h1>
    <p>Start building your amazing web application!</p>
</body>
</html>`,
            
            'css': `/* ${fileName} */
:root {
  --primary: #6366f1;
  --secondary: #8b5cf6;
  --background: #f8fafc;
  --text: #1e293b;
  --radius: 12px;
  --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: system-ui, -apple-system, sans-serif;
  background: var(--background);
  color: var(--text);
  line-height: 1.6;
}

/* Your styles here */`,
            
            'py': `#!/usr/bin/env python3
"""
${fileName}
ProCode IDE - Python File
"""

import sys
import os

def main() -> int:
    """
    Main function
    """
    print(" Hello from Python!")
    print(f"File: {os.path.basename(__file__)}")
    return 0

if __name__ == "__main__":
    sys.exit(main())`,
            
            'vue': `<template>
  <div>
    <h1>${fileName.replace('.vue', '')}</h1>
    <p>Your Vue component here</p>
  </div>
</template>

<script setup>
// Your Vue 3 composition API code here
const message = 'Hello from Vue 3!'
<\/script>

<style scoped>
/* Your component styles here */
</style>`
        };
        
        content = templates[ext] || `// ${fileName}
// Created with ProCode IDE v15.0
// Start writing your code here...`;
        
        this.write(fileName, content);
        this.refreshTree();
        TabManager.open(fileName);
        
        Utils.toast(`Created: ${fileName}`, 'success');
    },
    
    // Enhanced create folder prompt
    createFolderPrompt: function(basePath = '') {
        const folderName = prompt('Enter folder name:', basePath);
        if (!folderName) return;
        
        if (!Utils.isValidFileName(folderName)) {
            Utils.toast('Invalid folder name', 'error');
            return;
        }
        
        this.createFolder(folderName);
    },
    
    // Emit file change event
    emitFileChange: function(path, type) {
        const event = new CustomEvent('filechange', {
            detail: { path, type, timestamp: new Date().toISOString() }
        });
        window.dispatchEvent(event);
    },
    
    // Initialize file system event listeners
    initEventListeners: function() {
        window.addEventListener('filechange', (e) => {
            // Update UI or trigger actions based on file changes
            console.log('File changed:', e.detail);
        });
    }
};

// Initialize event listeners
FileSystem.initEventListeners();

// ============================================
// ENHANCED EDITOR MANAGER
// ============================================
const EditorManager = {
    instances: {},
    currentEditorId: 'monaco-root-1',
    diagnostics: new Map(),
    codeLenses: new Map(),
    
    init: async function() {
        console.log(' Initializing Enhanced Editor Manager');
        
        return new Promise((resolve) => {
            require.config({ 
                paths: { 
                    'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' 
                } 
            });
            
            require(['vs/editor/editor.main'], () => {
                this.defineEnhancedThemes();
                this.createEditor('monaco-root-1');
                this.applySettings();
                this.setupEnhancedEventListeners();
                this.setupCodeLens();
                this.setupDiagnostics();
                
                resolve();
            });
        });
    },
    
    defineEnhancedThemes: function() {
        // ProCode Dark Pro Theme
        monaco.editor.defineTheme('procode-dark-pro', {
            base: 'vs-dark',
            inherit: true,
            rules: [
                { token: 'keyword', foreground: '#c586c0', fontStyle: 'bold' },
                { token: 'string', foreground: '#ce9178' },
                { token: 'number', foreground: '#b5cea8' },
                { token: 'comment', foreground: '#6a9955' },
                { token: 'type', foreground: '#4ec9b0' },
                { token: 'function', foreground: '#dcdcaa' },
                { token: 'variable', foreground: '#9cdcfe' },
                { token: 'parameter', foreground: '#9cdcfe', fontStyle: 'italic' },
                { token: 'property', foreground: '#9cdcfe' },
                { token: 'namespace', foreground: '#4ec9b0' },
                { token: 'tag', foreground: '#569cd6' },
                { token: 'attribute', foreground: '#9cdcfe' },
                { token: 'operator', foreground: '#d4d4d4' },
                { token: 'meta', foreground: '#d16969' },
                { token: 'regexp', foreground: '#d16969' }
            ],
            colors: {
                'editor.background': '#09090b',
                'editor.foreground': '#e4e4e7',
                'editorCursor.foreground': '#6366f1',
                'editor.lineHighlightBackground': '#18181b',
                'editorLineNumber.foreground': '#71717a',
                'editorLineNumber.activeForeground': '#a1a1aa',
                'editor.selectionBackground': '#3f3f4680',
                'editor.inactiveSelectionBackground': '#3f3f4640',
                'editor.wordHighlightBackground': '#3f3f4680',
                'editor.wordHighlightStrongBackground': '#3f3f4660',
                'editor.findMatchBackground': '#f59e0b40',
                'editor.findMatchHighlightBackground': '#f59e0b20',
                'editorBracketMatch.background': '#3f3f46',
                'editorBracketMatch.border': '#71717a',
                'editorIndentGuide.background': '#27272a',
                'editorIndentGuide.activeBackground': '#3f3f46',
                'editorRuler.foreground': '#27272a',
                'editorOverviewRuler.border': '#27272a',
                'editorOverviewRuler.findMatchForeground': '#f59e0b',
                'editorOverviewRuler.errorForeground': '#ef4444',
                'editorOverviewRuler.warningForeground': '#f59e0b',
                'editorOverviewRuler.infoForeground': '#3b82f6',
                'editorError.foreground': '#ef4444',
                'editorWarning.foreground': '#f59e0b',
                'editorInfo.foreground': '#3b82f6',
                'editorGutter.background': '#09090b',
                'editorGutter.modifiedBackground': '#3b82f6',
                'editorGutter.addedBackground': '#22c55e',
                'editorGutter.deletedBackground': '#ef4444'
            }
        });
        
        // ProCode Light Pro Theme
        monaco.editor.defineTheme('procode-light-pro', {
            base: 'vs',
            inherit: true,
            rules: [
                { token: 'keyword', foreground: '#0000ff', fontStyle: 'bold' },
                { token: 'string', foreground: '#a31515' },
                { token: 'number', foreground: '#098658' },
                { token: 'comment', foreground: '#008000' },
                { token: 'type', foreground: '#267f99' },
                { token: 'function', foreground: '#795e26' },
                { token: 'variable', foreground: '#001080' }
            ],
            colors: {
                'editor.background': '#ffffff',
                'editor.foreground': '#1e293b',
                'editorCursor.foreground': '#6366f1',
                'editor.lineHighlightBackground': '#f8fafc',
                'editorLineNumber.foreground': '#94a3b8',
                'editor.selectionBackground': '#e2e8f080',
                'editor.findMatchBackground': '#f59e0b40',
                'editorBracketMatch.background': '#e2e8f0'
            }
        });
        
        // ProCode Night Theme
        monaco.editor.defineTheme('procode-night', {
            base: 'vs-dark',
            inherit: true,
            rules: [
                { token: 'keyword', foreground: '#ff79c6' },
                { token: 'string', foreground: '#f1fa8c' },
                { token: 'number', foreground: '#bd93f9' },
                { token: 'comment', foreground: '#6272a4' },
                { token: 'type', foreground: '#8be9fd' }
            ],
            colors: {
                'editor.background': '#0a0a12',
                'editor.foreground': '#f8f8f2',
                'editorCursor.foreground': '#ff79c6'
            }
        });
    },
    
    createEditor: function(containerId) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.error(`Container ${containerId} not found`);
            return null;
        }
        
        if (this.instances[containerId]) {
            return this.instances[containerId];
        }
        
        const editor = monaco.editor.create(container, {
            value: "",
            language: 'javascript',
            theme: IDE.state.settings.editor.theme,
            fontSize: IDE.state.settings.editor.fontSize,
            fontFamily: IDE.state.settings.editor.fontFamily,
            minimap: {
                enabled: IDE.state.settings.editor.minimap,
                scale: 2,
                renderCharacters: false,
                showSlider: 'always'
            },
            scrollBeyondLastLine: false,
            wordWrap: IDE.state.settings.editor.wordWrap ? 'on' : 'off',
            tabSize: IDE.state.settings.editor.tabSize,
            insertSpaces: true,
            automaticLayout: false,
            glyphMargin: true,
            lineNumbers: IDE.state.settings.editor.lineNumbers ? 'on' : 'off',
            folding: true,
            lineDecorationsWidth: 10,
            lineNumbersMinChars: 3,
            renderLineHighlight: 'all',
            scrollbar: {
                vertical: 'visible',
                horizontal: 'visible',
                useShadows: false,
                verticalScrollbarSize: 12,
                horizontalScrollbarSize: 12
            },
            bracketPairColorization: {
                enabled: IDE.state.settings.editor.bracketPairColorization
            },
            guides: {
                bracketPairs: true
            },
            suggest: {
                showWords: false,
                showFields: true,
                showFunctions: true,
                showVariables: true,
                showClasses: true,
                showModules: true,
                showConstructors: true,
                showMethods: true,
                showProperties: true,
                showEvents: true,
                showOperators: true,
                showUnits: true,
                showValues: true,
                showConstants: true,
                showEnums: true,
                showEnumMembers: true,
                showKeywords: true,
                showText: true,
                showColors: true,
                showFiles: true,
                showReferences: true,
                showFolders: true,
                showTypeParameters: true,
                showSnippets: IDE.state.settings.features.snippetSuggestions
            },
            quickSuggestions: {
                other: true,
                comments: false,
                strings: true
            },
            acceptSuggestionOnEnter: 'on',
            snippetSuggestions: 'inline',
            autoClosingBrackets: IDE.state.settings.editor.autoCloseBrackets ? 'always' : 'never',
            autoIndent: IDE.state.settings.editor.autoIndent ? 'full' : 'none',
            formatOnPaste: true,
            formatOnType: false,
            linkedEditing: true,
            contextmenu: true,
            mouseWheelZoom: true,
            smoothScrolling: true,
            dragAndDrop: true,
            accessibilitySupport: 'auto',
            showFoldingControls: 'always',
            renderWhitespace: 'none',
            renderControlCharacters: false,
            renderFinalNewline: 'dimmed',
            renderValidationDecorations: 'editable',
            overviewRulerLanes: 3,
            overviewRulerBorder: false
        });
        
        this.instances[containerId] = editor;
        
        // Setup resize observer with debouncing
        const resizeObserver = new ResizeObserver(Utils.debounce(() => {
            editor.layout();
        }, 100));
        resizeObserver.observe(container);
        
        // Store observer for cleanup
        editor.resizeObserver = resizeObserver;
        
        return editor;
    },
    
    setupEnhancedEventListeners: function() {
        Object.values(this.instances).forEach(editor => {
            // Content change with enhanced debouncing
            editor.onDidChangeModelContent(Utils.debounce((event) => {
                const model = editor.getModel();
                if (!model) return;
                
                const path = model.uri.path.substring(1);
                const value = editor.getValue();
                
                FileSystem.write(path, value);
                
                // Update diagnostics
                this.updateDiagnostics(path, value);
                
                // Update code lens
                this.updateCodeLens(path, value);
                
                // Update file size
                const size = new Blob([value]).size;
                document.getElementById('file-size').textContent = Utils.formatBytes(size);
                
                // Update outline
                FileSystem.updateOutline();
            }, 300));
            
            // Cursor position change
            editor.onDidChangeCursorPosition((event) => {
                document.getElementById('cursor-pos').textContent = 
                    `Ln ${event.position.lineNumber}, Col ${event.position.column}`;
                
                // Update active editor
                this.currentEditorId = Object.keys(this.instances).find(
                    key => this.instances[key] === editor
                ) || 'monaco-root-1';
                
                // Show hover information
                this.showHoverInfo(editor, event.position);
            });
            
            // Model change
            editor.onDidChangeModel((event) => {
                if (event.newModelUrl) {
                    const path = event.newModelUrl.path.substring(1);
                    const lang = Utils.detectLanguage(path);
                    
                    monaco.editor.setModelLanguage(editor.getModel(), lang);
                    
                    document.getElementById('file-lang').textContent = 
                        lang.charAt(0).toUpperCase() + lang.slice(1);
                    
                    // Apply model-specific settings
                    this.applyModelSettings(editor, lang);
                }
            });
            
            // Selection change
            editor.onDidChangeCursorSelection((event) => {
                // Could add selection info or multi-cursor support
            });
            
            // Mouse events
            editor.onMouseDown((event) => {
                // Handle mouse interactions
            });
            
            // Key events
            editor.onKeyDown((event) => {
                // Custom keyboard shortcuts
                this.handleCustomKeybindings(editor, event);
            });
            
            // Context menu
            editor.onContextMenu((event) => {
                // Custom context menu items
            });
        });
    },
    
    setupCodeLens: function() {
        // Code lens provider for references, implementations, etc.
        // This would require registering a provider with Monaco
    },
    
    setupDiagnostics: function() {
        // Diagnostic collection for errors, warnings, info
        // This would require setting up language-specific diagnostics
    },
    
    updateDiagnostics: function(path, content) {
        // Update diagnostics based on content
        const diagnostics = [];
        const lines = content.split('\n');
        
        // Simple diagnostics for demonstration
        lines.forEach((line, index) => {
            // Check for TODO comments
            if (line.includes('TODO') || line.includes('FIXME')) {
                diagnostics.push({
                    severity: monaco.MarkerSeverity.Info,
                    message: 'TODO comment found',
                    startLineNumber: index + 1,
                    startColumn: line.indexOf('TODO') + 1,
                    endLineNumber: index + 1,
                    endColumn: line.indexOf('TODO') + 5
                });
            }
            
            // Check for console.log in production code
            if (line.includes('console.log') && !line.includes('//')) {
                diagnostics.push({
                    severity: monaco.MarkerSeverity.Warning,
                    message: 'Consider removing console.log for production',
                    startLineNumber: index + 1,
                    startColumn: line.indexOf('console.log') + 1,
                    endLineNumber: index + 1,
                    endColumn: line.indexOf('console.log') + 11
                });
            }
        });
        
        this.diagnostics.set(path, diagnostics);
        
        // Update problems panel
        this.updateProblemsPanel();
    },
    
    updateCodeLens: function(path, content) {
        // Update code lens information
        // This would extract references, implementations, etc.
    },
    
    updateProblemsPanel: function() {
        const problemsHost = document.getElementById('problems-host');
        if (!problemsHost) return;
        
        let totalErrors = 0;
        let totalWarnings = 0;
        let totalInfos = 0;
        
        problemsHost.innerHTML = '';
        
        this.diagnostics.forEach((diagnostics, path) => {
            diagnostics.forEach(diagnostic => {
                const div = document.createElement('div');
                div.className = 'problem-item';
                div.style.padding = '8px 12px';
                div.style.borderBottom = '1px solid var(--border)';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '12px';
                
                const icon = diagnostic.severity === monaco.MarkerSeverity.Error ? 
                    '<i class="fas fa-times-circle" style="color:var(--error)"></i>' :
                    diagnostic.severity === monaco.MarkerSeverity.Warning ?
                    '<i class="fas fa-exclamation-triangle" style="color:var(--warn)"></i>' :
                    '<i class="fas fa-info-circle" style="color:var(--primary)"></i>';
                
                div.innerHTML = `
                    ${icon}
                    <div style="flex:1">
                        <div style="font-size:12px;">${diagnostic.message}</div>
                        <div style="font-size:11px; color:var(--text-dim);">
                            ${path}:${diagnostic.startLineNumber}:${diagnostic.startColumn}
                        </div>
                    </div>
                    <button class="btn icon small" onclick="EditorManager.goToProblem('${path}', ${diagnostic.startLineNumber}, ${diagnostic.startColumn})">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                `;
                
                problemsHost.appendChild(div);
                
                // Update counts
                if (diagnostic.severity === monaco.MarkerSeverity.Error) totalErrors++;
                if (diagnostic.severity === monaco.MarkerSeverity.Warning) totalWarnings++;
                if (diagnostic.severity === monaco.MarkerSeverity.Info) totalInfos++;
            });
        });
        
        // Update footer counters
        document.getElementById('error-count').innerHTML = `<i class="fas fa-times-circle"></i> ${totalErrors}`;
        document.getElementById('warning-count').innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${totalWarnings}`;
        document.getElementById('info-count').innerHTML = `<i class="fas fa-info-circle"></i> ${totalInfos}`;
        
        // Update panel badge
        const problemsBadge = document.getElementById('problems-badge');
        if (problemsBadge) {
            const total = totalErrors + totalWarnings + totalInfos;
            problemsBadge.textContent = total;
            problemsBadge.style.display = total > 0 ? 'inline-flex' : 'none';
        }
    },
    
    goToProblem: function(path, line, column) {
        TabManager.open(path);
        const editor = this.getCurrentEditor();
        if (editor) {
            editor.revealLineInCenter(line);
            editor.setPosition({ lineNumber: line, column: column });
            editor.focus();
        }
    },
    
    showHoverInfo: function(editor, position) {
        // Show hover information for the current position
        // This would integrate with language server for type information
    },
    
    applyModelSettings: function(editor, language) {
        // Apply language-specific settings
        switch (language) {
            case 'typescript':
            case 'javascript':
                editor.updateOptions({
                    suggest: {
                        showSnippets: true
                    }
                });
                break;
            case 'html':
                editor.updateOptions({
                    autoClosingTags: true,
                    autoClosingQuotes: true
                });
                break;
            case 'css':
            case 'scss':
            case 'less':
                editor.updateOptions({
                    colorDecorators: true
                });
                break;
        }
    },
    
    handleCustomKeybindings: function(editor, event) {
        // Handle custom keybindings
        const { ctrlKey, shiftKey, altKey, keyCode } = event;
        
        // Ctrl/Cmd + S - Save
        if ((ctrlKey || event.metaKey) && keyCode === 83) {
            event.preventDefault();
            FileSystem.save(true);
        }
        
        // Ctrl/Cmd + F - Find
        if ((ctrlKey || event.metaKey) && keyCode === 70) {
            event.preventDefault();
            this.findText('');
        }
        
        // Ctrl/Cmd + Shift + F - Replace
        if ((ctrlKey || event.metaKey) && shiftKey && keyCode === 70) {
            event.preventDefault();
            this.replaceText('', '');
        }
        
        // Ctrl/Cmd + / - Toggle comment
        if ((ctrlKey || event.metaKey) && keyCode === 191) {
            event.preventDefault();
            this.toggleComment();
        }
        
        // Alt + Up/Down - Move line
        if (altKey && (keyCode === 38 || keyCode === 40)) {
            event.preventDefault();
            if (keyCode === 38) this.moveLineUp();
            else this.moveLineDown();
        }
        
        // Ctrl/Cmd + D - Duplicate line
        if ((ctrlKey || event.metaKey) && keyCode === 68) {
            event.preventDefault();
            this.duplicateLine();
        }
        
        // Ctrl/Cmd + Shift + K - Delete line
        if ((ctrlKey || event.metaKey) && shiftKey && keyCode === 75) {
            event.preventDefault();
            this.deleteLine();
        }
    },
    
    moveLineUp: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.moveLinesUpAction').run();
    },
    
    moveLineDown: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.moveLinesDownAction').run();
    },
    
    setFile: function(path, editorId = 'monaco-root-1') {
        const editor = this.instances[editorId];
        if (!editor) {
            console.error(`Editor ${editorId} not found`);
            return;
        }
        
        const content = FileSystem.read(path);
        const lang = Utils.detectLanguage(path);
        
        // Get or create model
        let model = monaco.editor.getModel(monaco.Uri.parse(`file:///${path}`));
        
        if (!model) {
            model = monaco.editor.createModel(
                content,
                lang,
                monaco.Uri.parse(`file:///${path}`)
            );
        } else {
            model.setValue(content);
        }
        
        // Set model
        editor.setModel(model);
        monaco.editor.setModelLanguage(model, lang);
        
        // Apply model settings
        this.applyModelSettings(editor, lang);
        
        // Update UI
        const emptyState = document.getElementById('empty-state');
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        // Update footer
        document.getElementById('file-lang').textContent = 
            lang.charAt(0).toUpperCase() + lang.slice(1);
            
        const size = new Blob([content]).size;
        document.getElementById('file-size').textContent = Utils.formatBytes(size);
        
        // Update active editor
        this.currentEditorId = editorId;
        
        // Update diagnostics and code lens
        this.updateDiagnostics(path, content);
        this.updateCodeLens(path, content);
        
        // Trigger content change event to update outline
        FileSystem.updateOutline();
    },
    
    getCurrentEditor: function() {
        return this.instances[this.currentEditorId];
    },
    
    applySettings: function() {
        Object.values(this.instances).forEach(editor => {
            editor.updateOptions({
                fontSize: IDE.state.settings.editor.fontSize,
                theme: IDE.state.settings.editor.theme,
                wordWrap: IDE.state.settings.editor.wordWrap ? 'on' : 'off',
                tabSize: IDE.state.settings.editor.tabSize,
                minimap: { 
                    enabled: IDE.state.settings.editor.minimap 
                },
                lineNumbers: IDE.state.settings.editor.lineNumbers ? 'on' : 'off',
                fontFamily: IDE.state.settings.editor.fontFamily,
                bracketPairColorization: {
                    enabled: IDE.state.settings.editor.bracketPairColorization
                },
                autoClosingBrackets: IDE.state.settings.editor.autoCloseBrackets ? 'always' : 'never',
                autoIndent: IDE.state.settings.editor.autoIndent ? 'full' : 'none',
                suggest: {
                    showSnippets: IDE.state.settings.features.snippetSuggestions
                }
            });
        });
        
        // Update CSS variable
        Utils.setCssVariable('--editor-font-size', IDE.state.settings.editor.fontSize + 'px');
    },
    
    formatCode: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        const model = editor.getModel();
        if (!model) return;
        
        const range = model.getFullModelRange();
        const text = model.getValue();
        const language = model.getLanguageId();
        
        try {
            let formatted = text;
            let parser = 'babel';
            
            // Determine parser based on language
            switch(language) {
                case 'typescript':
                case 'typescriptreact':
                    parser = 'typescript';
                    break;
                case 'css':
                case 'scss':
                case 'less':
                    parser = 'css';
                    break;
                case 'html':
                    parser = 'html';
                    break;
                case 'json':
                    parser = 'json';
                    break;
                case 'vue':
                    parser = 'vue';
                    break;
            }
            
            const options = {
                parser: parser,
                plugins: [
                    window.prettierPlugins.html, 
                    window.prettierPlugins.babel,
                    window.prettierPlugins.postcss,
                    window.prettierPlugins.typescript
                ],
                tabWidth: IDE.state.settings.editor.tabSize,
                useTabs: false,
                semi: true,
                singleQuote: true,
                trailingComma: 'es5',
                printWidth: 80,
                bracketSpacing: true,
                arrowParens: 'avoid',
                endOfLine: 'lf'
            };
            
            // Try to format
            formatted = prettier.format(text, options);
            
            // Apply formatting
            editor.executeEdits('', [{
                range: range,
                text: formatted,
                forceMoveMarkers: true
            }]);
            
            Utils.toast('Code formatted successfully', 'success');
        } catch (error) {
            console.error('Format error:', error);
            Utils.toast('Format failed: ' + error.message, 'error');
        }
    },
    
    getSelection: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return '';
        
        const selection = editor.getSelection();
        const model = editor.getModel();
        
        if (!selection || !model) return '';
        
        return model.getValueInRange(selection);
    },
    
    insertText: function(text, position = null) {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        const selection = position || editor.getSelection();
        const op = { 
            range: selection, 
            text: text, 
            forceMoveMarkers: true 
        };
        
        editor.executeEdits('', [op]);
        
        // Move cursor to end of inserted text
        const newPosition = editor.getModel().modifyPosition(selection.getEndPosition(), text.length);
        editor.setPosition(newPosition);
    },
    
    findText: function(text, options = {}) {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('actions.find').run();
        
        // Set find widget text
        const findWidget = editor.getContribution('editor.contrib.findController');
        if (findWidget && text) {
            findWidget.start({
                searchString: text,
                replaceString: '',
                isRegex: options.regex || false,
                matchCase: options.caseSensitive || false,
                wholeWord: options.wholeWord || false,
                searchScope: null,
                loop: true
            });
        }
    },
    
    replaceText: function(find, replace, options = {}) {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.startFindReplaceAction').run();
        
        // Set find and replace values
        const findWidget = editor.getContribution('editor.contrib.findController');
        if (findWidget && find) {
            findWidget.start({
                searchString: find,
                replaceString: replace,
                isRegex: options.regex || false,
                matchCase: options.caseSensitive || false,
                wholeWord: options.wholeWord || false
            });
        }
    },
    
    goToLine: function(lineNumber) {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.revealLineInCenter(lineNumber);
        editor.setPosition({ lineNumber: lineNumber, column: 1 });
        editor.focus();
    },
    
    toggleComment: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.commentLine').run();
    },
    
    duplicateLine: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.copyLinesDownAction').run();
    },
    
    deleteLine: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.deleteLines').run();
    },
    
    // Enhanced editor utilities
    getWordAtPosition: function(position) {
        const editor = this.getCurrentEditor();
        if (!editor) return null;
        
        const model = editor.getModel();
        if (!model) return null;
        
        return model.getWordAtPosition(position);
    },
    
    getCurrentWord: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return '';
        
        const position = editor.getPosition();
        const word = this.getWordAtPosition(position);
        return word ? word.word : '';
    },
    
    getCurrentLine: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return '';
        
        const position = editor.getPosition();
        const model = editor.getModel();
        if (!model) return '';
        
        return model.getLineContent(position.lineNumber);
    },
    
    getLineCount: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return 0;
        
        const model = editor.getModel();
        if (!model) return 0;
        
        return model.getLineCount();
    },
    
    // Folding
    foldAll: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.foldAll').run();
    },
    
    unfoldAll: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.unfoldAll').run();
    },
    
    // Selection manipulation
    selectAll: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.setSelection(editor.getModel().getFullModelRange());
    },
    
    expandSelection: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.smartSelect.expand').run();
    },
    
    shrinkSelection: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.smartSelect.shrink').run();
    },
    
    // Multiple cursors
    addCursorAbove: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.insertCursorAbove').run();
    },
    
    addCursorBelow: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.insertCursorBelow').run();
    },
    
    addCursorToLineEnds: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.insertCursorAtEndOfEachLineSelected').run();
    },
    
    // Code actions
    quickFix: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.quickFix').run();
    },
    
    refactor: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.refactor').run();
    },
    
    renameSymbol: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.rename').run();
    },
    
    // Navigation
    goToDefinition: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.revealDefinition').run();
    },
    
    goToTypeDefinition: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.goToTypeDefinition').run();
    },
    
    goToImplementation: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.goToImplementation').run();
    },
    
    goToReferences: function() {
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        editor.getAction('editor.action.goToReferences').run();
    },
    
    // View
    toggleMinimap: function() {
        IDE.state.settings.editor.minimap = !IDE.state.settings.editor.minimap;
        this.applySettings();
    },
    
    toggleWordWrap: function() {
        IDE.state.settings.editor.wordWrap = !IDE.state.settings.editor.wordWrap;
        this.applySettings();
    },
    
    zoomIn: function() {
        IDE.state.settings.editor.fontSize = Math.min(32, IDE.state.settings.editor.fontSize + 1);
        this.applySettings();
    },
    
    zoomOut: function() {
        IDE.state.settings.editor.fontSize = Math.max(8, IDE.state.settings.editor.fontSize - 1);
        this.applySettings();
    },
    
    resetZoom: function() {
        IDE.state.settings.editor.fontSize = 14;
        this.applySettings();
    },
    
    // Advanced features
    showCommandPalette: function() {
        CommandPalette.show();
    },
    
    showColorPicker: function() {
        // This would show a color picker for CSS/HTML colors
        const editor = this.getCurrentEditor();
        if (!editor) return;
        
        const position = editor.getPosition();
        const word = this.getWordAtPosition(position);
        
        if (word) {
            // Check if it's a color value
            const colorRegex = /^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i;
            const rgbRegex = /^rgb\(/i;
            const rgbaRegex = /^rgba\(/i;
            const hslRegex = /^hsl\(/i;
            const hslaRegex = /^hsla\(/i;
            
            const value = word.word;
            if (colorRegex.test(value) || rgbRegex.test(value) || rgbaRegex.test(value) || 
                hslRegex.test(value) || hslaRegex.test(value)) {
                // Show color picker
                this.showColorPickerDialog(value, position, word);
            }
        }
    },
    
    showColorPickerDialog: function(color, position, word) {
        // Create color picker dialog
        const dialog = document.createElement('div');
        dialog.className = 'modal-overlay';
        dialog.id = 'color-picker-dialog';
        
        // This would be a full color picker implementation
        // For now, just show a simple dialog
        dialog.innerHTML = `
            <div class="modal" style="width:400px;">
                <div class="modal-header">
                    <h3><i class="fas fa-palette"></i> Color Picker</h3>
                    <button class="btn icon small" onclick="document.getElementById('color-picker-dialog').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="text-align:center; padding:20px;">
                        <div style="width:100px; height:100px; background:${color}; margin:0 auto 20px; border-radius:8px; border:2px solid var(--border);"></div>
                        <div style="font-family:'JetBrains Mono'; font-size:14px;">${color}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="document.getElementById('color-picker-dialog').remove()">Close</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
    }
};

// ============================================
// ENHANCED TAB MANAGER
// ============================================
const TabManager = {
    open: function(path) {
        if (!path || !FileSystem.exists(path)) {
            console.error(`File not found: ${path}`);
            return;
        }
        
        // Add to tabs if not already
        if (!IDE.state.tabs.includes(path)) {
            IDE.state.tabs.push(path);
        }
        
        // Set as active
        IDE.state.activeTab = path;
        
        // Render tabs
        this.render();
        
        // Set file in editor
        EditorManager.setFile(path);
        
        // Update tree highlight
        this.highlightTreeItem(path);
        
        // Update outline
        FileSystem.updateOutline();
        
        // Update tab dirty state
        FileSystem.updateTabDirtyState();
    },
    
    close: function(path, force = false) {
        if (!IDE.state.tabs.includes(path)) return;
        
        // Check if file has unsaved changes
        if (IDE.state.dirtyTabs.has(path) && !force) {
            if (!confirm('You have unsaved changes. Close anyway?')) {
                return;
            }
        }
        
        const index = IDE.state.tabs.indexOf(path);
        IDE.state.tabs.splice(index, 1);
        
        // Remove from dirty tabs
        IDE.state.dirtyTabs.delete(path);
        
        // Update active tab
        if (IDE.state.activeTab === path) {
            IDE.state.activeTab = IDE.state.tabs.length > 0 
                ? IDE.state.tabs[IDE.state.tabs.length - 1] 
                : null;
            
            if (IDE.state.activeTab) {
                EditorManager.setFile(IDE.state.activeTab);
            } else {
                // Show empty state
                document.getElementById('empty-state').style.display = 'flex';
                const editor = EditorManager.getCurrentEditor();
                if (editor) {
                    editor.setModel(null);
                }
            }
        }
        
        this.render();
        this.highlightTreeItem(IDE.state.activeTab);
        FileSystem.updateTabDirtyState();
    },
    
    closeAll: function() {
        if (IDE.state.dirtyTabs.size > 0) {
            if (!confirm('Some files have unsaved changes. Close all tabs?')) {
                return;
            }
        }
        
        IDE.state.tabs = [];
        IDE.state.activeTab = null;
        IDE.state.dirtyTabs.clear();
        
        this.render();
        document.getElementById('empty-state').style.display = 'flex';
        
        const editor = EditorManager.getCurrentEditor();
        if (editor) {
            editor.setModel(null);
        }
        
        FileSystem.updateTabDirtyState();
    },
    
    closeOthers: function(path) {
        IDE.state.tabs = [path];
        IDE.state.activeTab = path;
        IDE.state.dirtyTabs.clear();
        
        this.render();
        EditorManager.setFile(path);
        this.highlightTreeItem(path);
        FileSystem.updateTabDirtyState();
    },
    
    render: function() {
        const container = document.getElementById('tab-list');
        if (!container) return;
        
        container.innerHTML = '';
        
        IDE.state.tabs.forEach(path => {
            const fileName = path.split('/').pop();
            const isActive = IDE.state.activeTab === path;
            const [iconClass, iconColor] = Utils.getFileIcon(path);
            const isDirty = IDE.state.dirtyTabs.has(path);
            
            const tab = document.createElement('div');
            tab.className = `tab ${isActive ? 'active' : ''} ${isDirty ? 'dirty' : ''}`;
            tab.dataset.path = path;
            tab.title = path; // Show full path on hover
            
            tab.innerHTML = `
                <i class="${iconClass}" style="color:${iconColor}; font-size:12px;"></i>
                <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    ${fileName}
                </span>
                <div class="close" onclick="event.stopPropagation(); TabManager.close('${path}')">
                    
                </div>
            `;
            
            tab.onclick = (e) => {
                if (e.target.classList.contains('close')) return;
                this.open(path);
            };
            
            // Tab context menu
            tab.oncontextmenu = (e) => {
                e.preventDefault();
                this.showTabContextMenu(e, path);
            };
            
            // Drag and drop for tab reordering
            tab.draggable = true;
            tab.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', path);
                tab.style.opacity = '0.5';
            });
            
            tab.addEventListener('dragend', () => {
                tab.style.opacity = '1';
            });
            
            tab.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            tab.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggedPath = e.dataTransfer.getData('text/plain');
                this.reorderTab(draggedPath, path);
            });
            
            container.appendChild(tab);
        });
        
        // Ensure active tab is visible
        if (IDE.state.activeTab) {
            const activeTab = container.querySelector('.tab.active');
            if (activeTab) {
                activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }
    },
    
    reorderTab: function(draggedPath, targetPath) {
        if (draggedPath === targetPath) return;
        
        const draggedIndex = IDE.state.tabs.indexOf(draggedPath);
        const targetIndex = IDE.state.tabs.indexOf(targetPath);
        
        if (draggedIndex === -1 || targetIndex === -1) return;
        
        // Remove dragged tab
        IDE.state.tabs.splice(draggedIndex, 1);
        
        // Insert at new position
        IDE.state.tabs.splice(targetIndex, 0, draggedPath);
        
        this.render();
    },
    
    highlightTreeItem: function(path) {
        if (!path) return;
        
        document.querySelectorAll('.t-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.path === path) {
                item.classList.add('active');
                
                // Ensure parent folders are expanded
                let parent = item.parentElement;
                while (parent && !parent.classList.contains('tree')) {
                    if (parent.classList.contains('t-sub')) {
                        parent.classList.remove('hidden');
                        
                        // Update folder icon and chevron
                        const folderItem = parent.previousElementSibling;
                        if (folderItem) {
                            const folderIcon = folderItem.querySelector('.fa-folder, .fa-folder-open');
                            if (folderIcon) {
                                folderIcon.className = 'fas fa-folder-open';
                            }
                            
                            const chevron = folderItem.querySelector('.fa-chevron-right');
                            if (chevron) {
                                chevron.style.transform = 'rotate(90deg)';
                            }
                            
                            // Save expanded state
                            const folderPath = folderItem.dataset.folder;
                            if (folderPath) {
                                localStorage.setItem(`folder_${folderPath}`, 'expanded');
                            }
                        }
                    }
                    parent = parent.parentElement;
                }
            }
        });
    },
    
    showTabContextMenu: function(event, path) {
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.style.left = event.clientX + 'px';
        menu.style.top = event.clientY + 'px';
        
        const addItem = (icon, text, action) => {
            const item = document.createElement('div');
            item.className = 'context-item';
            item.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
            item.onclick = () => {
                action();
                menu.remove();
            };
            menu.appendChild(item);
        };
        
        addItem('fa-times', 'Close', () => this.close(path));
        addItem('fa-times-circle', 'Close Others', () => this.closeOthers(path));
        addItem('fa-window-close', 'Close All', () => this.closeAll());
        
        menu.appendChild(document.createElement('div')).className = 'context-divider';
        
        addItem('fa-copy', 'Copy Path', () => {
            Utils.copyToClipboard(path);
        });
        
        addItem('fa-folder-open', 'Reveal in Explorer', () => {
            this.highlightTreeItem(path);
        });
        
        addItem('fa-save', 'Save', () => {
            FileSystem.save(true);
        });
        
        menu.appendChild(document.createElement('div')).className = 'context-divider';
        
        addItem('fa-arrow-right', 'Open to the Right', () => {
            LayoutManager.openInSplit(path);
        });
        
        addItem('fa-arrow-down', 'Open Below', () => {
            // This would open in a new editor group below
        });
        
        document.body.appendChild(menu);
        
        setTimeout(() => {
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            document.addEventListener('click', closeMenu);
        }, 10);
    },
    
    refreshTab: function(path) {
        const tab = document.querySelector(`.tab[data-path="${path}"]`);
        if (tab) {
            // Update dirty indicator if needed
            if (IDE.state.dirtyTabs.has(path)) {
                tab.classList.add('dirty');
            } else {
                tab.classList.remove('dirty');
            }
        }
    }
};

// ============================================
// ENHANCED TERMINAL MANAGER
// ============================================
const TerminalManager = {
    instance: null,
    fitAddon: null,
    webLinksAddon: null,
    currentDir: '/',
    commandHistory: [],
    historyIndex: -1,
    terminals: {},
    activeTerminal: 'default',
    
    init: function() {
        console.log(' Initializing Enhanced Terminal Manager');
        
        this.createTerminal('default');
        this.setActiveTerminal('default');
        
        Utils.toast('Terminal ready', 'success');
    },
    
    createTerminal: function(id = null) {
        const terminalId = id || `terminal-${Date.now()}`;
        
        const terminal = new Terminal({
            theme: {
                background: '#09090b',
                foreground: '#e4e4e7',
                cursor: '#6366f1',
                selection: '#3f3f4680',
                black: '#000000',
                red: '#ef4444',
                green: '#22c55e',
                yellow: '#f59e0b',
                blue: '#3b82f6',
                magenta: '#a855f7',
                cyan: '#06b6d4',
                white: '#ffffff',
                brightBlack: '#52525b',
                brightRed: '#fb7185',
                brightGreen: '#4ade80',
                brightYellow: '#fbbf24',
                brightBlue: '#60a5fa',
                brightMagenta: '#d8b4fe',
                brightCyan: '#22d3ee',
                brightWhite: '#fafafa'
            },
            fontFamily: IDE.state.settings.terminal.fontFamily,
            fontSize: IDE.state.settings.terminal.fontSize,
            cursorBlink: IDE.state.settings.terminal.cursorBlink,
            cursorStyle: IDE.state.settings.terminal.cursorStyle,
            scrollback: 10000,
            convertEol: true,
            allowTransparency: true,
            disableStdin: false,
            windowsMode: false,
            macOptionIsMeta: false,
            rendererType: 'canvas',
            cols: 80,
            rows: 24
        });
        
        const fitAddon = new FitAddon.FitAddon();
        const webLinksAddon = new WebLinksAddon.WebLinksAddon();
        
        terminal.loadAddon(fitAddon);
        terminal.loadAddon(webLinksAddon);
        
        this.terminals[terminalId] = {
            instance: terminal,
            fitAddon: fitAddon,
            webLinksAddon: webLinksAddon,
            currentDir: '/',
            commandHistory: [],
            historyIndex: -1
        };
        
        return terminalId;
    },
    
    setActiveTerminal: function(id) {
        if (!this.terminals[id]) {
            console.error(`Terminal ${id} not found`);
            return;
        }
        
        this.activeTerminal = id;
        const terminal = this.terminals[id];
        
        // Clear current terminal host
        const host = document.getElementById('term-host');
        host.innerHTML = '';
        
        // Open terminal in host
        terminal.instance.open(host);
        
        // Write welcome if first time
        if (terminal.commandHistory.length === 0) {
            this.writeWelcome(id);
        }
        
        // Setup input handling
        this.setupInput(id);
        
        // Fit terminal
        setTimeout(() => terminal.fitAddon.fit(), 50);
        
        // Setup resize observer
        new ResizeObserver(() => terminal.fitAddon.fit()).observe(host);
        
        // Update UI
        this.updateTerminalUI();
    },
    
    writeWelcome: function(terminalId) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        terminal.instance.write('\x1b[1;36m\r\n');
        terminal.instance.write('\x1b[1;36m  \x1b[1;35mProCode IDE Terminal v15.0\x1b[1;36m                    \r\n');
        terminal.instance.write('\x1b[1;36m  Type \x1b[1;33mhelp\x1b[1;36m for available commands              \r\n');
        terminal.instance.write('\x1b[1;36m  Multiple terminals: \x1b[1;33mCtrl+Shift+`\x1b[1;36m              \r\n');
        terminal.instance.write('\x1b[1;36m\r\n\r\n');
        this.writePrompt(terminalId);
    },
    
    writePrompt: function(terminalId) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        const path = terminal.currentDir === '/' ? '/' : terminal.currentDir.substring(1);
        terminal.instance.write(`\x1b[1;32muser@procode\x1b[0m:\x1b[1;34m${path}\x1b[0m$ `);
    },
    
    setupInput: function(terminalId) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        let currentInput = '';
        let isProcessing = false;
        
        terminal.instance.onKey(({ key, domEvent }) => {
            if (isProcessing) return;
            
            const printable = !domEvent.altKey && !domEvent.ctrlKey && !domEvent.metaKey;
            
            switch (domEvent.keyCode) {
                case 13: // Enter
                    terminal.instance.write('\r\n');
                    this.executeCommand(terminalId, currentInput);
                    terminal.commandHistory.push(currentInput);
                    terminal.historyIndex = terminal.commandHistory.length;
                    currentInput = '';
                    break;
                    
                case 8: // Backspace
                    if (currentInput.length > 0) {
                        terminal.instance.write('\b \b');
                        currentInput = currentInput.substring(0, currentInput.length - 1);
                    }
                    break;
                    
                case 9: // Tab
                    domEvent.preventDefault();
                    this.handleTabCompletion(terminalId, currentInput);
                    break;
                    
                case 38: // Up arrow
                    if (terminal.historyIndex > 0) {
                        terminal.historyIndex--;
                        this.clearCurrentLine(terminalId);
                        currentInput = terminal.commandHistory[terminal.historyIndex];
                        terminal.instance.write(currentInput);
                    }
                    break;
                    
                case 40: // Down arrow
                    if (terminal.historyIndex < terminal.commandHistory.length - 1) {
                        terminal.historyIndex++;
                        this.clearCurrentLine(terminalId);
                        currentInput = terminal.commandHistory[terminal.historyIndex];
                        terminal.instance.write(currentInput);
                    } else if (terminal.historyIndex === terminal.commandHistory.length - 1) {
                        terminal.historyIndex = terminal.commandHistory.length;
                        this.clearCurrentLine(terminalId);
                        currentInput = '';
                    }
                    break;
                    
                case 67: // Ctrl+C
                    if (domEvent.ctrlKey) {
                        terminal.instance.write('^C\r\n');
                        this.writePrompt(terminalId);
                        currentInput = '';
                    }
                    break;
                    
                case 76: // Ctrl+L
                    if (domEvent.ctrlKey) {
                        terminal.instance.clear();
                        this.writeWelcome(terminalId);
                        currentInput = '';
                    }
                    break;
                    
                case 85: // Ctrl+U
                    if (domEvent.ctrlKey) {
                        this.clearCurrentLine(terminalId);
                        currentInput = '';
                    }
                    break;
                    
                case 65: // Ctrl+A
                    if (domEvent.ctrlKey) {
                        // Move cursor to beginning of line
                        terminal.instance.write('\x1b[1G');
                        terminal.instance.write(`\x1b[1;32muser@procode\x1b[0m:\x1b[1;34m${terminal.currentDir === '/' ? '/' : terminal.currentDir.substring(1)}\x1b[0m$ `);
                    }
                    break;
                    
                case 69: // Ctrl+E
                    if (domEvent.ctrlKey) {
                        // Move cursor to end of line
                        const promptLength = `user@procode:${terminal.currentDir === '/' ? '/' : terminal.currentDir.substring(1)}$ `.length;
                        terminal.instance.write(`\x1b[${promptLength + currentInput.length + 1}G`);
                    }
                    break;
                    
                default:
                    if (printable) {
                        terminal.instance.write(key);
                        currentInput += key;
                    }
            }
        });
        
        // Handle paste
        terminal.instance.attachCustomKeyEventHandler((event) => {
            if ((event.ctrlKey || event.metaKey) && event.key === 'v') {
                navigator.clipboard.readText().then(text => {
                    terminal.instance.write(text);
                    currentInput += text;
                });
                return false;
            }
            return true;
        });
        
        terminal.currentInput = currentInput;
        terminal.isProcessing = isProcessing;
    },
    
    clearCurrentLine: function(terminalId) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        terminal.instance.write('\r\x1b[K');
        this.writePrompt(terminalId);
    },
    
    handleTabCompletion: function(terminalId, input) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        const suggestions = this.getCommandSuggestions(input);
        if (suggestions.length === 1) {
            const completion = suggestions[0];
            terminal.instance.write(completion.substring(input.length));
            terminal.currentInput = completion;
        } else if (suggestions.length > 1) {
            terminal.instance.write('\r\n');
            suggestions.forEach(s => terminal.instance.write(`${s}  `));
            terminal.instance.write('\r\n');
            this.writePrompt(terminalId);
            terminal.instance.write(input);
        }
    },
    
    getCommandSuggestions: function(input) {
        const commands = [
            'help', 'ls', 'cd', 'clear', 'pwd', 'cat', 'echo', 
            'python', 'node', 'npm', 'git', 'mkdir', 'touch', 
            'rm', 'cp', 'mv', 'find', 'grep', 'curl', 'wget'
        ];
        
        const fileSuggestions = this.getFileSuggestions(input);
        return [...commands, ...fileSuggestions].filter(item => 
            item.startsWith(input)
        );
    },
    
    getFileSuggestions: function(input) {
        const parts = input.split(' ');
        if (parts.length < 2) return [];
        
        const lastPart = parts[parts.length - 1];
        if (!lastPart || lastPart.includes('/')) return [];
        
        const pathPrefix = this.terminals[this.activeTerminal]?.currentDir || '/';
        const files = Object.keys(IDE.state.files)
            .filter(f => f.startsWith(pathPrefix))
            .map(f => f.substring(pathPrefix.length))
            .filter(f => f.startsWith(lastPart))
            .map(f => parts.slice(0, -1).concat(f).join(' '));
        
        return files;
    },
    
    executeCommand: function(terminalId, input) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        const trimmed = input.trim();
        if (!trimmed) {
            this.writePrompt(terminalId);
            return;
        }
        
        terminal.isProcessing = true;
        
        const [cmd, ...args] = trimmed.split(' ');
        const command = cmd.toLowerCase();
        
        // Execute command
        switch(command) {
            case 'help':
                this.showHelp(terminalId);
                break;
                
            case 'ls':
                this.listFiles(terminalId, args);
                break;
                
            case 'cd':
                this.changeDirectory(terminalId, args[0]);
                break;
                
            case 'clear':
                terminal.instance.clear();
                this.writeWelcome(terminalId);
                terminal.isProcessing = false;
                return;
                
            case 'pwd':
                terminal.instance.write(terminal.currentDir + '\r\n');
                break;
                
            case 'cat':
                this.showFile(terminalId, args[0]);
                break;
                
            case 'echo':
                terminal.instance.write(args.join(' ') + '\r\n');
                break;
                
            case 'mkdir':
                this.createDirectory(terminalId, args[0]);
                break;
                
            case 'touch':
                this.createFile(terminalId, args[0]);
                break;
                
            case 'rm':
                this.removeFile(terminalId, args);
                break;
                
            case 'cp':
                this.copyFile(terminalId, args[0], args[1]);
                break;
                
            case 'mv':
                this.moveFile(terminalId, args[0], args[1]);
                break;
                
            case 'find':
                this.findFiles(terminalId, args);
                break;
                
            case 'grep':
                this.grepFiles(terminalId, args);
                break;
                
            case 'curl':
            case 'wget':
                terminal.instance.write(`\x1b[33m${command} is not available in this environment. Use an external terminal.\x1b[0m\r\n`);
                break;
                
            case 'python':
                this.runPython(terminalId, args);
                break;
                
            case 'node':
                this.runNode(terminalId, args);
                break;
                
            case 'npm':
                this.runNpm(terminalId, args);
                break;
                
            case 'git':
                this.runGit(terminalId, args);
                break;
                
            default:
                terminal.instance.write(`\x1b[31mCommand not found: ${cmd}\x1b[0m\r\n`);
                terminal.instance.write('Type \x1b[33mhelp\x1b[0m for available commands\r\n');
        }
        
        terminal.isProcessing = false;
        this.writePrompt(terminalId);
    },
    
    showHelp: function(terminalId) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        terminal.instance.write('\x1b[1;33mAvailable commands:\x1b[0m\r\n');
        terminal.instance.write('  \x1b[32mhelp\x1b[0m     - Show this help message\r\n');
        terminal.instance.write('  \x1b[32mls\x1b[0m       - List files in current directory\r\n');
        terminal.instance.write('  \x1b[32mcd\x1b[0m       - Change directory\r\n');
        terminal.instance.write('  \x1b[32mclear\x1b[0m    - Clear terminal screen\r\n');
        terminal.instance.write('  \x1b[32mpwd\x1b[0m      - Print working directory\r\n');
        terminal.instance.write('  \x1b[32mcat\x1b[0m      - Display file content\r\n');
        terminal.instance.write('  \x1b[32mecho\x1b[0m     - Print text\r\n');
        terminal.instance.write('  \x1b[32mmkdir\x1b[0m    - Create directory\r\n');
        terminal.instance.write('  \x1b[32mtouch\x1b[0m    - Create file\r\n');
        terminal.instance.write('  \x1b[32mrm\x1b[0m       - Remove files/directories\r\n');
        terminal.instance.write('  \x1b[32mcp\x1b[0m       - Copy file\r\n');
        terminal.instance.write('  \x1b[32mmv\x1b[0m       - Move/rename file\r\n');
        terminal.instance.write('  \x1b[32mfind\x1b[0m     - Find files\r\n');
        terminal.instance.write('  \x1b[32mgrep\x1b[0m     - Search in files\r\n');
        terminal.instance.write('  \x1b[32mpython\x1b[0m   - Run Python code\r\n');
        terminal.instance.write('  \x1b[32mnode\x1b[0m     - Run Node.js code\r\n');
        terminal.instance.write('  \x1b[32mnpm\x1b[0m      - NPM package manager (external terminal required)\r\n');
        terminal.instance.write('  \x1b[32mgit\x1b[0m      - Git version control (external terminal required)\r\n');
        terminal.instance.write('\r\n\x1b[1;33mShortcuts:\x1b[0m\r\n');
        terminal.instance.write('  \x1b[32mCtrl+C\x1b[0m    - Cancel current command\r\n');
        terminal.instance.write('  \x1b[32mCtrl+L\x1b[0m    - Clear terminal\r\n');
        terminal.instance.write('  \x1b[32mCtrl+U\x1b[0m    - Clear line\r\n');
        terminal.instance.write('  \x1b[32mCtrl+A\x1b[0m    - Move to beginning of line\r\n');
        terminal.instance.write('  \x1b[32mCtrl+E\x1b[0m    - Move to end of line\r\n');
        terminal.instance.write('  \x1b[32mTab\x1b[0m       - Auto-complete\r\n');
        terminal.instance.write('  \x1b[32m/ arrows\x1b[0m - Navigate command history\r\n');
    },
    
    listFiles: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        const showHidden = args.includes('-a') || args.includes('-la');
        const longFormat = args.includes('-l') || args.includes('-la');
        const showAll = args.includes('-la');
        
        const pathPrefix = terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/';
        const files = Object.keys(IDE.state.files)
            .filter(f => f.startsWith(pathPrefix) && (showAll || !f.includes('/.')))
            .map(f => {
                const relative = f.substring(pathPrefix.length);
                const parts = relative.split('/');
                return parts.length === 1 ? parts[0] : parts[0] + '/';
            })
            .filter((v, i, a) => a.indexOf(v) === i)
            .sort();
        
        if (files.length === 0) {
            terminal.instance.write('(empty directory)\r\n');
            return;
        }
        
        if (longFormat) {
            // Show detailed listing
            terminal.instance.write('Permissions Size Created Name\r\n');
            terminal.instance.write('   \r\n');
            
            files.forEach(file => {
                const isDir = file.endsWith('/');
                const fullPath = pathPrefix + (isDir ? file.slice(0, -1) : file);
                const size = isDir ? '-' : IDE.state.files[fullPath]?.length || 0;
                const perms = isDir ? 'drwxr-xr-x' : '-rw-r--r--';
                
                terminal.instance.write(
                    `${perms} ${size.toString().padStart(5)} B - ${file.padEnd(30)}\r\n`
                );
            });
        } else {
            // Show compact listing with colors
            let output = '';
            files.forEach(file => {
                const isDir = file.endsWith('/');
                const icon = isDir ? '\x1b[1;34m\x1b[0m' : '\x1b[1;33m\x1b[0m';
                output += `${icon} ${file}  `;
                
                // Limit to 4 items per line
                if (output.split('\r\n').pop().length > 60) {
                    output += '\r\n';
                }
            });
            terminal.instance.write(output + '\r\n');
        }
    },
    
    changeDirectory: function(terminalId, path) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        if (!path || path === '~') {
            terminal.currentDir = '/';
        } else if (path === '..') {
            if (terminal.currentDir !== '/') {
                const parts = terminal.currentDir.split('/').filter(Boolean);
                parts.pop();
                terminal.currentDir = '/' + parts.join('/');
            }
        } else if (path === '.') {
            // Stay in current directory
        } else {
            const newPath = (terminal.currentDir === '/' ? '' : terminal.currentDir) + '/' + path;
            // Check if "directory" exists (has files with this prefix)
            const hasFiles = Object.keys(IDE.state.files).some(f => 
                f.startsWith(newPath + '/')
            );
            
            if (hasFiles) {
                terminal.currentDir = newPath;
            } else {
                terminal.instance.write(`cd: ${path}: No such directory\r\n`);
            }
        }
    },
    
    showFile: function(terminalId, filename) {
        const terminal = this.terminals[terminalId];
        if (!terminal || !filename) {
            terminal?.instance.write('Usage: cat <filename>\r\n');
            return;
        }
        
        const filePath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + filename;
        const content = FileSystem.read(filePath);
        
        if (content !== undefined) {
            // Show with syntax highlighting for known file types
            const ext = Utils.getExtension(filename);
            if (['js', 'ts', 'py', 'json', 'html', 'css'].includes(ext)) {
                // Add some basic syntax highlighting
                const lines = content.split('\n');
                lines.forEach(line => {
                    // Simple keyword highlighting
                    const highlighted = line
                        .replace(/(function|class|import|export|const|let|var|return|if|else|for|while)/g, '\x1b[1;35m$1\x1b[0m')
                        .replace(/(true|false|null|undefined)/g, '\x1b[1;33m$1\x1b[0m')
                        .replace(/("[^"]*"|'[^']*')/g, '\x1b[1;32m$1\x1b[0m')
                        .replace(/(\/\/.*)/g, '\x1b[90m$1\x1b[0m');
                    
                    terminal.instance.write(highlighted + '\r\n');
                });
            } else {
                terminal.instance.write(content + '\r\n');
            }
        } else {
            terminal.instance.write(`cat: ${filename}: No such file\r\n`);
        }
    },
    
    createDirectory: function(terminalId, dirname) {
        const terminal = this.terminals[terminalId];
        if (!terminal || !dirname) {
            terminal?.instance.write('Usage: mkdir <directory>\r\n');
            return;
        }
        
        const dirPath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + dirname + '/.keep';
        FileSystem.write(dirPath, '# Directory created from terminal');
        
        terminal.instance.write(`Directory '${dirname}' created\r\n`);
    },
    
    createFile: function(terminalId, filename) {
        const terminal = this.terminals[terminalId];
        if (!terminal || !filename) {
            terminal?.instance.write('Usage: touch <filename>\r\n');
            return;
        }
        
        const filePath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + filename;
        FileSystem.write(filePath, `# Created from terminal\n# ${new Date().toISOString()}`);
        
        terminal.instance.write(`File '${filename}' created\r\n`);
    },
    
    removeFile: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal || args.length === 0) {
            terminal?.instance.write('Usage: rm <file> [-r for directories]\r\n');
            return;
        }
        
        const recursive = args.includes('-r') || args.includes('-rf');
        const files = args.filter(arg => !arg.startsWith('-'));
        
        files.forEach(filename => {
            const filePath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + filename;
            
            if (FileSystem.exists(filePath)) {
                FileSystem.delete(filePath, true);
                terminal.instance.write(`Removed: ${filename}\r\n`);
            } else {
                terminal.instance.write(`rm: ${filename}: No such file or directory\r\n`);
            }
        });
    },
    
    copyFile: function(terminalId, source, destination) {
        const terminal = this.terminals[terminalId];
        if (!terminal || !source || !destination) {
            terminal?.instance.write('Usage: cp <source> <destination>\r\n');
            return;
        }
        
        const sourcePath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + source;
        const destPath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + destination;
        
        if (!FileSystem.exists(sourcePath)) {
            terminal.instance.write(`cp: ${source}: No such file or directory\r\n`);
            return;
        }
        
        const content = FileSystem.read(sourcePath);
        FileSystem.write(destPath, content);
        
        terminal.instance.write(`Copied: ${source} -> ${destination}\r\n`);
    },
    
    moveFile: function(terminalId, source, destination) {
        const terminal = this.terminals[terminalId];
        if (!terminal || !source || !destination) {
            terminal?.instance.write('Usage: mv <source> <destination>\r\n');
            return;
        }
        
        const sourcePath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + source;
        const destPath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + destination;
        
        if (!FileSystem.exists(sourcePath)) {
            terminal.instance.write(`mv: ${source}: No such file or directory\r\n`);
            return;
        }
        
        FileSystem.moveFile(sourcePath, destPath);
        terminal.instance.write(`Moved: ${source} -> ${destination}\r\n`);
    },
    
    findFiles: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal || args.length === 0) {
            terminal?.instance.write('Usage: find <pattern> [-name pattern] [-type f|d]\r\n');
            return;
        }
        
        const namePattern = args[args.indexOf('-name') + 1] || args[0];
        const typeFilter = args[args.indexOf('-type') + 1];
        
        const pathPrefix = terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/';
        const files = Object.keys(IDE.state.files)
            .filter(f => f.startsWith(pathPrefix))
            .map(f => f.substring(pathPrefix.length))
            .filter(f => {
                // Apply name pattern
                if (namePattern && namePattern !== '*') {
                    const regex = new RegExp(namePattern.replace(/\*/g, '.*'));
                    if (!regex.test(f)) return false;
                }
                
                // Apply type filter
                if (typeFilter === 'f' && f.endsWith('/')) return false;
                if (typeFilter === 'd' && !f.endsWith('/')) return false;
                
                return true;
            })
            .sort();
        
        if (files.length === 0) {
            terminal.instance.write('No files found\r\n');
            return;
        }
        
        files.forEach(file => {
            terminal.instance.write(`./${file}\r\n`);
        });
    },
    
    grepFiles: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal || args.length < 2) {
            terminal?.instance.write('Usage: grep <pattern> <file> [-i] [-n]\r\n');
            return;
        }
        
        const pattern = args[0];
        const filename = args[1];
        const caseInsensitive = args.includes('-i');
        const showLineNumbers = args.includes('-n');
        
        const filePath = (terminal.currentDir === '/' ? '' : terminal.currentDir.substring(1) + '/') + filename;
        const content = FileSystem.read(filePath);
        
        if (content === undefined) {
            terminal.instance.write(`grep: ${filename}: No such file\r\n`);
            return;
        }
        
        const regex = new RegExp(pattern, caseInsensitive ? 'gi' : 'g');
        const lines = content.split('\n');
        let matchCount = 0;
        
        lines.forEach((line, index) => {
            if (regex.test(line)) {
                matchCount++;
                const lineNum = showLineNumbers ? `${index + 1}:` : '';
                terminal.instance.write(`${lineNum}${line}\r\n`);
            }
        });
        
        if (matchCount === 0) {
            terminal.instance.write('No matches found\r\n');
        }
    },
    
    runPython: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        if (args.length === 0) {
            terminal.instance.write('Python interactive mode is not available in this environment.\r\n');
            terminal.instance.write('Tip: run a file with "python <file>" or use the Run button.\r\n');
            return;
        }
        
        const filePath = args[0];
        terminal.instance.write('Node.js is not available; running in browser preview instead.\r\n');
        Runner.execute(filePath);
    },
    
    runNode: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        if (args.length === 0) {
            terminal.instance.write('Node.js interactive mode is not available in this environment.\r\n');
            terminal.instance.write('Tip: run a file with "node <file>" or use the Run button.\r\n');
            return;
        }
        
        const filePath = args[0];
        Runner.execute(filePath);
    },
    
    runNpm: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        terminal.instance.write('npm is not available in this environment. Use an external terminal.\r\n');
    },
    
    runGit: function(terminalId, args) {
        const terminal = this.terminals[terminalId];
        if (!terminal) return;
        
        terminal.instance.write('git is not available in this environment. Use an external terminal.\r\n');
    },
    
    write: function(text, terminalId = null) {
        const id = terminalId || this.activeTerminal;
        const terminal = this.terminals[id];
        if (terminal) {
            terminal.instance.write(text);
        }
    },
    
    clear: function(terminalId = null) {
        const id = terminalId || this.activeTerminal;
        const terminal = this.terminals[id];
        if (terminal) {
            terminal.instance.clear();
            this.writeWelcome(id);
        }
    },
    
    fit: function(terminalId = null) {
        const id = terminalId || this.activeTerminal;
        const terminal = this.terminals[id];
        if (terminal && terminal.fitAddon) {
            terminal.fitAddon.fit();
        }
    },
    
    createNewTerminal: function() {
        const id = this.createTerminal();
        this.setActiveTerminal(id);
        this.updateTerminalUI();
        return id;
    },
    
    closeTerminal: function(terminalId) {
        if (terminalId === 'default') {
            this.clear(terminalId);
            return;
        }
        
        if (this.terminals[terminalId]) {
            delete this.terminals[terminalId];
            
            // Switch to default terminal if closing active
            if (this.activeTerminal === terminalId) {
                this.setActiveTerminal('default');
            }
            
            this.updateTerminalUI();
        }
    },
    
    updateTerminalUI: function() {
        const terminalCount = Object.keys(this.terminals).length;
        const termBadge = document.getElementById('term-badge');
        if (termBadge) {
            termBadge.textContent = terminalCount;
        }
        
        // Update terminal switcher UI if exists
        // This would show tabs for multiple terminals
    }
};

// ============================================
// CONSOLE MANAGER
// ============================================
const Console = {
    maxEntries: 500,
    unreadCount: 0,
    
    getHost: function() {
        return document.getElementById('console-host');
    },
    
    getBadge: function() {
        return document.getElementById('console-badge');
    },
    
    init: function() {
        this.clear();
    },
    
    isConsoleVisible: function() {
        const panel = document.getElementById('panel-btm');
        if (!panel || panel.classList.contains('hidden')) {
            return false;
        }
        return IDE.state.panel === 'console';
    },
    
    formatArg: function(arg) {
        if (arg instanceof Error) {
            return `${arg.name}: ${arg.message}`;
        }
        if (typeof arg === 'object') {
            try {
                return JSON.stringify(arg, null, 2);
            } catch (error) {
                return String(arg);
            }
        }
        return String(arg);
    },
    
    append: function(level, args) {
        const host = this.getHost();
        if (!host) {
            return;
        }
        
        const line = document.createElement('div');
        const safeArgs = Array.isArray(args) ? args : [args];
        const safeLevel = ['log', 'info', 'warn', 'error', 'success'].includes(level) ? level : 'log';
        line.className = `console-line console-${safeLevel}`;
        line.textContent = safeArgs.map((arg) => this.formatArg(arg)).join(' ');
        host.appendChild(line);
        
        while (host.children.length > this.maxEntries) {
            host.removeChild(host.firstChild);
        }
        
        host.scrollTop = host.scrollHeight;
        
        if (!this.isConsoleVisible()) {
            this.unreadCount += 1;
            this.updateBadge();
        } else {
            this.resetBadge();
        }
    },
    
    log: function(...args) {
        this.append('log', args);
    },
    
    info: function(...args) {
        this.append('info', args);
    },
    
    warn: function(...args) {
        this.append('warn', args);
    },
    
    error: function(...args) {
        this.append('error', args);
    },
    
    success: function(...args) {
        this.append('success', args);
    },
    
    clear: function() {
        const host = this.getHost();
        if (host) {
            host.innerHTML = '';
        }
        this.resetBadge();
    },
    
    updateBadge: function() {
        const badge = this.getBadge();
        if (!badge) return;
        
        if (this.unreadCount > 0) {
            badge.textContent = this.unreadCount;
            badge.style.display = 'inline-flex';
        } else {
            badge.style.display = 'none';
        }
    },
    
    resetBadge: function() {
        this.unreadCount = 0;
        this.updateBadge();
    }
};

// ============================================
// ENHANCED RUNNER (Code Execution)
// ============================================
const Runner = {
    currentProcess: null,
    isRunning: false,
    executionHistory: [],
    _iframeListenerAttached: false,
    
    exec: function(filePath = null) {
        this.execute(filePath);
    },
    
    execute: function(filePath = null) {
        const path = filePath || IDE.state.activeTab;
        if (!path) {
            Utils.toast('No file to run', 'error');
            return;
        }
        
        if (!FileSystem.exists(path)) {
            Utils.toast(`File not found: ${path}`, 'error');
            return;
        }
        
        const ext = Utils.getExtension(path);
        
        // Add to execution history
        this.executionHistory.push({
            path: path,
            timestamp: new Date().toISOString(),
            type: ext
        });
        
        // Keep only last 50 executions
        if (this.executionHistory.length > 50) {
            this.executionHistory.shift();
        }
        
        switch(ext) {
            case 'html':
            case 'css':
            case 'js':
            case 'jsx':
            case 'ts':
            case 'tsx':
            case 'vue':
                this.runWeb(path);
                break;
                
            case 'py':
                this.runPython(path);
                break;
                
            default:
                Utils.toast(`Cannot run .${ext} files`, 'error');
        }
    },
    
    runWeb: function(path) {
        this.isRunning = true;
        this.lastInlineWarnings = [];
        
        // Show preview panel
        LayoutManager.toggleLayout('preview', true);
        
        const frame = document.getElementById('preview-frame');
        const isHtml = path.endsWith('.html');
        
        let html = '';
        
        if (isHtml) {
            html = FileSystem.read(path);
            html = this.inlineHtmlAssets(html, path);
        } else {
            html = this.createHtmlWrapper(path);
        }
        
        // Set iframe source
        frame.srcdoc = html;
        frame.onload = () => {
            this.updateRunButton(false);
        };
        
        // Update console
        Console.clear();
        if (this.lastInlineWarnings && this.lastInlineWarnings.length) {
            this.lastInlineWarnings.forEach((message) => Console.warn(message));
        }
        Console.info(` Running ${path.split('/').pop()}...`);
        Console.info(` File: ${path}`);
        Console.info(` Preview opened in panel`);
        Console.info('-'.repeat(50));
        
        // Listen for console messages from iframe
        if (!this._iframeListenerAttached) {
            window.addEventListener('message', this.handleIframeMessage);
            this._iframeListenerAttached = true;
        }
        
        Utils.toast('Running web application', 'success');
        
        // Update run button
        this.updateRunButton(true);
    },
    
    handleIframeMessage: function(event) {
        const frame = document.getElementById('preview-frame');
        if (frame && event.source !== frame.contentWindow) {
            return;
        }
        
        const data = event.data;
        if (!data || typeof data !== 'object') {
            return;
        }
        
        if (data.type === 'console') {
            const level = data.level || 'log';
            const args = Array.isArray(data.args) ? data.args : [data.args];
            Console.append(level, args);
            return;
        }
        
        if (data.type === 'load') {
            if (data.executionTime) {
                Console.info(`Execution time: ${data.executionTime}ms`);
            } else {
                Console.info('Preview loaded');
            }
            Runner.updateRunButton(false);
        }
    },
    
    inlineHtmlAssets: function(html, htmlPath) {
        this.lastInlineWarnings = [];
        const baseDir = htmlPath.includes('/') ? htmlPath.slice(0, htmlPath.lastIndexOf('/')) : '';
        const isRemote = (url) => /^(https?:)?\/\//i.test(url) || url.startsWith('data:') || url.startsWith('blob:') || url.startsWith('mailto:') || url.startsWith('tel:');
        const hasModuleSyntax = (code) => this.hasModuleSyntax(code);
        const normalizePath = (path) => {
            const parts = path.split('/').filter(Boolean);
            const stack = [];
            for (const part of parts) {
                if (part === '.') continue;
                if (part === '..') {
                    stack.pop();
                } else {
                    stack.push(part);
                }
            }
            return stack.join('/');
        };
        const resolvePath = (url) => {
            if (url.startsWith('/')) return normalizePath(url.slice(1));
            if (!baseDir) return normalizePath(url);
            return normalizePath(`${baseDir}/${url}`);
        };
        const readSafe = (filePath) => {
            try {
                return FileSystem.read(filePath);
            } catch (_) {
                return null;
            }
        };
        const warn = (message) => {
            this.lastInlineWarnings.push(message);
        };

        let updated = html;

        updated = updated.replace(/<link\b[^>]*rel=["']?stylesheet["']?[^>]*>/gi, (match) => {
            const hrefMatch = match.match(/href=["']([^"']+)["']/i);
            if (!hrefMatch) return match;
            const href = hrefMatch[1].trim();
            const cleanHref = href.split('#')[0].split('?')[0];
            if (!cleanHref || href.startsWith('#') || isRemote(href)) return match;

            const filePath = resolvePath(cleanHref);
            const css = readSafe(filePath);
            if (css === null) {
                warn(`Missing stylesheet: ${filePath}`);
                return '';
            }

            const safeCss = css.replace(/<\/style>/gi, '<\\/style>');
            return `<style data-inline="${filePath}">\n${safeCss}\n</style>`;
        });

        updated = updated.replace(/<script\b([^>]*)\bsrc=["']([^"']+)["']([^>]*)>\s*<\/script>/gi, (match, before, src, after) => {
            const href = src.trim();
            const cleanHref = href.split('#')[0].split('?')[0];
            if (!cleanHref || href.startsWith('#') || isRemote(href)) return match;

            const filePath = resolvePath(cleanHref);
            const js = readSafe(filePath);
            if (js === null) {
                warn(`Missing script: ${filePath}`);
                return '';
            }
            const ext = Utils.getExtension(filePath);
            if (ext && !['js', 'mjs'].includes(ext)) {
                warn(`Unsupported script type for preview: ${filePath}. Use a bundler or UMD template.`);
                return '';
            }

            const attrsRaw = `${before} ${after}`;
            const isModule = /\btype=["']module["']/.test(attrsRaw);
            let scriptBody = js;
            let moduleWarnings = [];
            if (isModule || hasModuleSyntax(scriptBody)) {
                const stripped = this.stripModuleSyntax(scriptBody);
                moduleWarnings = stripped.warnings;
                scriptBody = stripped.code;
            }
            moduleWarnings.forEach((message) => warn(message));
            if (!scriptBody.trim()) {
                warn(`Removed script requiring modules: ${filePath}`);
                return '';
            }
            if (hasModuleSyntax(scriptBody)) {
                warn(`Module script still contains imports/exports: ${filePath}`);
                return '';
            }

            const safeJs = scriptBody.replace(/<\/script>/gi, '<\\/script>');
            let attrs = attrsRaw.replace(/\bsrc=["'][^"']+["']/i, '');
            if (isModule) {
                attrs = attrs.replace(/\btype=["']module["']\b/i, '');
            }
            attrs = attrs.trim();
            const attrText = attrs ? ` ${attrs}` : '';
            return `<script data-inline="${filePath}"${attrText}>\n${safeJs}\n<\/script>`;
        });

        updated = updated.replace(/<script\b([^>]*)>([\s\S]*?)<\/script>/gi, (match, attrs, body) => {
            if (/\bsrc=["']/.test(attrs) || /\bdata-inline=/.test(attrs)) {
                return match;
            }
            const isModule = /\btype=["']module["']/.test(attrs);
            const code = body.trim();
            if (!code) return match;
            if (!isModule && !hasModuleSyntax(code)) return match;

            const stripped = this.stripModuleSyntax(code);
            stripped.warnings.forEach((message) => warn(message));
            const cleaned = stripped.code.trim();
            if (!cleaned) {
                warn('Removed inline module script from preview');
                return '';
            }
            if (hasModuleSyntax(cleaned)) {
                warn('Inline module script still contains imports/exports');
                return '';
            }

            let newAttrs = attrs;
            if (isModule) {
                newAttrs = newAttrs.replace(/\btype=["']module["']\b/i, '');
            }
            newAttrs = newAttrs.trim();
            const attrText = newAttrs ? ` ${newAttrs}` : '';
            const safeBody = cleaned.replace(/<\/script>/gi, '<\\/script>');
            return `<script${attrText}>\n${safeBody}\n<\/script>`;
        });

        return updated;
    },

    hasModuleSyntax: function(code) {
        return (
            /^\s*(import\s+|export\s+)/m.test(code) ||
            /\brequire\s*\(/.test(code) ||
            /\bmodule\.exports\b/.test(code) ||
            /\bexports\./.test(code)
        );
    },

    stripModuleSyntax: function(code) {
        const warnings = [];
        const lines = code.split(/\r?\n/);
        const kept = [];

        lines.forEach((line) => {
            const trimmed = line.trim();
            if (/^import\s/.test(trimmed)) {
                warnings.push(`Stripped import: ${trimmed}`);
                return;
            }
            if (/^export\s+default\s+/.test(trimmed)) {
                warnings.push(`Stripped export default: ${trimmed}`);
                kept.push(line.replace(/^\s*export\s+default\s+/, 'const __default_export__ = '));
                return;
            }
            if (/^export\s+{/.test(trimmed)) {
                warnings.push(`Stripped export list: ${trimmed}`);
                return;
            }
            if (/^export\s+(const|let|var|function|class)\s+/.test(trimmed)) {
                warnings.push(`Stripped export keyword: ${trimmed}`);
                kept.push(line.replace(/^\s*export\s+/, ''));
                return;
            }
            kept.push(line);
        });

        return { code: kept.join('\n'), warnings };
    },

    createHtmlWrapper: function(path) {
        const fileName = path.split('/').pop();
        const content = FileSystem.read(path);
        const ext = Utils.getExtension(path);
        
        let processedCode = content;
        let additionalScripts = '';
        let additionalStyles = '';
        const moduleWarning = (label) =>
            'console.error("Module imports/exports detected in ' + label + '. The preview cannot resolve modules. Use a UMD template or run a bundler.");';
        const indentLines = (value, spaces) => value
            .split('\n')
            .map(line => ' '.repeat(spaces) + line)
            .join('\n');
        
        // Process based on file type
        switch (ext) {
            case 'jsx':
            case 'tsx':
                try {
                    const babelPresets = ext === 'tsx'
                        ? [['env', { modules: false }], 'react', ['typescript', { isTSX: true, allExtensions: true }]]
                        : [['env', { modules: false }], 'react'];
                    processedCode = Babel.transform(content, {
                        presets: babelPresets,
                        filename: path
                    }).code;
                    additionalScripts = '<script src="https://unpkg.com/react@18/umd/react.development.js"><\/script>\n' +
                                       '<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>';
                } catch (error) {
                    Console.error(`JSX Transpilation Error: ${error.message}`);
                    processedCode = `console.error("JSX Transpilation Error: ${error.message}");`;
                }
                break;
                
            case 'ts':
                try {
                    processedCode = ts.transpileModule(content, {
                        compilerOptions: {
                            target: ts.ScriptTarget.ES2020,
                            module: ts.ModuleKind.None
                        }
                    }).outputText;
                } catch (error) {
                    Console.error(`TypeScript Compilation Error: ${error.message}`);
                    processedCode = `console.error("TypeScript Compilation Error: ${error.message}");`;
                }
                break;
                
            case 'css': {
                const safeCss = content.replace(/<\/style>/gi, '<\\/style>');
                additionalStyles = `<style>\n${safeCss}\n</style>`;
                processedCode = '';
                break;
            }

            case 'vue':
                try {
                    // Simple Vue template compilation
                    const templateMatch = content.match(/<template>([\s\S]*?)<\/template>/);
                    const scriptTagMatch = content.match(/<script([^>]*)>([\s\S]*?)<\/script>/i);
                    const styleMatch = content.match(/<style[\s\S]*?>([\s\S]*?)<\/style>/);
                    
                    additionalScripts = '<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"><\/script>';
                    
                    const template = templateMatch ? templateMatch[1].trim() : '';
                    const scriptAttrs = scriptTagMatch ? scriptTagMatch[1] : '';
                    let script = scriptTagMatch ? scriptTagMatch[2].trim() : '';
                    const isSetup = /\bsetup\b/i.test(scriptAttrs);
                    const isTs = /\blang=['"]ts['"]/i.test(scriptAttrs);
                    const vueImports = new Set();
                    const warnings = [];
                    const bindingNames = new Set();

                    if (script) {
                        const scriptLines = script.split(/\r?\n/);
                        const keptLines = [];
                        scriptLines.forEach((line) => {
                            const trimmed = line.trim();
                            const vueNamedImport = trimmed.match(/^import\s+{([^}]+)}\s+from\s+['"]vue['"];?$/);
                            if (vueNamedImport) {
                                vueNamedImport[1].split(',').forEach((name) => {
                                    const clean = name.trim().split(' as ')[0];
                                    if (clean) vueImports.add(clean);
                                });
                                return;
                            }
                            if (/^import\s+[A-Za-z_$][\w$]*\s+from\s+['"]vue['"];?$/.test(trimmed)) {
                                return;
                            }
                            if (/^import\s+/.test(trimmed)) {
                                warnings.push('Module import ignored in preview: ' + trimmed);
                                return;
                            }
                            keptLines.push(line);
                        });
                        script = keptLines.join('\n');

                        script.split(/\r?\n/).forEach((line) => {
                            let match = line.match(/^\s*(?:const|let|var)\s+([A-Za-z_$][\w$]*)/);
                            if (match) {
                                bindingNames.add(match[1]);
                                return;
                            }
                            match = line.match(/^\s*function\s+([A-Za-z_$][\w$]*)/);
                            if (match) {
                                bindingNames.add(match[1]);
                            }
                        });
                    }

                    if (vueImports.size) {
                        script = 'const { ' + Array.from(vueImports).join(', ') + ' } = Vue;\n' + script;
                    }

                    if (isTs && script) {
                        script = ts.transpileModule(script, {
                            compilerOptions: {
                                target: ts.ScriptTarget.ES2020,
                                module: ts.ModuleKind.None
                            }
                        }).outputText;
                    }

                    const warningsCode = warnings.map((warning) =>
                        'console.warn(' + JSON.stringify(warning) + ');'
                    ).join('\n');
                    const safeTemplate = template.replace(/`/g, '\\`');

                    if (!template) {
                        processedCode = "console.error('Vue template missing <template> block.');";
                    } else if (isSetup) {
                        const returnNames = Array.from(bindingNames);
                        const returnLine = returnNames.length
                            ? 'return { ' + returnNames.join(', ') + ' };'
                            : 'return {};';
                        const setupBody = [warningsCode, script, returnLine].filter(Boolean).join('\n');
                        const indentedSetup = indentLines(setupBody, 12);

                        processedCode = `
                            const { createApp } = Vue;

                            const component = {
                                setup() {
${indentedSetup}
                                }
                            };

                            component.template = \`${safeTemplate}\`;
                            createApp(component).mount('#app');
                        `;
                    } else {
                        let componentScript = script || '';
                        if (componentScript && /\bexport\s+default\b/.test(componentScript)) {
                            componentScript = componentScript.replace(/\bexport\s+default\b/, 'const component =');
                        } else if (!componentScript) {
                            componentScript = 'const component = {};';
                        } else if (!/\bcomponent\b/.test(componentScript)) {
                            componentScript = 'const component = {};\n' + componentScript;
                        }

                        const body = [warningsCode, componentScript].filter(Boolean).join('\n');

                        processedCode = `
                            const { createApp } = Vue;
                            ${body}

                            if (typeof component !== 'undefined') {
                                component.template = \`${safeTemplate}\`;
                                createApp(component).mount('#app');
                            } else {
                                console.error('Vue component not found');
                            }
                        `;
                    }
                    
                    if (styleMatch) {
                        const safeStyle = styleMatch[1].replace(/<\/style>/gi, '<\\/style>');
                        additionalStyles = `<style>${safeStyle}</style>`;
                    }
                } catch (error) {
                    Console.error(`Vue Compilation Error: ${error.message}`);
                    processedCode = `console.error("Vue Compilation Error: ${error.message}");`;
                }
                break;
        }
        
        if (processedCode && this.hasModuleSyntax(processedCode)) {
            const stripped = this.stripModuleSyntax(processedCode);
            if (stripped.warnings.length) {
                const warningCode = stripped.warnings.map((message) =>
                    `console.warn(${JSON.stringify(message)});`
                ).join('\n');
                processedCode = `${warningCode}\n${stripped.code}`;
            } else {
                processedCode = stripped.code;
            }
            if (this.hasModuleSyntax(processedCode)) {
                processedCode = moduleWarning(fileName);
            }
        }

        const safeProcessedCode = processedCode
            ? processedCode.replace(/<\/script>/gi, '<\\/script>')
            : '';
        
        return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${fileName} - ProCode Preview</title>
    ${additionalScripts}
    ${additionalStyles}
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 2rem; 
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        header { 
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        .console-output { 
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            min-height: 200px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            overflow-y: auto;
            max-height: 400px;
        }
        .console-title {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .log { color: #e2e8f0; }
        .error { color: #ef4444; }
        .warn { color: #f59e0b; }
        .info { color: #3b82f6; }
        .success { color: #22c55e; }
        pre { 
            background: #0f172a; 
            color: #e2e8f0; 
            padding: 1rem; 
            border-radius: 8px; 
            overflow: auto;
            margin: 1rem 0;
            font-size: 11px;
        }
        .execution-time {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #334155;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>${fileName}</h1>
            <p>Running in ProCode IDE Preview  ${new Date().toLocaleTimeString()}</p>
        </header>
        
        <div id="app"></div>
        <div id="root"></div>
        <div id="app-output"></div>
        
        <div class="console-output">
            <div class="console-title">
                <span>Console Output</span>
                <button onclick="clearConsole()" style="background:#334155; color:#94a3b8; border:none; padding:4px 12px; border-radius:4px; font-size:11px; cursor:pointer;">
                    Clear
                </button>
            </div>
            <div id="console-output"></div>
            <div class="execution-time" id="execution-time"></div>
        </div>
    </div>
    
    <script>
        const startTime = performance.now();
        const consoleOutput = document.getElementById('console-output');
        const executionTime = document.getElementById('execution-time');
        
        function addOutput(type, args) {
            if (!consoleOutput) return;
            const argList = Array.isArray(args) ? args : [args];
            const div = document.createElement('div');
            div.className = type;
            
            const safeArgs = argList.map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg, null, 2);
                    } catch (error) {
                        return String(arg);
                    }
                }
                return String(arg);
            });

            const escapeHtml = (value) => String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            const formattedArgs = argList.map((arg, index) => {
                const safe = escapeHtml(safeArgs[index]);
                if (typeof arg === 'object') {
                    return '<pre>' + safe + '</pre>';
                }
                return '<span>' + safe + '</span>';
            }).join(' ');
            
            div.innerHTML = formattedArgs;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Send to parent for IDE console
            try {
                window.parent.postMessage({
                    type: 'console',
                    level: type,
                    args: safeArgs
                }, '*');
            } catch (error) {
                // Ignore postMessage errors for non-serializable data
            }
        }

        const nativeConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        function interceptConsole(level) {
            return function(...args) {
                if (nativeConsole[level]) {
                    nativeConsole[level].apply(console, args);
                }
                addOutput(level, args);
            };
        }

        function clearConsole() {
            if (consoleOutput) {
                consoleOutput.innerHTML = '';
            }
            if (executionTime) {
                executionTime.textContent = '';
            }
        }

        console.log = interceptConsole('log');
        console.error = interceptConsole('error');
        console.warn = interceptConsole('warn');
        console.info = interceptConsole('info');

        // Performance monitoring
        window.addEventListener('load', function() {
            const endTime = performance.now();
            const executionTime = (endTime - startTime).toFixed(2);
            
            document.getElementById('execution-time').textContent =
                'Execution time: ' + executionTime + 'ms';
            
            window.parent.postMessage({ 
                type: 'load',
                executionTime: executionTime 
            }, '*');
        });
    <\/script>
    
    <script>
        ${safeProcessedCode}
    <\/script>
</body>
</html>`;
    },
    
    runPython: function(path) {
        Console.clear();
        Console.info(` Running Python: ${path}`);
        this.updateRunButton(true);
        
        if (!window.pyodide) {
            Console.info('Loading Pyodide runtime...');
            
            loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/"
            }).then(pyodide => {
                window.pyodide = pyodide;
                this.executePythonCode(path);
            }).catch(error => {
                Console.error('Failed to load Pyodide:', error);
                this.updateRunButton(false);
            });
        } else {
            this.executePythonCode(path);
        }
    },
    
    executePythonCode: function(path) {
        const code = FileSystem.read(path);
        const fileName = path.split('/').pop();
        
        Console.info(` Executing: ${fileName}`);
        Console.info('-'.repeat(50));
        
        try {
            // Set up Python environment
            window.pyodide.runPython(`
import sys
import io
import traceback

# Capture stdout and stderr
class OutputCapture:
    def __init__(self):
        self.buffer = []
    
    def write(self, text):
        self.buffer.append(text)
    
    def flush(self):
        pass
    
    def get_output(self):
        return ''.join(self.buffer)

stdout_capture = OutputCapture()
stderr_capture = OutputCapture()
sys.stdout = stdout_capture
sys.stderr = stderr_capture
`);
            
            // Execute the code
            window.pyodide.runPython(code);
            
            // Get captured output
            const stdout = window.pyodide.runPython('stdout_capture.get_output()');
            const stderr = window.pyodide.runPython('stderr_capture.get_output()');
            
            if (stdout) {
                Console.info('Output:');
                stdout.split('\n').forEach(line => {
                    if (line.trim()) Console.log(line);
                });
            }
            
            if (stderr) {
                Console.error('Errors:');
                stderr.split('\n').forEach(line => {
                    if (line.trim()) Console.error(line);
                });
            }
            
            Console.info('-'.repeat(50));
            Console.success(' Python execution completed');
            
        } catch (error) {
            Console.error('Python execution failed:');
            Console.error(error.toString());
            
            // Try to get Python traceback
            try {
                const traceback = window.pyodide.runPython(`
import traceback
try:
    traceback.format_exc()
except:
    "No traceback available"
`);
                if (traceback && traceback !== 'None') {
                    Console.error('Traceback:');
                    traceback.split('\n').forEach(line => {
                        if (line.trim()) Console.error(line);
                    });
                }
            } catch (e) {
                // Ignore traceback errors
            }
        } finally {
            this.updateRunButton(false);
        }
    },
    
    reload: function() {
        const frame = document.getElementById('preview-frame');
        if (frame) {
            frame.srcdoc = frame.srcdoc;
            Console.info('Preview reloaded');
        }
    },
    
    popout: function() {
        const frame = document.getElementById('preview-frame');
        const html = frame.srcdoc;
        
        const newWindow = window.open('', '_blank');
        newWindow.document.write(html);
        newWindow.document.close();
        
        Utils.toast('Opened in new window', 'info');
    },
    
    toggleMobile: function() {
        const frame = document.getElementById('preview-frame');
        frame.classList.toggle('mobile-preview');
        
        if (frame.classList.contains('mobile-preview')) {
            frame.style.width = '375px';
            frame.style.margin = '0 auto';
            frame.style.border = '16px solid #333';
            frame.style.borderRadius = '36px';
            Console.info(' Mobile preview enabled');
        } else {
            frame.style.width = '100%';
            frame.style.margin = '0';
            frame.style.border = 'none';
            frame.style.borderRadius = '0';
            Console.info(' Desktop preview enabled');
        }
    },
    
    updateRunButton: function(isRunning) {
        this.isRunning = isRunning;
        
        const button = document.getElementById('run-btn');
        if (!button) return;
        
        if (isRunning) {
            button.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> RUNNING';
            button.setAttribute('aria-busy', 'true');
        } else {
            button.innerHTML = '<i class="fas fa-play"></i> RUN';
            button.removeAttribute('aria-busy');
        }
    }
};

// ============================================
// DEBUGGER MANAGER
// ============================================
const Debugger = {
    isActive: false,
    breakpoints: new Map(),
    variables: {},
    callStack: [],
    
    toggle: function() {
        this.isActive = !this.isActive;
        
        if (this.isActive) {
            this.start();
        } else {
            this.stop();
        }
        
        Utils.toast(`Debugger ${this.isActive ? 'enabled' : 'disabled'}`, 
                   this.isActive ? 'success' : 'info');
    },
    
    start: function() {
        Console.clear();
        Console.info(' Debugger started');
        Console.info('Breakpoints: None');
        Console.info('Variables: Waiting for execution...');
        
        // Update UI
        const debugBtn = document.querySelector('[title*="Debug"]');
        if (debugBtn) {
            debugBtn.style.color = 'var(--error)';
            debugBtn.innerHTML = '<i class="fas fa-bug"></i> DEBUG ON';
        }
        
        // Initialize debug panel
        Panel.show('console');
        
        // Setup breakpoint markers in editor
        this.setupBreakpoints();
    },
    
    stop: function() {
        Console.info(' Debugger stopped');
        
        // Clear breakpoint markers
        this.clearBreakpoints();
        
        // Update UI
        const debugBtn = document.querySelector('[title*="Debug"]');
        if (debugBtn) {
            debugBtn.style.color = '';
            debugBtn.innerHTML = '<i class="fas fa-bug"></i>';
        }
        
        this.isActive = false;
    },
    
    setupBreakpoints: function() {
        // Add breakpoint decoration to editor
        const editor = EditorManager.getCurrentEditor();
        if (editor) {
            // Remove existing decorations
            this.clearBreakpoints();
            
            // Add breakpoint gutter
            const breakpointDecorations = [];
            
            this.breakpoints.forEach((bp, path) => {
                if (path === IDE.state.activeTab) {
                    breakpointDecorations.push({
                        range: new monaco.Range(bp.line, 1, bp.line, 1),
                        options: {
                            isWholeLine: false,
                            glyphMarginClassName: 'breakpoint-glyph',
                            glyphMarginHoverMessage: { value: 'Breakpoint' }
                        }
                    });
                }
            });
            
            editor.deltaDecorations([], breakpointDecorations);
        }
    },
    
    clearBreakpoints: function() {
        const editor = EditorManager.getCurrentEditor();
        if (editor) {
            const decorations = editor.getModel().getAllDecorations();
            const breakpointDecorations = decorations.filter(d => 
                d.options.glyphMarginClassName === 'breakpoint-glyph'
            );
            
            editor.deltaDecorations(
                breakpointDecorations.map(d => d.id),
                []
            );
        }
    },
    
    toggleBreakpoint: function(line) {
        const path = IDE.state.activeTab;
        if (!path) return;
        
        const key = `${path}:${line}`;
        
        if (this.breakpoints.has(key)) {
            this.breakpoints.delete(key);
            Console.info(` Breakpoint removed at line ${line}`);
        } else {
            this.breakpoints.set(key, {
                path: path,
                line: line,
                condition: null,
                hitCount: 0
            });
            Console.info(` Breakpoint added at line ${line}`);
        }
        
        this.setupBreakpoints();
    },
    
    continue: function() {
        Console.info(' Continuing execution...');
        // This would trigger the next breakpoint or run to completion
    },
    
    stepOver: function() {
        Console.info(' Stepping over...');
        // Step over the current line
    },
    
    stepInto: function() {
        Console.info(' Stepping into...');
        // Step into function
    },
    
    stepOut: function() {
        Console.info(' Stepping out...');
        // Step out of function
    },
    
    evaluateExpression: function(expression) {
        try {
            // Try to evaluate the expression
            const result = eval(expression);
            Console.log(` ${expression} = ${JSON.stringify(result)}`);
            return result;
        } catch (error) {
            Console.error(`Evaluation failed: ${error.message}`);
            return undefined;
        }
    },
    
    inspectVariable: function(name) {
        if (this.variables[name] !== undefined) {
            Console.log(` ${name}: ${JSON.stringify(this.variables[name], null, 2)}`);
            return this.variables[name];
        } else {
            Console.warn(`Variable "${name}" not found in current scope`);
            return undefined;
        }
    },
    
    watchExpression: function(expression) {
        // Add to watch list
        Console.info(` Watching: ${expression}`);
        
        // Evaluate and show initial value
        const value = this.evaluateExpression(expression);
        if (value !== undefined) {
            Console.log(`Initial value: ${JSON.stringify(value)}`);
        }
    },
    
    clearBreakpointsAll: function() {
        this.breakpoints.clear();
        this.clearBreakpoints();
        Console.info(' All breakpoints cleared');
    }
};

// ============================================
// PANEL MANAGER
// ============================================
const Panel = {
    show: function(panelId) {
        // Update active panel
        IDE.state.panel = panelId;
        
        // Update tab UI
        document.querySelectorAll('.panel-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-panel="${panelId}"]`).classList.add('active');
        
        // Show corresponding panel content
        const panels = ['term-host', 'console-host', 'problems-host', 'output-host'];
        panels.forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(`${panelId}-host`).classList.remove('hidden');
        
        if (panelId === 'console') {
            Console.resetBadge();
        }
        
        // Ensure panel is visible
        const panel = document.getElementById('panel-btm');
        if (panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
        }
        
        // Fit terminal if showing terminal
        if (panelId === 'term') {
            setTimeout(() => TerminalManager.fit(), 50);
        }
    },
    
    toggle: function() {
        const panel = document.getElementById('panel-btm');
        panel.classList.toggle('hidden');
        
        if (!panel.classList.contains('hidden')) {
            this.show(IDE.state.panel);
        }
    },
    
    resize: function(height) {
        const panel = document.getElementById('panel-btm');
        panel.style.height = `${height}px`;
        
        // Adjust editor container
        const editorContainer = document.getElementById('editor-container');
        if (editorContainer) {
            const headerHeight = document.querySelector('header').offsetHeight;
            const tabsHeight = document.querySelector('.tabs').offsetHeight;
            const workspaceHeight = window.innerHeight - headerHeight;
            const panelHeight = panel.classList.contains('hidden') ? 0 : height;
            
            editorContainer.style.height = `${workspaceHeight - tabsHeight - panelHeight}px`;
        }
        
        // Fit terminal
        TerminalManager.fit();
    }
};

// ============================================
// AI ASSISTANT MANAGER
// ============================================
const AI = {
    isVisible: false,
    messages: [],
    conversationId: Utils.uuid(),
    
    toggle: function() {
        this.isVisible = !this.isVisible;
        const aiFloat = document.getElementById('ai-float');
        
        if (this.isVisible) {
            aiFloat.style.display = 'flex';
            document.getElementById('ai-input').focus();
        } else {
            aiFloat.style.display = 'none';
        }
    },
    
    send: function() {
        const input = document.getElementById('ai-input');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Add user message
        this.addMessage(message, 'user');
        input.value = '';
        
        // Process locally
        this.showTyping(true);
        this.processQuery(message);
        this.showTyping(false);
    },
    
    processQuery: function(query) {
        let response = '';
        
        // Simple rule-based responses for demonstration
        if (query.toLowerCase().includes('hello') || query.toLowerCase().includes('hi')) {
            response = "Hello! I'm your AI coding assistant. How can I help you with your code today?";
        } else if (query.toLowerCase().includes('bug') || query.toLowerCase().includes('error')) {
            response = this.generateBugFixResponse(query);
        } else if (query.toLowerCase().includes('create') || query.toLowerCase().includes('generate')) {
            response = this.generateCodeResponse(query);
        } else if (query.toLowerCase().includes('explain') || query.toLowerCase().includes('how')) {
            response = this.generateExplanationResponse(query);
        } else if (query.toLowerCase().includes('optimize') || query.toLowerCase().includes('refactor')) {
            response = this.generateOptimizationResponse(query);
        } else {
            response = `I understand you're asking about "${query}". As an AI coding assistant, I can help you with:\n\n` +
                      `1. **Debugging**: Describe the error and I'll suggest fixes\n` +
                      `2. **Code Generation**: Ask me to create functions, components, or algorithms\n` +
                      `3. **Code Review**: Share your code and I'll suggest improvements\n` +
                      `4. **Learning**: Ask for explanations of concepts or code\n\n` +
                      `What would you like to focus on?`;
        }
        
        this.addMessage(response, 'assistant');
    },
    
    generateBugFixResponse: function(query) {
        const currentCode = EditorManager.getCurrentEditor()?.getValue() || '';
        
        // Simple bug detection for demonstration
        let suggestions = [];
        
        if (currentCode.includes('console.log') && !currentCode.includes('//')) {
            suggestions.push(" Remove console.log statements before production deployment");
        }
        
        if (currentCode.includes('var ')) {
            suggestions.push(" Replace 'var' with 'const' or 'let' for better scoping");
        }
        
        if (currentCode.includes('==') && !currentCode.includes('===')) {
            suggestions.push(" Use strict equality (===) instead of loose equality (==)");
        }
        
        if (currentCode.includes('forEach') && currentCode.includes('async')) {
            suggestions.push(" Use for...of loop instead of forEach with async functions");
        }
        
        if (suggestions.length === 0) {
            suggestions.push(" Review error messages in the console panel");
            suggestions.push(" Add try-catch blocks for error handling");
            suggestions.push(" Use TypeScript for type safety");
        }
        
        return `I'll help you debug! Based on common issues:\n\n${suggestions.map(s => ` ${s}`).join('\n')}\n\n` +
               `Could you share the specific error message or code snippet you're having trouble with?`;
    },
    
    generateCodeResponse: function(query) {
        const templates = {
            'react component': `import React from 'react';

interface Props {
  title: string;
  description?: string;
}

export const ExampleComponent: React.FC<Props> = ({ title, description }) => {
  const [count, setCount] = React.useState(0);

  return (
    <div className="example-component">
      <h2>{title}</h2>
      {description && <p>{description}</p>}
      <button onClick={() => setCount(count + 1)}>
        Clicked {count} times
      </button>
    </div>
  );
};`,
            
            'function': `/**
 * Description of what the function does
 * @param {type} paramName - Description of parameter
 * @returns {type} Description of return value
 */
function exampleFunction(paramName) {
  // Input validation
  if (!paramName) {
    throw new Error('paramName is required');
  }

  try {
    // Core logic here
    const result = paramName.toUpperCase();
    
    // Return the result
    return result;
  } catch (error) {
    // Error handling
    console.error('Function failed:', error);
    throw error;
  }
}`,
            
            'api call': `async function fetchData(url, options = {}) {
  const defaultOptions = {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
    },
    ...options
  };

  try {
    const response = await fetch(url, defaultOptions);
    
    if (!response.ok) {
      throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
    }
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('API call failed:', error);
    throw error;
  }
}`,
            
            'css grid': `.grid-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  padding: 1.5rem;
}

.grid-item {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  transition: transform 0.3s, box-shadow 0.3s;
}

.grid-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}`,
            
            'python class': `class ExampleClass:
    """A class example with proper typing and documentation"""
    
    def __init__(self, name: str, value: int = 0):
        """
        Initialize the class
        
        Args:
            name: The name of the instance
            value: Starting value
        """
        self.name = name
        self.value = value
        self._private_attr = "internal"
    
    def increment(self, amount: int = 1) -> int:
        """
        Increment the value
        
        Args:
            amount: Amount to increment by
            
        Returns:
            The new value
        """
        self.value += amount
        return self.value
    
    @property
    def display_name(self) -> str:
        """Formatted display name"""
        return f"{self.name}: {self.value}"
    
    @classmethod
    def create_default(cls) -> 'ExampleClass':
        """Factory method to create default instance"""
        return cls("default", 100)`
        };
        
        const lowerQuery = query.toLowerCase();
        let matchedTemplate = 'function';
        
        for (const [key, template] of Object.entries(templates)) {
            if (lowerQuery.includes(key)) {
                matchedTemplate = template;
                break;
            }
        }
        
        return `Here's a template for what you requested:\n\n\`\`\`${matchedTemplate.includes('interface Props') ? 'tsx' : matchedTemplate.includes('def ') ? 'python' : matchedTemplate.includes('class ') ? 'css' : 'javascript'}\n${matchedTemplate}\n\`\`\`\n\nWould you like me to customize this for your specific use case?`;
    },
    
    generateExplanationResponse: function(query) {
        const currentCode = EditorManager.getCurrentEditor()?.getValue() || '';
        const selection = EditorManager.getSelection();
        
        let codeToExplain = selection || currentCode;
        
        if (codeToExplain.length > 500) {
            codeToExplain = codeToExplain.substring(0, 500) + '...';
        }
        
        return `Let me explain this code:\n\n\`\`\`javascript\n${codeToExplain}\n\`\`\`\n\n**Key Points:**\n\n` +
               `1. **Purpose**: This code appears to be ${this.guessCodePurpose(codeToExplain)}\n` +
               `2. **Structure**: ${this.analyzeCodeStructure(codeToExplain)}\n` +
               `3. **Best Practices**: ${this.suggestBestPractices(codeToExplain)}\n\n` +
               `**Learning Resources**:\n` +
               ` [MDN Web Docs](https://developer.mozilla.org/)\n` +
               ` [JavaScript Info](https://javascript.info/)\n` +
               ` [React Documentation](https://reactjs.org/docs/)\n\n` +
               `Is there a specific part you'd like me to explain in more detail?`;
    },
    
    generateOptimizationResponse: function(query) {
        return `**Code Optimization Suggestions:**\n\n` +
               `1. **Performance**:\n` +
               `    Use Web Workers for CPU-intensive tasks\n` +
               `    Implement debouncing/throttling for event handlers\n` +
               `    Lazy load non-critical resources\n\n` +
               `2. **Memory**:\n` +
               `    Clean up event listeners and timeouts\n` +
               `    Use weak references for caches\n` +
               `    Avoid memory leaks in closures\n\n` +
               `3. **Bundle Size**:\n` +
               `    Code splitting and dynamic imports\n` +
               `    Tree shaking with proper ES6 modules\n` +
               `    Compress images and assets\n\n` +
               `4. **Render Performance**:\n` +
               `    Virtualize long lists\n` +
               `    Use CSS transforms for animations\n` +
               `    Implement shouldComponentUpdate or React.memo\n\n` +
               `Could you share the specific code you'd like me to optimize?`;
    },
    
    guessCodePurpose: function(code) {
        if (code.includes('fetch') || code.includes('axios') || code.includes('HTTP')) {
            return 'handling HTTP requests or API communication';
        } else if (code.includes('useState') || code.includes('useEffect')) {
            return 'React component state management';
        } else if (code.includes('addEventListener')) {
            return 'handling user interactions or events';
        } else if (code.includes('querySelector') || code.includes('getElementById')) {
            return 'DOM manipulation';
        } else {
            return 'performing some computational logic';
        }
    },
    
    analyzeCodeStructure: function(code) {
        const lines = code.split('\n').length;
        const functions = (code.match(/function|=>/g) || []).length;
        const classes = (code.match(/class\s+\w+/g) || []).length;
        
        return `The code has ${lines} lines, ${functions} functions/methods, and ${classes} classes.`;
    },
    
    suggestBestPractices: function(code) {
        const suggestions = [];
        
        if (!code.includes('try') && code.includes('fetch')) {
            suggestions.push('Add error handling with try-catch');
        }
        
        if (code.includes('innerHTML')) {
            suggestions.push('Consider using textContent instead of innerHTML for security');
        }
        
        if (code.includes('setTimeout') && !code.includes('clearTimeout')) {
            suggestions.push('Clean up timeouts to prevent memory leaks');
        }
        
        if (suggestions.length === 0) {
            return 'The code structure looks good. Consider adding comments for complex logic.';
        }
        
        return suggestions.join(', ');
    },
    
    addMessage: function(content, role) {
        const messagesDiv = document.getElementById('ai-messages');
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `msg-bubble msg-${role}`;
        
        // Process content for code blocks
        let processedContent = content;
        const codeBlocks = content.match(/```[\s\S]*?```/g) || [];
        
        codeBlocks.forEach((block, index) => {
            const langMatch = block.match(/```(\w+)/);
            const lang = langMatch ? langMatch[1] : 'javascript';
            const code = block.replace(/```\w*\n/, '').replace(/```$/, '');
            
            const codeBlockId = `code-block-${Date.now()}-${index}`;
            processedContent = processedContent.replace(block, 
                `<div class="code-block">
                    <div class="code-header">
                        <span class="code-lang">${lang}</span>
                        <button class="copy-btn" onclick="Utils.copyToClipboard(document.getElementById('${codeBlockId}').textContent)">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <pre id="${codeBlockId}">${Utils.escapeHtml(code)}</pre>
                </div>`
            );
        });
        
        messageDiv.innerHTML = processedContent;
        messagesDiv.appendChild(messageDiv);
        
        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Add to messages array
        this.messages.push({
            role: role,
            content: content,
            timestamp: new Date().toISOString()
        });
        
        // Limit messages to last 50
        if (this.messages.length > 50) {
            this.messages = this.messages.slice(-50);
        }
    },
    
    showTyping: function(show) {
        const typingIndicator = document.getElementById('ai-typing');
        const sendBtn = document.getElementById('ai-send-btn');
        
        if (show) {
            typingIndicator.classList.remove('hidden');
            sendBtn.disabled = true;
        } else {
            typingIndicator.classList.add('hidden');
            sendBtn.disabled = false;
        }
    },
    
    clear: function() {
        const messagesDiv = document.getElementById('ai-messages');
        messagesDiv.innerHTML = `
            <div class="msg-bubble msg-sys">
                <div style="font-weight:600; margin-bottom:8px;"> Hello! I'm your AI coding assistant.</div>
                <div style="margin-bottom:8px;">I can help you with:</div>
                <ul style="margin-left:20px; margin-bottom:8px;">
                    <li>Writing and explaining code</li>
                    <li>Debugging and fixing errors</li>
                    <li>Generating components and functions</li>
                    <li>Optimizing and refactoring</li>
                    <li>Answering programming questions</li>
                </ul>
                <div>What would you like to work on?</div>
            </div>
        `;
        
        this.messages = [];
        this.conversationId = Utils.uuid();
        
        Utils.toast('Chat cleared', 'info');
    }
};

// ============================================
// PROJECT TEMPLATES MANAGER
// ============================================
const ProjectTemplates = {
    show: function() {
        document.getElementById('templates-modal').style.display = 'flex';
        
        // Setup template selection
        document.querySelectorAll('.template-card').forEach(card => {
            card.onclick = () => {
                document.querySelectorAll('.template-card').forEach(c => {
                    c.style.border = '1px solid transparent';
                });
                card.style.border = '2px solid var(--primary)';
                IDE.state.projectType = card.dataset.template;
            };
        });
    },
    
    hide: function() {
        document.getElementById('templates-modal').style.display = 'none';
    },
    
    create: function() {
        if (!IDE.state.projectType) {
            Utils.toast('Please select a template', 'warning');
            return;
        }
        
        const template = IDE.state.templates[IDE.state.projectType];
        
        // Clear current files
        IDE.state.files = {};
        
        // Create template files
        for (const [path, content] of Object.entries(template)) {
            IDE.state.files[path] = content;
        }
        
        // Save and refresh
        FileSystem.save(true);
        FileSystem.refreshTree();
        
        // Open main file
        const mainFile = Object.keys(template).find(f => 
            f.includes('index.') || f.includes('main.') || f.includes('App.')
        ) || Object.keys(template)[0];
        
        if (mainFile) {
            TabManager.open(mainFile);
        }
        
        this.hide();
        Utils.toast(`Created ${IDE.state.projectType} project`, 'success');
    }
};

// ============================================
// GIT INTEGRATION MANAGER
// ============================================
const Git = {
    branch: function() {
        Console.warn('Git integration is not available in this environment.');
        return 'local';
    },
    
    status: function() {
        const dirtyFiles = IDE.state.dirtyTabs.size;
        
        if (dirtyFiles === 0) {
            Console.info('No local changes');
            document.getElementById('git-status-text').textContent = 'Local clean';
        } else {
            Console.info(`${dirtyFiles} local change${dirtyFiles === 1 ? '' : 's'}`);
            document.getElementById('git-status-text').textContent = `${dirtyFiles} local`;
        }
        
        return dirtyFiles;
    },
    
    commit: function() {
        Console.warn('Git commit requires an external terminal.');
        Utils.toast('Git commit not available in this environment', 'warning');
    },
    
    push: function() {
        Console.warn('Git push requires an external terminal.');
        Utils.toast('Git push not available in this environment', 'warning');
    },
    
    init: function() {
        Console.warn('Git init requires an external terminal.');
        Utils.toast('Git init not available in this environment', 'warning');
    }
};

// ============================================
// SEARCH MANAGER
// ============================================
const Search = {
    findInProject: function() {
        LayoutManager.setSide('search');
        document.getElementById('search-input').focus();
    },
    
    replace: function() {
        LayoutManager.setSide('search');
        document.getElementById('search-input').focus();
    },
    
    execute: function() {
        const query = document.getElementById('search-input').value;
        const replace = document.getElementById('replace-input').value;
        const caseSensitive = document.getElementById('case-sensitive').checked;
        const wholeWord = document.getElementById('whole-word').checked;
        
        if (!query) {
            Utils.toast('Enter search query', 'warning');
            return;
        }
        
        const results = FileSystem.findInFiles(query, {
            caseSensitive: caseSensitive,
            wholeWord: wholeWord,
            regex: false
        });
        
        this.displayResults(results, query, replace);
    },
    
    displayResults: function(results, query, replace) {
        const container = document.getElementById('search-results');
        container.innerHTML = '';
        
        if (results.length === 0) {
            container.innerHTML = '<div style="padding:16px; text-align:center; color:var(--text-dim);">No results found</div>';
            return;
        }
        
        // Group by file
        const grouped = {};
        results.forEach(result => {
            if (!grouped[result.path]) {
                grouped[result.path] = [];
            }
            grouped[result.path].push(result);
        });
        
        // Render results
        for (const [path, matches] of Object.entries(grouped)) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'search-file-group';
            fileDiv.style.marginBottom = '16px';
            
            const fileName = path.split('/').pop();
            const [iconClass, iconColor] = Utils.getFileIcon(path);
            
            fileDiv.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:var(--bg-panel); border-radius:8px; margin-bottom:8px;">
                    <i class="${iconClass}" style="color:${iconColor}"></i>
                    <span style="font-weight:500; flex:1;">${fileName}</span>
                    <span style="font-size:11px; color:var(--text-dim);">${matches.length} match${matches.length === 1 ? '' : 'es'}</span>
                    <button class="btn icon small" onclick="TabManager.open('${path}')" title="Open file">
                        <i class="fas fa-external-link-alt"></i>
                    </button>
                </div>
            `;
            
            const matchesDiv = document.createElement('div');
            matchesDiv.style.padding = '0 8px';
            
            matches.forEach(match => {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'search-match';
                matchDiv.style.padding = '8px';
                matchDiv.style.borderBottom = '1px solid var(--border)';
                matchDiv.style.cursor = 'pointer';
                matchDiv.style.fontFamily = "'JetBrains Mono', monospace";
                matchDiv.style.fontSize = '11px';
                
                // Highlight the match in the line
                let lineContent = match.content;
                if (query) {
                    const regex = new RegExp(
                        wholeWord ? `\\b${query}\\b` : query,
                        caseSensitive ? 'g' : 'gi'
                    );
                    lineContent = lineContent.replace(regex, '<mark style="background:var(--warn); color:black; padding:0 2px;">$&</mark>');
                }
                
                matchDiv.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span style="color:var(--text-dim);">Line ${match.line}</span>
                        ${replace ? `<button class="btn icon small" onclick="Search.replaceSingle('${path}', ${match.line}, '${query}', '${replace}')" title="Replace this match">
                            <i class="fas fa-exchange-alt"></i>
                        </button>` : ''}
                    </div>
                    <div>${lineContent}</div>
                `;
                
                matchDiv.onclick = () => {
                    TabManager.open(path);
                    EditorManager.goToLine(match.line);
                };
                
                matchesDiv.appendChild(matchDiv);
            });
            
            // Add replace all for this file
            if (replace) {
                const replaceAllBtn = document.createElement('button');
                replaceAllBtn.className = 'btn small';
                replaceAllBtn.style.marginTop = '8px';
                replaceAllBtn.style.width = '100%';
                replaceAllBtn.innerHTML = `<i class="fas fa-exchange-alt"></i> Replace All in File (${matches.length})`;
                replaceAllBtn.onclick = () => {
                    this.replaceInFile(path, query, replace, {
                        caseSensitive: caseSensitive,
                        wholeWord: wholeWord
                    });
                };
                
                matchesDiv.appendChild(replaceAllBtn);
            }
            
            fileDiv.appendChild(matchesDiv);
            container.appendChild(fileDiv);
        }
        
        // Add total stats
        const totalMatches = results.length;
        const totalFiles = Object.keys(grouped).length;
        
        const stats = document.createElement('div');
        stats.style.padding = '12px';
        stats.style.borderTop = '1px solid var(--border)';
        stats.style.marginTop = '16px';
        stats.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <div>
                    <span style="color:var(--text-dim);">Found </span>
                    <span style="font-weight:600;">${totalMatches}</span>
                    <span style="color:var(--text-dim);"> match${totalMatches === 1 ? '' : 'es'} in </span>
                    <span style="font-weight:600;">${totalFiles}</span>
                    <span style="color:var(--text-dim);"> file${totalFiles === 1 ? '' : 's'}</span>
                </div>
                ${replace ? `
                <button class="btn primary small" onclick="Search.replaceAll('${query}', '${replace}', ${caseSensitive}, ${wholeWord})">
                    <i class="fas fa-exchange-alt"></i> Replace All
                </button>
                ` : ''}
            </div>
        `;
        
        container.appendChild(stats);
    },
    
    replaceSingle: function(path, line, find, replace) {
        const content = FileSystem.read(path);
        const lines = content.split('\n');
        
        if (line > 0 && line <= lines.length) {
            const original = lines[line - 1];
            const replaced = original.replace(new RegExp(find, 'gi'), replace);
            
            if (original !== replaced) {
                lines[line - 1] = replaced;
                FileSystem.write(path, lines.join('\n'));
                
                Utils.toast('Replaced match', 'success');
                this.execute(); // Refresh results
            }
        }
    },
    
    replaceInFile: function(path, find, replace, options) {
        const content = FileSystem.read(path);
        const regex = new RegExp(
            options.regex ? find : (options.wholeWord ? `\\b${find}\\b` : find),
            options.caseSensitive ? 'g' : 'gi'
        );
        
        const newContent = content.replace(regex, replace);
        
        if (newContent !== content) {
            FileSystem.write(path, newContent);
            Utils.toast(`Replaced in ${path}`, 'success');
            this.execute(); // Refresh results
        }
    },
    
    replaceAll: function(find, replace, caseSensitive, wholeWord) {
        if (!confirm(`Replace all occurrences of "${find}" with "${replace}"?`)) {
            return;
        }
        
        const result = FileSystem.replaceInFiles(find, replace, {
            caseSensitive: caseSensitive,
            wholeWord: wholeWord
        });
        
        Utils.toast(`Replaced ${result.replacedCount} occurrences in ${result.fileCount} files`, 'success');
        this.execute(); // Refresh results
    }
};

// ============================================
// LAYOUT MANAGER (Continued)
// ============================================
const LayoutManager = {
    toggleLayout: function(panel, forceShow = false) {
        switch(panel) {
            case 'terminal':
                const termPanel = document.getElementById('panel-btm');
                if (forceShow) {
                    termPanel.classList.remove('hidden');
                    Panel.show('term');
                } else {
                    termPanel.classList.toggle('hidden');
                    if (!termPanel.classList.contains('hidden')) {
                        Panel.show('term');
                    }
                }
                break;
                
            case 'preview':
                const previewWrap = document.getElementById('preview-wrap');
                const resizer = document.getElementById('rs-preview');
                
                if (forceShow) {
                    previewWrap.classList.add('visible');
                    resizer.classList.remove('hidden');
                } else {
                    previewWrap.classList.toggle('visible');
                    resizer.classList.toggle('hidden', !previewWrap.classList.contains('visible'));
                }
                
                // Update preview URL
                if (previewWrap.classList.contains('visible')) {
                    const url = document.getElementById('preview-url');
                    const frame = document.getElementById('preview-frame');
                    if (frame.srcdoc) {
                        url.value = 'data:text/html;charset=utf-8,' + encodeURIComponent(frame.srcdoc);
                    }
                }
                break;
                
            case 'split':
                this.splitEditor();
                break;
        }
    },
    
    setSide: function(side) {
        // Update active sidebar
        IDE.state.sidebar = side;
        
        // Update UI
        document.querySelectorAll('.sidebar').forEach(el => {
            el.classList.remove('active');
        });
        
        document.querySelectorAll('.act-btn').forEach(el => {
            el.classList.remove('active');
        });
        
        const sidebar = document.getElementById(`side-${side}`);
        const button = document.querySelector(`[data-id="${side}"]`);
        
        if (sidebar) sidebar.classList.add('active');
        if (button) button.classList.add('active');
    },
    
    splitEditor: function() {
        if (IDE.state.splitView) {
            // Already split, close split
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            
            const pane = document.createElement('div');
            pane.className = 'editor-pane';
            pane.id = 'editor-pane-1';
            pane.innerHTML = '<div id="monaco-root-1" style="width:100%; height:100%;"></div>';
            
            container.appendChild(pane);
            
            // Reinitialize editor
            EditorManager.createEditor('monaco-root-1');
            
            // Restore active file
            if (IDE.state.activeTab) {
                EditorManager.setFile(IDE.state.activeTab);
            }
            
            IDE.state.splitView = false;
            IDE.state.editorLayout = 'single';
            
            Utils.toast('Split view disabled', 'info');
        } else {
            // Create split view
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            
            // Create two panes
            const pane1 = document.createElement('div');
            pane1.className = 'editor-pane';
            pane1.id = 'editor-pane-1';
            pane1.innerHTML = '<div id="monaco-root-1" style="width:100%; height:100%;"></div>';
            
            const pane2 = document.createElement('div');
            pane2.className = 'editor-pane';
            pane2.id = 'editor-pane-2';
            pane2.innerHTML = '<div id="monaco-root-2" style="width:100%; height:100%;"></div>';
            
            container.appendChild(pane1);
            container.appendChild(pane2);
            
            // Initialize editors
            EditorManager.createEditor('monaco-root-1');
            EditorManager.createEditor('monaco-root-2');
            
            IDE.state.splitView = true;
            IDE.state.editorLayout = 'split';
            
            // Copy current file to second pane if exists
            if (IDE.state.activeTab) {
                EditorManager.setFile(IDE.state.activeTab, 'monaco-root-1');
                EditorManager.setFile(IDE.state.activeTab, 'monaco-root-2');
            }
            
            Utils.toast('Split view enabled', 'info');
        }
    },
    
    openInSplit: function(path) {
        if (!IDE.state.splitView) {
            this.splitEditor();
        }
        
        // Open file in second pane
        setTimeout(() => {
            EditorManager.setFile(path, 'monaco-root-2');
            Utils.toast(`Opened in split view: ${path.split('/').pop()}`, 'info');
        }, 100);
    }
};

// ============================================
// SETTINGS MANAGER (Continued)
// ============================================
const Settings = {
    show: function() {
        const modal = document.getElementById('settings-modal');
        modal.style.display = 'flex';
        
        // Load current settings
        this.loadSettings();
    },
    
    hide: function() {
        document.getElementById('settings-modal').style.display = 'none';
    },
    
    loadSettings: function() {
        // Editor settings
        document.getElementById('font-size-input').value = IDE.state.settings.editor.fontSize;
        document.getElementById('tab-size-value').textContent = IDE.state.settings.editor.tabSize;
        document.getElementById('word-wrap-toggle').checked = IDE.state.settings.editor.wordWrap;
        document.getElementById('minimap-toggle').checked = IDE.state.settings.editor.minimap;
        document.getElementById('animation-toggle').checked = IDE.state.settings.appearance.animation;
        
        // Theme
        document.querySelectorAll('.theme-option').forEach(option => {
            option.classList.remove('active');
            if (option.dataset.theme === IDE.state.settings.appearance.theme) {
                option.classList.add('active');
            }
        });
    },
    
    save: function() {
        // Get values from the modal
        IDE.state.settings.editor.fontSize = parseInt(document.getElementById('font-size-input').value);
        IDE.state.settings.editor.tabSize = parseInt(document.getElementById('tab-size-value').textContent);
        IDE.state.settings.editor.wordWrap = document.getElementById('word-wrap-toggle').checked;
        IDE.state.settings.editor.minimap = document.getElementById('minimap-toggle').checked;
        IDE.state.settings.appearance.animation = document.getElementById('animation-toggle').checked;
        
        // Theme
        const activeTheme = document.querySelector('.theme-option.active');
        if (activeTheme) {
            IDE.state.settings.appearance.theme = activeTheme.dataset.theme;
            IDE.state.settings.editor.theme = `procode-${activeTheme.dataset.theme}`;
        }
        
        // Apply settings
        EditorManager.applySettings();
        
        // Apply theme to UI
        this.applyTheme();
        
        // Save to localStorage
        FileSystem.save(true);
        
        this.hide();
        Utils.toast('Settings saved', 'success');
    },
    
    changeFontSize: function(delta) {
        const input = document.getElementById('font-size-input');
        let value = parseInt(input.value) + delta;
        value = Math.max(8, Math.min(32, value));
        input.value = value;
    },
    
    changeTabSize: function(delta) {
        const span = document.getElementById('tab-size-value');
        let value = parseInt(span.textContent) + delta;
        value = Math.max(1, Math.min(8, value));
        span.textContent = value;
    },
    
    applyTheme: function() {
        const theme = IDE.state.settings.appearance.theme;
        const root = document.documentElement;
        
        switch(theme) {
            case 'light':
                root.style.setProperty('--bg-dark', '#f8fafc');
                root.style.setProperty('--bg-panel', '#ffffff');
                root.style.setProperty('--bg-side', '#f1f5f9');
                root.style.setProperty('--border', '#e2e8f0');
                root.style.setProperty('--text', '#1e293b');
                root.style.setProperty('--text-dim', '#64748b');
                break;
            case 'night':
                root.style.setProperty('--bg-dark', '#0a0a12');
                root.style.setProperty('--bg-panel', '#1a1a2e');
                root.style.setProperty('--bg-side', '#121229');
                root.style.setProperty('--border', '#2d2d4d');
                root.style.setProperty('--text', '#e2e8f0');
                root.style.setProperty('--text-dim', '#8b8bb8');
                break;
            default: // dark
                root.style.setProperty('--bg-dark', '#09090b');
                root.style.setProperty('--bg-panel', '#18181b');
                root.style.setProperty('--bg-side', '#121215');
                root.style.setProperty('--border', '#27272a');
                root.style.setProperty('--text', '#e4e4e7');
                root.style.setProperty('--text-dim', '#71717a');
        }
    }
};

// ============================================
// COMMAND PALETTE MANAGER
// ============================================
const CommandPalette = {
    show: function() {
        const palette = document.getElementById('command-palette');
        palette.classList.remove('hidden');
        
        const input = document.getElementById('command-input');
        input.value = '';
        input.focus();
        
        this.refreshCommands();
    },
    
    hide: function() {
        document.getElementById('command-palette').classList.add('hidden');
    },
    
    refreshCommands: function() {
        const commands = [
            // File operations
            { 
                id: 'new-file', 
                text: 'New File', 
                icon: 'fa-file-plus', 
                shortcut: 'Ctrl+N',
                action: () => FileSystem.createFilePrompt() 
            },
            { 
                id: 'new-folder', 
                text: 'New Folder', 
                icon: 'fa-folder-plus', 
                action: () => FileSystem.createFolderPrompt() 
            },
            { 
                id: 'save', 
                text: 'Save', 
                icon: 'fa-save', 
                shortcut: 'Ctrl+S',
                action: () => FileSystem.save(true) 
            },
            { 
                id: 'save-all', 
                text: 'Save All', 
                icon: 'fa-save', 
                action: () => FileSystem.save(true) 
            },
            
            // Edit operations
            { 
                id: 'undo', 
                text: 'Undo', 
                icon: 'fa-undo', 
                shortcut: 'Ctrl+Z',
                action: () => FileSystem.undo() 
            },
            { 
                id: 'redo', 
                text: 'Redo', 
                icon: 'fa-redo', 
                shortcut: 'Ctrl+Y',
                action: () => FileSystem.redo() 
            },
            { 
                id: 'format', 
                text: 'Format Document', 
                icon: 'fa-indent', 
                shortcut: 'Shift+Alt+F',
                action: () => EditorManager.formatCode() 
            },
            
            // View operations
            { 
                id: 'toggle-terminal', 
                text: 'Toggle Terminal', 
                icon: 'fa-terminal', 
                shortcut: 'Ctrl+`',
                action: () => LayoutManager.toggleLayout('terminal') 
            },
            { 
                id: 'toggle-preview', 
                text: 'Toggle Preview', 
                icon: 'fa-columns', 
                shortcut: 'Ctrl+B',
                action: () => LayoutManager.toggleLayout('preview') 
            },
            { 
                id: 'split-editor', 
                text: 'Split Editor', 
                icon: 'fa-columns', 
                shortcut: 'Ctrl+\\',
                action: () => LayoutManager.splitEditor() 
            },
            { 
                id: 'zoom-in', 
                text: 'Zoom In', 
                icon: 'fa-search-plus', 
                shortcut: 'Ctrl+=',
                action: () => EditorManager.zoomIn() 
            },
            { 
                id: 'zoom-out', 
                text: 'Zoom Out', 
                icon: 'fa-search-minus', 
                shortcut: 'Ctrl+-',
                action: () => EditorManager.zoomOut() 
            },
            
            // Run/debug
            { 
                id: 'run', 
                text: 'Run', 
                icon: 'fa-play', 
                shortcut: 'F5',
                action: () => Runner.exec() 
            },
            { 
                id: 'debug', 
                text: 'Debug', 
                icon: 'fa-bug', 
                shortcut: 'F9',
                action: () => Debugger.toggle() 
            },
            
            // Tools
            { 
                id: 'command-palette', 
                text: 'Command Palette', 
                icon: 'fa-search', 
                shortcut: 'Ctrl+P',
                action: () => this.show() 
            },
            { 
                id: 'find', 
                text: 'Find in Files', 
                icon: 'fa-search', 
                shortcut: 'Ctrl+Shift+F',
                action: () => Search.findInProject() 
            },
            { 
                id: 'replace', 
                text: 'Replace', 
                icon: 'fa-exchange-alt', 
                shortcut: 'Ctrl+H',
                action: () => Search.replace() 
            },
            
            // Settings
            { 
                id: 'settings', 
                text: 'Settings', 
                icon: 'fa-cog', 
                action: () => Settings.show() 
            },
            { 
                id: 'ai-assistant', 
                text: 'AI Assistant', 
                icon: 'fa-robot', 
                shortcut: 'Ctrl+Shift+A',
                action: () => AI.toggle() 
            },
            
            // Project
            { 
                id: 'new-project', 
                text: 'New Project', 
                icon: 'fa-layer-group', 
                action: () => ProjectTemplates.show() 
            },
            { 
                id: 'export-project', 
                text: 'Export Project', 
                icon: 'fa-download', 
                action: () => FileSystem.exportZip() 
            }
        ];

        const list = document.getElementById('command-list');
        list.innerHTML = '';

        const filter = document.getElementById('command-input').value.toLowerCase();
        
        const filteredCommands = commands.filter(cmd => 
            cmd.text.toLowerCase().includes(filter) || 
            cmd.id.toLowerCase().includes(filter)
        );

        if (filteredCommands.length === 0) {
            list.innerHTML = '<div class="command-item"><div class="command-text" style="text-align:center; color:var(--text-dim);">No commands found</div></div>';
            return;
        }

        filteredCommands.forEach(cmd => {
            const item = document.createElement('div');
            item.className = 'command-item';
            item.innerHTML = `
                <div class="command-icon"><i class="fas ${cmd.icon}"></i></div>
                <div class="command-text">${cmd.text}</div>
                <div class="command-shortcut">${cmd.shortcut || ''}</div>
            `;
            item.onclick = () => {
                cmd.action();
                this.hide();
            };
            list.appendChild(item);
        });
    },
    
    handleKey: function(event) {
        if (event.key === 'Escape') {
            this.hide();
            return;
        }
        
        if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
            event.preventDefault();
            const items = document.querySelectorAll('.command-item');
            let currentIndex = -1;
            
            items.forEach((item, index) => {
                if (item.classList.contains('selected')) {
                    currentIndex = index;
                    item.classList.remove('selected');
                }
            });
            
            if (event.key === 'ArrowDown') {
                currentIndex = (currentIndex + 1) % items.length;
            } else {
                currentIndex = (currentIndex - 1 + items.length) % items.length;
            }
            
            items[currentIndex].classList.add('selected');
            items[currentIndex].scrollIntoView({ block: 'nearest' });
        }
        
        if (event.key === 'Enter') {
            const selected = document.querySelector('.command-item.selected');
            if (selected) {
                selected.click();
            }
        }
        
        // Refresh commands on input
        setTimeout(() => this.refreshCommands(), 10);
    }
};

// ============================================
// TUTORIAL MANAGER
// ============================================
const Tutorial = {
    start: function() {
        Console.clear();
        Console.info(' Starting ProCode IDE Tutorial');
        Console.info('='.repeat(50));
        
        const steps = [
            {
                title: 'Welcome to ProCode IDE',
                content: 'This is a full-featured web development environment built with modern web technologies.',
                action: () => {
                    Utils.toast('Welcome!', 'info');
                }
            },
            {
                title: 'File Explorer',
                content: 'Use the file explorer on the left to navigate your project files.',
                action: () => {
                    LayoutManager.setSide('expl');
                }
            },
            {
                title: 'Editor',
                content: 'The editor supports syntax highlighting, auto-completion, and multiple cursors.',
                action: () => {
                    const editor = EditorManager.getCurrentEditor();
                    if (editor) editor.focus();
                }
            },
            {
                title: 'Terminal',
                content: 'Access the integrated terminal with support for commands and package management.',
                action: () => {
                    LayoutManager.toggleLayout('terminal', true);
                }
            },
            {
                title: 'Preview',
                content: 'See live previews of your web applications with hot reload.',
                action: () => {
                    LayoutManager.toggleLayout('preview', true);
                }
            },
            {
                title: 'AI Assistant',
                content: 'Get coding help from the AI assistant for debugging and code generation.',
                action: () => {
                    AI.toggle();
                }
            }
        ];
        
        let currentStep = 0;
        
        const showStep = (index) => {
            if (index >= steps.length) {
                Console.info(' Tutorial completed!');
                Utils.toast('Tutorial completed!', 'success');
                return;
            }
            
            const step = steps[index];
            Console.info(` Step ${index + 1}: ${step.title}`);
            Console.info(step.content);
            Console.info('---');
            
            step.action();
            
            if (index < steps.length - 1) {
                setTimeout(() => showStep(index + 1), 2000);
            }
        };
        
        showStep(currentStep);
    }
};

// ============================================
// NOTIFICATIONS MANAGER
// ============================================
const Notifications = {
    isVisible: false,
    notifications: [],
    
    toggle: function() {
        this.isVisible = !this.isVisible;
        
        if (this.isVisible) {
            this.showNotifications();
        } else {
            this.hideNotifications();
        }
    },
    
    showNotifications: function() {
        // Create notifications panel
        const panel = document.createElement('div');
        panel.id = 'notifications-panel';
        panel.className = 'modal-overlay';
        panel.style.alignItems = 'flex-start';
        panel.style.justifyContent = 'flex-end';
        panel.style.padding = '20px';
        
        panel.innerHTML = `
            <div class="modal" style="width:400px; max-height:80vh; margin:0;">
                <div class="modal-header">
                    <h3><i class="fas fa-bell"></i> Notifications</h3>
                    <button class="btn icon small" onclick="Notifications.toggle()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body" id="notifications-list">
                    <div style="text-align:center; padding:40px; color:var(--text-dim);">
                        No notifications
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="Notifications.clearAll()">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(panel);
        
        this.updateNotificationsList();
    },
    
    hideNotifications: function() {
        const panel = document.getElementById('notifications-panel');
        if (panel) {
            panel.remove();
        }
        this.isVisible = false;
    },
    
    updateNotificationsList: function() {
        const list = document.getElementById('notifications-list');
        if (!list) return;
        
        if (this.notifications.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-dim);">No notifications</div>';
            return;
        }
        
        list.innerHTML = '';
        
        this.notifications.slice().reverse().forEach((notification, index) => {
            const item = document.createElement('div');
            item.className = 'notification-item';
            item.style.padding = '12px';
            item.style.borderBottom = '1px solid var(--border)';
            item.style.display = 'flex';
            item.style.gap = '12px';
            item.style.alignItems = 'flex-start';
            
            const icon = notification.type === 'error' ? 'fa-times-circle' :
                        notification.type === 'warning' ? 'fa-exclamation-triangle' :
                        notification.type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
            
            const iconColor = notification.type === 'error' ? 'var(--error)' :
                             notification.type === 'warning' ? 'var(--warn)' :
                             notification.type === 'success' ? 'var(--success)' : 'var(--primary)';
            
            item.innerHTML = `
                <i class="fas ${icon}" style="color:${iconColor}; margin-top:2px;"></i>
                <div style="flex:1;">
                    <div style="font-size:12px; font-weight:500; margin-bottom:4px;">${notification.title}</div>
                    <div style="font-size:11px; color:var(--text-dim);">${notification.message}</div>
                    <div style="font-size:9px; color:var(--text-dim); margin-top:4px;">
                        ${Utils.formatDate(notification.timestamp, 'relative')}
                    </div>
                </div>
                <button class="btn icon small" onclick="Notifications.removeNotification(${this.notifications.length - 1 - index})" style="color:var(--text-dim);">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            list.appendChild(item);
        });
    },
    
    add: function(title, message, type = 'info') {
        const notification = {
            id: Utils.uuid(),
            title: title,
            message: message,
            type: type,
            timestamp: new Date().toISOString(),
            read: false
        };
        
        this.notifications.push(notification);
        
        // Keep only last 50 notifications
        if (this.notifications.length > 50) {
            this.notifications.shift();
        }
        
        // Update badge
        this.updateBadge();
        
        // Update UI if visible
        if (this.isVisible) {
            this.updateNotificationsList();
        }
        
        // Show toast
        Utils.toast(message, type);
    },
    
    removeNotification: function(index) {
        if (index >= 0 && index < this.notifications.length) {
            this.notifications.splice(index, 1);
            this.updateBadge();
            this.updateNotificationsList();
        }
    },
    
    clearAll: function() {
        this.notifications = [];
        this.updateBadge();
        this.updateNotificationsList();
        Utils.toast('All notifications cleared', 'info');
    },
    
    updateBadge: function() {
        const unreadCount = this.notifications.filter(n => !n.read).length;
        const badge = document.querySelector('[title="Notifications"] .badge');
        
        if (badge) {
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'inline-flex';
            } else {
                badge.style.display = 'none';
            }
        }
    }
};

// ============================================
// INITIALIZATION AND STARTUP
// ============================================
window.addEventListener('load', async function() {
    console.log(' ProCode IDE v15.0 - Ultimate Edition');
    console.log(' Build:', IDE.build);
    
    // Update boot progress
    const updateProgress = (message, percent) => {
        document.getElementById('boot-status').textContent = message;
        document.getElementById('boot-progress-fill').style.width = percent + '%';
    };
    
    updateProgress('Loading core modules...', 10);
    
    // Initialize components
    try {
        updateProgress('Initializing file system...', 20);
        FileSystem.init();
        
        updateProgress('Loading editor engine...', 40);
        await EditorManager.init();
        
        updateProgress('Starting terminal...', 60);
        TerminalManager.init();
        Console.init();
        
        updateProgress('Loading AI assistant...', 80);
        // AI will load on first use
        
        updateProgress('Finalizing setup...', 95);
        
        // Setup event listeners
        setupEventListeners();
        
        // Setup resizable panels
        setupResizablePanels();
        
        // Setup keyboard shortcuts
        setupKeyboardShortcuts();
        
        updateProgress('Ready!', 100);
        
        // Hide loader with delay
        setTimeout(() => {
            document.getElementById('loader-overlay').style.display = 'none';
            Utils.toast('ProCode IDE v15.0 loaded successfully!', 'success');
            
            // Show welcome notification
            Notifications.add(
                'Welcome to ProCode IDE v15.0',
                'Start coding with multi-language support, AI assistant, and live preview.',
                'info'
            );
        }, 500);
        
    } catch (error) {
        console.error('Startup failed:', error);
        updateProgress(`Startup failed: ${error.message}`, 100);
        
        setTimeout(() => {
            document.getElementById('loader-overlay').innerHTML = `
                <div style="text-align:center; color:var(--error);">
                    <i class="fas fa-exclamation-triangle" style="font-size:48px; margin-bottom:20px;"></i>
                    <div style="font-size:16px; font-weight:600; margin-bottom:10px;">Startup Failed</div>
                    <div style="font-size:13px; color:var(--text-dim); margin-bottom:20px;">${error.message}</div>
                    <button class="btn primary" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Reload IDE
                    </button>
                </div>
            `;
        }, 1000);
    }
});

function setupEventListeners() {
    // Command palette input
    const commandInput = document.getElementById('command-input');
    if (commandInput) {
        commandInput.addEventListener('input', () => CommandPalette.refreshCommands());
        commandInput.addEventListener('keydown', (e) => CommandPalette.handleKey(e));
    }
    
    // Search input
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') Search.execute();
        });
    }
    
    // AI input
    const aiInput = document.getElementById('ai-input');
    if (aiInput) {
        aiInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                AI.send();
            }
        });
    }
    
    // Spotlight search
    const spotlight = document.getElementById('spotlight');
    if (spotlight) {
        spotlight.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const query = spotlight.value.trim();
                if (query) {
                    // Search for files containing the query
                    const files = Object.keys(IDE.state.files).filter(path => 
                        path.toLowerCase().includes(query.toLowerCase())
                    );
                    
                    if (files.length > 0) {
                        TabManager.open(files[0]);
                        spotlight.value = '';
                    } else {
                        Utils.toast('No files found', 'warning');
                    }
                }
            }
        });
    }
    
    // Close modals on ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            // Close open modals
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
            
            // Close command palette
            CommandPalette.hide();
            
            // Close context menus
            document.querySelectorAll('.context-menu').forEach(menu => {
                menu.remove();
            });
            
            // Close AI assistant
            if (AI.isVisible) {
                AI.toggle();
            }
        }
    });
    
    // Auto-save on blur
    window.addEventListener('blur', () => {
        if (IDE.state.settings.editor.autoSave && IDE.state.dirtyTabs.size > 0) {
            FileSystem.save();
        }
    });
}

function setupResizablePanels() {
    // Sidebar resizer
    const sideResizer = document.getElementById('rs-side');
    const sidebar = document.querySelector('.sidebar.active');
    const actBar = document.querySelector('.act-bar');
    
    if (sideResizer && sidebar) {
        let isResizing = false;
        
        sideResizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            sideResizer.classList.add('dragging');
            document.body.style.cursor = 'col-resize';
            
            const startX = e.clientX;
            const startWidth = sidebar.offsetWidth;
            
            function onMouseMove(e) {
                if (!isResizing) return;
                
                const deltaX = e.clientX - startX;
                let newWidth = startWidth + deltaX;
                
                // Constrain width
                newWidth = Math.max(200, Math.min(600, newWidth));
                
                sidebar.style.width = newWidth + 'px';
                document.documentElement.style.setProperty('--side-w', newWidth + 'px');
            }
            
            function onMouseUp() {
                isResizing = false;
                sideResizer.classList.remove('dragging');
                document.body.style.cursor = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    }
    
    // Panel resizer
    const panelResizer = document.getElementById('rs-panel');
    const panel = document.getElementById('panel-btm');
    
    if (panelResizer && panel) {
        let isResizing = false;
        
        panelResizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            panelResizer.classList.add('dragging');
            document.body.style.cursor = 'row-resize';
            
            const startY = e.clientY;
            const startHeight = panel.offsetHeight;
            
            function onMouseMove(e) {
                if (!isResizing) return;
                
                const deltaY = startY - e.clientY;
                let newHeight = startHeight + deltaY;
                
                // Constrain height
                newHeight = Math.max(100, Math.min(window.innerHeight - 200, newHeight));
                
                Panel.resize(newHeight);
            }
            
            function onMouseUp() {
                isResizing = false;
                panelResizer.classList.remove('dragging');
                document.body.style.cursor = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    }
    
    // Preview resizer
    const previewResizer = document.getElementById('rs-preview');
    const previewWrap = document.getElementById('preview-wrap');
    
    if (previewResizer && previewWrap) {
        let isResizing = false;
        
        previewResizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            previewResizer.classList.add('dragging');
            document.body.style.cursor = 'col-resize';
            
            const startX = e.clientX;
            const startWidth = previewWrap.offsetWidth;
            
            function onMouseMove(e) {
                if (!isResizing) return;
                
                const deltaX = startX - e.clientX;
                let newWidth = startWidth + deltaX;
                
                // Constrain width
                newWidth = Math.max(300, Math.min(window.innerWidth - 400, newWidth));
                
                previewWrap.style.width = newWidth + 'px';
            }
            
            function onMouseUp() {
                isResizing = false;
                previewResizer.classList.remove('dragging');
                document.body.style.cursor = '';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    }
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Don't trigger if typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }
        
        const ctrl = e.ctrlKey || e.metaKey;
        const shift = e.shiftKey;
        const alt = e.altKey;
        
        // File operations
        if (ctrl && e.key === 'n') {
            e.preventDefault();
            FileSystem.createFilePrompt();
        }
        
        if (ctrl && e.key === 's') {
            e.preventDefault();
            FileSystem.save(true);
        }
        
        if (ctrl && shift && e.key === 'S') {
            e.preventDefault();
            FileSystem.exportZip();
        }
        
        // Edit operations
        if (ctrl && e.key === 'z') {
            e.preventDefault();
            FileSystem.undo();
        }
        
        if (ctrl && shift && e.key === 'Z') {
            e.preventDefault();
            FileSystem.redo();
        }
        
        if (ctrl && e.key === 'f') {
            e.preventDefault();
            EditorManager.findText('');
        }
        
        if (ctrl && shift && e.key === 'f') {
            e.preventDefault();
            Search.findInProject();
        }
        
        if (ctrl && e.key === 'h') {
            e.preventDefault();
            Search.replace();
        }
        
        // View operations
        if (ctrl && e.key === 'p') {
            e.preventDefault();
            CommandPalette.show();
        }
        
        if (ctrl && e.key === 'b') {
            e.preventDefault();
            LayoutManager.toggleLayout('preview');
        }
        
        if (ctrl && e.key === '`') {
            e.preventDefault();
            LayoutManager.toggleLayout('terminal');
        }
        
        if (ctrl && e.key === '\\') {
            e.preventDefault();
            LayoutManager.splitEditor();
        }
        
        if (ctrl && e.key === '=') {
            e.preventDefault();
            EditorManager.zoomIn();
        }
        
        if (ctrl && e.key === '-') {
            e.preventDefault();
            EditorManager.zoomOut();
        }
        
        if (ctrl && e.key === '0') {
            e.preventDefault();
            EditorManager.resetZoom();
        }
        
        // Run/debug
        if (e.key === 'F5') {
            e.preventDefault();
            Runner.exec();
        }
        
        if (e.key === 'F9') {
            e.preventDefault();
            Debugger.toggle();
        }
        
        if (shift && e.key === 'F5') {
            e.preventDefault();
            Runner.reload();
        }
        
        // AI assistant
        if (ctrl && shift && e.key === 'A') {
            e.preventDefault();
            AI.toggle();
        }
        
        // Toggle panels
        if (ctrl && e.key === 'j') {
            e.preventDefault();
            Panel.toggle();
        }
        
        // Format code
        if (ctrl && shift && e.key === 'F') {
            e.preventDefault();
            EditorManager.formatCode();
        }
        
        // Quick navigation
        if (ctrl && e.key === 'g') {
            e.preventDefault();
            const line = prompt('Go to line:', '1');
            if (line) {
                EditorManager.goToLine(parseInt(line));
            }
        }
        
        // Find symbol
        if (ctrl && shift && e.key === 'O') {
            e.preventDefault();
            FileSystem.updateOutline();
        }
    });
}

// ============================================
// EXPORT GLOBAL FUNCTIONS FOR HTML ONCLICK
// ============================================
window.FS = FileSystem;
window.EditorManager = EditorManager;
window.TabManager = TabManager;
window.TerminalManager = TerminalManager;
window.Runner = Runner;
window.Debugger = Debugger;
window.Panel = Panel;
window.AI = AI;
window.ProjectTemplates = ProjectTemplates;
window.Git = Git;
window.Search = Search;
window.LayoutManager = LayoutManager;
window.Layout = LayoutManager;
window.Settings = Settings;
window.CommandPalette = CommandPalette;
window.Tutorial = Tutorial;
window.Notifications = Notifications;
window.Utils = Utils;
window.IDE = IDE;

// Initialize on window load
window.addEventListener('DOMContentLoaded', () => {
    // Set initial cursor position
    document.getElementById('cursor-pos').textContent = 'Ln 1, Col 1';
    document.getElementById('file-lang').textContent = 'Plain Text';
    document.getElementById('file-enc').textContent = 'UTF-8';
    document.getElementById('file-size').textContent = '0 B';
    document.getElementById('line-endings').textContent = 'LF';
    document.getElementById('git-status-text').textContent = 'Local clean';
    document.getElementById('status-indicator').className = 'status-dot';
});

// Service Worker registration for offline capability
if ('serviceWorker' in navigator && location.protocol !== 'file:') {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('ServiceWorker registered:', registration);
        }).catch(error => {
            console.log('ServiceWorker registration failed:', error);
        });
    });
}

// Online/offline detection
window.addEventListener('online', () => {
    document.getElementById('status-indicator').className = 'status-dot';
    Utils.toast('Back online', 'success');
});

window.addEventListener('offline', () => {
    document.getElementById('status-indicator').className = 'status-dot offline';
    Utils.toast('Working offline', 'warning');
});
</script>
</body>
</html>
